<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fchat Users</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #fff; color: #000; }

#loading-screen { display: flex; flex-direction: column; justify-content: center; align-items: center;
  height: 100vh; font-size: 18px; font-weight: bold; color: #000; }

#loading-logs { margin-top: 10px; font-size: 14px; color: #555; max-width: 80%; text-align: center; }

#interface { display: none; padding: 20px; }

#search-container { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
#searchInput { flex: 1; padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #aaa; }
#searchBtn { padding: 10px 15px; font-size: 16px; border-radius: 6px; border: 1px solid #000;
  background: #fff; color:#000; cursor:pointer; }

#update-log { font-size: 12px; color:#555; margin-bottom: 10px; }

#results { display: flex; flex-direction: column; gap: 10px; }

/* CARD LAYOUT */
.card {
  display: flex;
  align-items: center;
  padding: 10px;
  border-radius: 10px;
  background: #f5f5f5;
  width: 100%;
}

/* PFP LEFT */
.pfp {
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background:#000;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:20px;
  font-weight:bold;
  object-fit:cover;
  cursor:pointer;
  overflow:hidden;
}

/* INFO MIDDLE */
.info {
  flex: 1;
  margin-left: 12px;
}
.name { font-size: 16px; font-weight: bold; }
.status { font-size: 12px; color:#555; margin-top:3px; }

/* ADD BUTTON RIGHT */
.add-btn {
  background:#000;
  color:#fff;
  border:none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 10px;
}

.not-found { text-align:center; margin-top:10px; font-size:14px; color:#555; }

/* PROFILE MODAL */
#profile-modal {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:100;
}
#profile-modal img {
  width: 80%;
  max-width: 400px;
  border-radius: 50%;
}
/* FIX: make profile pics visible immediately */
.pfp img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div>Loading...</div>
  <div id="loading-logs">Starting...</div>
</div>

<!-- MAIN UI -->
<div id="interface">
  <div id="search-container">
    <input id="searchInput" placeholder="Search username or ID..." />
    <button id="searchBtn">Search</button>
  </div>

  <div id="update-log">Initializing...</div>
  <div id="results"></div>
</div>

<!-- PROFILE MODAL -->
<div id="profile-modal"><img id="profileView"></div>

<script>
const API = "https://fweb-backend.onrender.com/fchat";

let combined = [];
let displayedIds = new Set();
let verifiedIds = []; // Will be used to HIDE verified users

const resultsEl = document.getElementById("results");

/* ------------------ API HELPER ------------------ */
async function api(action, extra={}) {
  const acc = JSON.parse(localStorage.getItem("faccount")) || {};
  const body = { action, ...extra, email: acc.email, password_hash: acc.password_hash, my_id: acc.id };

  try {
    const r = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    return r.json();
  } catch (e) {
    console.log("API error:", e);
    return { data: [] };
  }
}

/* ------------------ RENDER CARD ------------------ */
function renderCard(u) {
  if (verifiedIds.includes(u.id)) return;  // ❗REMOVE VERIFIED USERS COMPLETELY

  if (displayedIds.has(u.id)) return;
  displayedIds.add(u.id);

  const card = document.createElement("div");
  card.className = "card";

  // PROFILE PIC
  const pfp = document.createElement("div");
  pfp.className = "pfp";

  if (u.profile_pic) {
    const img = document.createElement("img");
    img.src = u.profile_pic;
    pfp.appendChild(img);
    pfp.onclick = () => {
      document.getElementById("profile-modal").style.display = "flex";
      document.getElementById("profileView").src = u.profile_pic;
    }
  } else {
    pfp.textContent = (u.username || "U").charAt(0).toUpperCase();
  }

  // INFO (middle)
  const info = document.createElement("div");
  info.className = "info";
  info.innerHTML = `
    <div class="name">${u.username}</div>
    <div class="status">${
      u.fchat === "yes"
        ? (u.status_text || "Active on Fchat")
        : "Not on Fchat"
    }</div>
  `;

// ADD BUTTON
let addBtn = document.createElement("button");
addBtn.className = "add-btn";

// ❗ HIDE ADD BUTTON FOR NON-FCHAT USERS
if (u.fchat !== "yes") {
    addBtn.style.display = "none";
} else {
    // Normal logic for Fchat users
    if (u.friend_requests && u.friend_requests.includes(u.my_id)) {
        addBtn.textContent = "Sent";
        addBtn.disabled = true;
    } else {
        addBtn.textContent = "Add";
        addBtn.onclick = async () => {
            await api("add_user", { invite_id: u.id });
            addBtn.textContent = "Sent";
            addBtn.disabled = true;
        };
    }
}

  if (u.friend_requests && u.friend_requests.includes(u.my_id)) {
    addBtn.textContent = "Sent";
    addBtn.disabled = true;
  } else {
    addBtn.textContent = "Add";
    addBtn.onclick = async () => {
      await api("add_user", { invite_id: u.id });
      addBtn.textContent = "Sent";
      addBtn.disabled = true;
    };
  }

  card.appendChild(pfp);
  card.appendChild(info);
  card.appendChild(addBtn);

  resultsEl.appendChild(card);
}

/* ------------------ FETCH USERS ------------------ */
async function fetchAllUsers() {
  const res = await api("get_all_users");
  const users = res.data || [];

  const seen = new Set(combined.map(u => u.id));
  users.forEach(u => {
    if (!seen.has(u.id)) combined.push(u);
  });
}

/* ------------------ VERIFY USERS (to hide them) ------------------ */
async function verifyUsers() {
  const res = await api("verify_users");
  verifiedIds = res.data || [];
}

/* ------------------ SEARCH ------------------ */
document.getElementById("searchBtn").onclick = () => {
  const q = document.getElementById("searchInput").value.toLowerCase().trim();

  displayedIds.clear();
  resultsEl.innerHTML = "";

  const filtered = combined.filter(u =>
    (u.username && u.username.toLowerCase().includes(q)) ||
    String(u.id).includes(q)
  );

  if (filtered.length === 0) {
    const nf = document.createElement("div");
    nf.className = "not-found";
    nf.textContent = "Not found";
    resultsEl.appendChild(nf);
  } else {
    filtered.forEach(renderCard);
  }
};

/* ------------------ PROFILE MODAL CLOSE ------------------ */
document.getElementById("profile-modal").onclick = () => {
  document.getElementById("profile-modal").style.display = "none";
};

/* ------------------ LOADING SCREEN ------------------ */
const logSteps = [
  "Starting...",
  "Connecting to server...",
  "Syncing accounts...",
  "Loading data...",
  "Finalizing..."
];
let step = 0;
const logs = document.getElementById("loading-logs");
const interval = setInterval(() => {
  logs.textContent = logSteps[step % logSteps.length];
  step++;
}, 800);

/* ------------------ INITIALIZE ------------------ */
(async () => {
  await verifyUsers();     // Get verified list (to hide them)
  await fetchAllUsers();   // Load users

  clearInterval(interval);

  document.getElementById("loading-screen").style.display = "none";
  document.getElementById("interface").style.display = "block";

  // Render only broadcasted users on page load
  displayedIds.clear();
  resultsEl.innerHTML = "";
  combined
    .filter(u => u.broadcast === "yes") // Only broadcasted
    .forEach(renderCard);

  // Keep updating every 5 seconds
  setInterval(fetchAllUsers, 5000);
})();
</script>

</body>
</html>
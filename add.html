<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Add Friends</title>
<style>
  body { margin:0; font-family:'Poppins',sans-serif; background:#0d1117; color:#fff; display:flex; flex-direction:column; min-height:100vh; }
  header { background:#161b22; padding:15px; text-align:center; font-size:20px; font-weight:bold; border-bottom:1px solid #30363d; color:#00c6ff; letter-spacing:1px; position:relative;}
  .reload-btn { position:absolute; top:15px; right:15px; background:#238636; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; color:#fff; font-weight:500; }
  .search-box { padding:15px; }
  input[type="text"] { width:100%; padding:12px; border-radius:10px; border:none; outline:none; font-size:16px; background:#21262d; color:#fff; }
  .results { flex:1; padding:10px; overflow-y:auto; }
  .card { display:flex; justify-content:space-between; align-items:center; background:#161b22; margin:10px 0; padding:15px; border-radius:10px; border:1px solid #30363d; transition: background 0.3s ease; }
  .card:hover { background:#1e242b; }
  .card span { font-weight:500; font-size:16px; }
  .card .pending { color:#facc15; font-size:14px; }
  .card button { background:#238636; border:none; color:#fff; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:500; transition:background 0.3s; }
  .card button:hover { background:#2ea043; }
  .card button:disabled { background:#444; cursor:not-allowed; }
  .status { text-align:center; padding:20px; color:#999; }
  .bottom { background:#161b22; padding:15px; text-align:center; border-top:1px solid #30363d; }
  .bottom button { width:100%; background:#238636; border:none; color:white; padding:12px; border-radius:10px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>
<header>
  Add Friends
  <button class="reload-btn" id="reloadBtn">Reload</button>
</header>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search username..." />
</div>

<div id="resultsContainer" class="results"></div>

<div class="bottom">
  <button onclick="window.location.href='fchat.html'">Back</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://pwsxezhugsxosbwhkdvf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ"
);

const searchInput = document.getElementById("searchInput");
const resultsContainer = document.getElementById("resultsContainer");
const reloadBtn = document.getElementById("reloadBtn");

// Load logged-in account from device storage
let faccount = null;
let dirHandle = null;
async function loadLocalAccount() {
  try {
    dirHandle = await window.showDirectoryPicker();
    const fileHandle = await dirHandle.getFileHandle('fweb_account.json');
    const file = await fileHandle.getFile();
    faccount = JSON.parse(await file.text());
  } catch(e) {
    alert("Could not load account from storage.");
  }
}

// Helper to write back to storage
async function writeLocalAccount() {
  if (!dirHandle || !faccount) return;
  const fileHandle = await dirHandle.getFileHandle('fweb_account.json', { create:true });
  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(faccount));
  await writable.close();
}

// Show users as cards
function displayUsers(users) {
  resultsContainer.innerHTML = users.length === 0 
    ? `<div class="status">No users to show</div>`
    : users.map(u => {
        const alreadyAdded = faccount.accepted?.includes(String(u.id));
        return `
          <div class="card">
            <span>${u.username}</span>
            ${
              alreadyAdded
                ? `<button disabled>Added ✓</button>`
                : `<button onclick="sendRequest('${u.id}','${u.username}')">Add</button>`
            }
          </div>`;
      }).join('');
}

// Load accepted users from storage first
async function loadAcceptedUsers() {
  if (!faccount?.accepted || faccount.accepted.length===0) return [];
  const acceptedIds = faccount.accepted.map(String);
  const { data, error } = await supabase
    .from('fwebaccount')
    .select('id,username')
    .in('id', acceptedIds);

  if (error || !data) return [];
  return data;
}

// Load broadcast users and merge with storage
async function loadAllUsers() {
  resultsContainer.innerHTML = `<div class="status">Loading...</div>`;
  let users = await loadAcceptedUsers();
  const shownIds = users.map(u => u.id);

  const { data: allUsers } = await supabase
    .from('fwebaccount')
    .select('id,username,friend_requests,fchat')
    .eq('fchat','yes');

  if (allUsers) {
    for (const u of allUsers) {
      if (u.id !== faccount.id && !shownIds.includes(u.id)) {
        users.push(u);
      }
    }
  }
  displayUsers(users);
}

// Search users
let typingTimer;
const delay = 400;
searchInput.addEventListener("input", () => {
  clearTimeout(typingTimer);
  const query = searchInput.value.trim();
  if (query==="") { loadAllUsers(); return; }
  typingTimer = setTimeout(()=>searchUsers(query), delay);
});

async function searchUsers(query) {
  const { data, error } = await supabase
    .from('fwebaccount')
    .select('id,username,friend_requests,fchat')
    .ilike('username', `%${query}%`);

  if (error || !data) { resultsContainer.innerHTML=`<div class="status">Error</div>`; return; }

  const filtered = data.filter(u => u.id!==faccount.id);
  displayUsers(filtered);
}

// Send friend request
window.sendRequest = async (targetId,targetName) => {
  if (!faccount) return;
  // Fetch target's friend_requests
  const { data: target } = await supabase
    .from('fwebaccount')
    .select('friend_requests')
    .eq('id', targetId)
    .maybeSingle();

  let requests = target.friend_requests ? target.friend_requests.split(',').map(s=>s.trim()) : [];
  if (!requests.includes(String(faccount.id))) requests.push(String(faccount.id));

  // Update target in supabase
  await supabase.from('fwebaccount').update({friend_requests:requests.join(',')}).eq('id',targetId);

  // Update local storage accepted
  faccount.accepted = faccount.accepted || [];
  if (!faccount.accepted.includes(String(targetId))) faccount.accepted.push(String(targetId));

  await writeLocalAccount();
  loadAllUsers();
  alert(`✅ Added ${targetName}`);
};

// Reload button
reloadBtn.addEventListener('click', async ()=>{
  await loadLocalAccount();
  loadAllUsers();
});

// Initial load
(async()=>{
  await loadLocalAccount();
  loadAllUsers();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FCHAT Search</title>
<style>
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #0d1117;
    color: #fff;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #161b22;
    padding: 15px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    border-bottom: 1px solid #30363d;
    color: #00c6ff;
    letter-spacing: 1px;
  }
  .search-box {
    padding: 15px;
  }
  input[type="text"] {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    outline: none;
    font-size: 16px;
    background: #21262d;
    color: #fff;
  }
  .results {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }
  .card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #161b22;
    margin: 10px 0;
    padding: 12px 15px;
    border-radius: 10px;
    border: 1px solid #30363d;
    transition: all 0.2s ease;
  }
  .card:hover { background: #1e242b; }
  .card .username {
    font-weight: 600;
    font-size: 16px;
  }
  .card img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
    border: 1px solid #444;
  }
  .card button {
    background: #238636;
    border: none;
    color: #fff;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
  }
  .card button:hover { background: #2ea043; }
  .card button:disabled {
    background: #444;
    cursor: not-allowed;
  }
  .log {
    text-align: center;
    font-size: 14px;
    color: #00c6ff;
    padding: 6px 0;
    border-top: 1px solid #30363d;
    background: #161b22;
  }
  .bottom {
    background: #161b22;
    padding: 15px;
    text-align: center;
    border-top: 1px solid #30363d;
  }
  .bottom button {
    width: 100%;
    background: #238636;
    border: none;
    color: white;
    padding: 12px;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>
<header>FCHAT Search</header>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search username..." />
</div>

<div id="results" class="results"></div>
<div id="logArea" class="log"></div>

<div class="bottom">
  <button onclick="window.location.href='fchat.html'">Back</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://pwsxezhugsxosbwhkdvf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ"
);

const searchInput = document.getElementById("searchInput");
const resultsContainer = document.getElementById("results");
const logArea = document.getElementById("logArea");

// Load logged-in user from local storage
let faccount = JSON.parse(localStorage.getItem("faccount"));
if(!faccount || !faccount.id){
  alert("No account found. Please log in first.");
}

// Keep track of shown user IDs to avoid duplicates
const shownIds = new Set();

// Render cards
function renderCards(users){
  users.forEach(u=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div style="display:flex;align-items:center">
        <img src="${u.profile_pic || 'https://via.placeholder.com/40'}" alt="Profile">
        <div class="username">${u.username}</div>
      </div>
      <button ${u.alreadyAdded?'disabled':''}>${u.alreadyAdded?'Added âœ“':'Add'}</button>
    `;
    const btn = card.querySelector("button");
    if(!u.alreadyAdded){
      btn.addEventListener("click", ()=>sendRequest(u));
    }
    resultsContainer.appendChild(card);
  });
}

// Send friend request
async function sendRequest(user){
  try{
    const nowUTC = new Date().toISOString();
    // Get target's current friend_requests
    const { data: target, error } = await supabase
      .from("fwebaccount")
      .select("friend_requests,accepted")
      .eq("id", user.id)
      .maybeSingle();
    if(error || !target) return logArea.textContent = "Error sending request";

    let requests = target.friend_requests ? target.friend_requests.split(",").map(s=>s.trim()) : [];
    if(requests.includes(String(faccount.id))) return logArea.textContent = "Already sent";

    requests.push(String(faccount.id));
    // Update Supabase
    const { error: updateErr } = await supabase
      .from("fwebaccount")
      .update({ friend_requests: requests.join(","), sent_at: nowUTC })
      .eq("id", user.id);
    if(updateErr) return logArea.textContent = "Error sending request";

    // Add to accepted locally
    let localData = JSON.parse(localStorage.getItem("faccount")) || {};
    let accepted = localData.accepted ? localData.accepted.split(",").map(a=>a.trim()) : [];
    if(!accepted.includes(String(user.id))) accepted.push(String(user.id));
    localData.accepted = accepted.join(",");
    localStorage.setItem("faccount", JSON.stringify(localData));

    btn = user.buttonElement;
    if(btn) btn.disabled=true;
    logArea.textContent = `âœ… Request sent to ${user.username}`;

  }catch(e){
    console.error(e);
    logArea.textContent = "Error sending request";
  }
}

// Search users
let typingTimer;
const delay = 400;
searchInput.addEventListener("input", ()=>{
  clearTimeout(typingTimer);
  typingTimer = setTimeout(async ()=>{
    const query = searchInput.value.trim();
    resultsContainer.innerHTML = "";
    if(!query){
      logArea.textContent = "";
      return;
    }
    logArea.textContent = "ðŸ” Searching...";
    try{
      const { data, error } = await supabase
        .from("fwebaccount")
        .select("id,username,profile_pic,friend_requests")
        .ilike("username", `%${query}%`)
        .limit(20);
      if(error) throw error;
      if(!data || data.length===0){
        logArea.textContent = "No results found";
        return;
      }

      const localData = JSON.parse(localStorage.getItem("faccount")) || {};
      const acceptedList = localData.accepted ? localData.accepted.split(",").map(a=>a.trim()) : [];

      const users = data
        .filter(u => u.id != faccount.id)
        .map(u => ({
          ...u,
          alreadyAdded: acceptedList.includes(String(u.id))
        }));

      renderCards(users);
      logArea.textContent = "";
    }catch(err){
      console.error(err);
      logArea.textContent = "Error fetching results";
    }
  }, delay);
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fchat Users</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #fff; color: #000; }
#loading-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; font-size: 18px; font-weight: bold; color: #000; }
#loading-logs { margin-top: 10px; font-size: 14px; color: #555; max-width: 80%; text-align: center; }
#interface { display: none; padding: 20px; }
#search-container { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
#searchInput { flex: 1; padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #aaa; }
#searchBtn { padding: 10px 15px; font-size: 16px; border-radius: 6px; border: 1px solid #000; background: #fff; color: #000; cursor: pointer; }
#update-log { font-size: 12px; color: #555; margin-bottom: 10px; }
#results { display: flex; flex-direction: column; gap: 10px; }
.card { display: flex; align-items: center; padding: 10px; border-radius: 10px; background: #f5f5f5; }
.pfp { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:18px; cursor:pointer; background:#000; color:#fff; }
.pfp img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.info { margin-left: 10px; flex: 1; }
.name { font-weight: bold; font-size: 16px; }
.id { font-size: 12px; color: #333; }
.status { font-size: 12px; color: #555; }
.add-btn { padding: 6px 12px; background: #000; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; }
.snippet { font-size: 12px; color: #555; margin-top: 2px; }
#profile-modal { display:none; position:fixed; top:0; left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:100;}
#profile-modal img { width: 80%; max-width:400px; border-radius:50%; box-shadow:0 0 15px rgba(255,255,255,0.3);}
.not-found { font-size:14px; color:#555; text-align:center; margin-top:10px; }
</style>
</head>
<body>
<div id="loading-screen">
  <div>Loading...</div>
  <div id="loading-logs">Starting...</div>
</div>
<div id="interface">
  <div id="search-container">
    <input id="searchInput" placeholder="Search by username or ID..." />
    <button id="searchBtn">Search</button>
  </div>
  <div id="update-log">Initializing...</div>
  <div id="results"></div>
</div>
<div id="profile-modal"><img id="profileView"></div>
<script>
const API = "https://fweb-backend.onrender.com/fchat";
let combined = [];
let displayedIds = new Set();
let verifiedIds = []; // IDs returned from verify_users
const resultsEl = document.getElementById("results");

// Helper API call
async function api(action, extra={}) {
  const currentUser = JSON.parse(localStorage.getItem('faccount')) || {};
  const payload = { action, ...extra, email: currentUser.email, password_hash: currentUser.password_hash, my_id: currentUser.id };
  try {
    const res = await fetch(API, {
      method:"POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    return res.json();
  } catch(e){
    console.error("API error:", e);
    return { data: [] };
  }
}

// Render user card
function renderCard(u){
  if(displayedIds.has(u.id)) return;
  displayedIds.add(u.id);

  const card = document.createElement("div");
  card.className="card";

  const img = document.createElement("div");
  img.className="pfp";
  if(u.profile_pic){
    const image = document.createElement("img");
    image.src=u.profile_pic;
    img.appendChild(image);
    image.onclick = ()=>{
      const modal = document.getElementById("profile-modal");
      if(modal) {
        modal.style.display="flex";
        document.getElementById("profileView").src=u.profile_pic;
      }
    };
  } else {
    img.textContent = u.username ? u.username.charAt(0).toUpperCase() : "U";
  }

  const info = document.createElement("div");
  info.className="info";
  info.innerHTML = `
    <div class="name">${u.username}</div>
    <div class="id">ID: ${u.id}</div>
    <div class="status">${u.fchat==="yes"? (u.status_text||"In FCHAT") : "User not in FCHAT"}</div>
  `;

  const addBtn = document.createElement("button");
  addBtn.className="add-btn";
  addBtn.textContent="Add";

  const snippet = document.createElement("div");
  snippet.className="snippet";
  snippet.textContent=`Check Users: ${u.check_users || ''}`;

  // Fzone / friend requests logic
  if(verifiedIds.includes(u.id)) {
    snippet.textContent = "Already in your Fzone";
    addBtn.style.display = "none";
  } else if(u.friend_requests && u.friend_requests.includes(u.id)) {
    addBtn.textContent = "Sent";
    addBtn.disabled = true;
  } else {
    addBtn.onclick = async () => {
      await api("add_user",{ invite_id: u.id });
      addBtn.textContent="Sent";
      addBtn.disabled=true;
    };
  }

  card.appendChild(img);
  card.appendChild(info);
  card.appendChild(addBtn);
  card.appendChild(snippet);
  resultsEl.appendChild(card);
}

// Fetch all users
async function fetchAllUsers() {
  const res = await api("get_all_users");
  const users = res.data || [];
  const seen = new Set(combined.map(u => u.id));
  users.forEach(u=>{
    if(!seen.has(u.id)) combined.push(u);
  });
}

// Verify users
async function verifyUsers() {
  try {
    const res = await api("verify_users");
    verifiedIds = res.data || [];
  } catch(e){
    console.error("Verify users failed:", e);
    verifiedIds = [];
  }
}

// Search
document.getElementById("searchBtn").addEventListener("click",()=>{
  const q = document.getElementById("searchInput").value.toLowerCase().trim();
  resultsEl.innerHTML="";
  displayedIds.clear();
  const filtered = combined.filter(u => (u.username && u.username.toLowerCase().includes(q)) || String(u.id).includes(q));
  if(filtered.length===0){
    const nf = document.createElement("div");
    nf.className="not-found";
    nf.textContent = "Not found";
    resultsEl.appendChild(nf);
  } else {
    filtered.forEach(u => renderCard(u));
  }
});

// Close modal
document.getElementById("profile-modal").addEventListener("click",()=>{
  document.getElementById("profile-modal").style.display="none";
});

// Loading screen logs
const logSteps = ["Starting...", "Accessing backend...", "Connecting to database...", "Loading broadcast accounts...", "Preparing user data...", "Almost done..."];
let stepIndex=0;
const logsEl = document.getElementById("loading-logs");
const logInterval = setInterval(()=>{
  logsEl.textContent = logSteps[stepIndex % logSteps.length];
  stepIndex++;
}, 800);

// Initialize
(async ()=>{
  clearInterval(logInterval);
  logsEl.textContent = "Initializing...";
  try{
    await verifyUsers();
  } catch(e){}
  document.getElementById("loading-screen").style.display="none";
  document.getElementById("interface").style.display="block";
  await fetchAllUsers();
  setInterval(fetchAllUsers, 5000);
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FCHAT</title>
  <style>
    body {
      margin: 0;
      background: #fff;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      margin-bottom: 8px;
    }
    #logline {
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
      height: 18px;
    }
    #fchat-container {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .fchat-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f2f2f2;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      transition: 0.3s;
    }
    .fchat-card:hover {
      transform: scale(1.02);
      background: #eaeaea;
    }
    .fchat-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .profile-pic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #000;
    }
    .username {
      font-weight: bold;
      color: #000;
    }
  </style>
</head>
<body>
  <h1>FCHAT</h1>
  <p id="logline">Loading...</p>
  <div id="fchat-container">
    <p id="status">Fetching data...</p>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://pwsxezhugsxosbwhkdvf.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ"
    );

    const logLine = document.getElementById("logline");
    const container = document.getElementById("fchat-container");
    const status = document.getElementById("status");
    const log = msg => (logLine.textContent = msg);

    async function loadAcceptedChats(showLog = true) {
      const faccount = JSON.parse(localStorage.getItem("faccount"));
      if (!faccount || !faccount.id) {
        log("No account found âŒ");
        status.textContent = "Please log in first.";
        return;
      }

      if (showLog) log("Accessing Supabase...");
      const { data: user, error } = await supabase
        .from("fwebaccount")
        .select("*")
        .eq("id", faccount.id)
        .maybeSingle();

      if (error || !user) {
        log("Error retrieving user âŒ");
        status.textContent = "Error fetching user data.";
        return;
      }

      const acceptedIds = (user.accepted || "")
        .split(",")
        .map(a => a.trim())
        .filter(Boolean);

      if (acceptedIds.length === 0) {
        log("No accepted users.");
        container.innerHTML = "<p>No friends yet ðŸ˜¢</p>";
        return;
      }

      if (showLog) log(`Fetching ${acceptedIds.length} friends...`);
      const { data: friends, error: err } = await supabase
        .from("fwebaccount")
        .select("id, username, profile_pic")
        .in("id", acceptedIds);

      if (err || !friends?.length) {
        log("Error loading friends âŒ");
        return;
      }

      container.innerHTML = "";
      for (const friend of friends) {
        const card = document.createElement("div");
        card.className = "fchat-card";

        const left = document.createElement("div");
        left.className = "fchat-left";

        const img = document.createElement("img");
        img.src = friend.profile_pic || "default.png";
        img.className = "profile-pic";

        const name = document.createElement("div");
        name.className = "username";
        name.textContent = friend.username;

        left.appendChild(img);
        left.appendChild(name);
        card.appendChild(left);
        container.appendChild(card);
      }

      if (showLog) log(`Loaded ${friends.length} friend(s)`);
    }

    // Initial load
    loadAcceptedChats();

    // Every 2 seconds, check if localStorage updated
    setInterval(() => {
      const local = JSON.parse(localStorage.getItem("faccount"));
      log("Updating from local storage...");
      if (local?.updated === "yes") {
        log("Update found âœ…");
        setTimeout(() => {
          log("Updating page...");
          loadAcceptedChats(false).then(() => {
            local.updated = "no";
            localStorage.setItem("faccount", JSON.stringify(local));
            log("Page updated successfully âœ…");
          });
        }, 1000);
      }
    }, 2000);
  </script>
</body>
</html>

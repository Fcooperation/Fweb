<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTrainer</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
  h2 { color: #007bff; }
  .section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .columns { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
  .column { background: #f1f3f6; padding: 15px; border-radius: 6px; display: flex; flex-direction: column; min-width: 250px; position: relative; }
  .column input { margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  .remove-btn { position: absolute; top: 5px; right: 5px; background: #dc3545; color: #fff; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px; }
  button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
  .add-btn { background: #28a745; color: #fff; margin-bottom: 15px; }
  .send-btn { background: #007bff; color: #fff; }
  .send-btn:hover { background: #0056b3; }
  textarea { width: 100%; min-height: 120px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; resize: vertical; font-family: monospace; }
  input[type="file"], input[type="number"] { margin-top: 10px; }
  #preview { background: #272822; color: #f8f8f2; font-family: monospace; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; }
  #logs { margin-top: 15px; background: #f1f1f1; padding: 10px; border-radius: 6px; max-height: 250px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>FTrainer - Train Your Model</h2>

<!-- Section 1: Prompt/Response Columns -->
<div class="section">
  <h3>Prompt/Response Input</h3>
  <div id="columns-container" class="columns"></div>
  <button id="add-column" class="add-btn">‚ûï Add Prompt/Response</button>
</div>

<!-- Section 2: Raw JSON Input -->
<div class="section">
  <h3>Raw JSON Input</h3>
  <textarea id="raw-json" placeholder='{"prompt": "Hello", "response": "Hi there!"}'></textarea>
</div>

<!-- Section 3: File Upload -->
<div class="section">
  <h3>Upload JSON File</h3>
  <input type="file" id="file-upload" accept=".json,.txt">
</div>

<!-- Section 4: Max Epoch -->
<div class="section">
  <h3>Training Settings</h3>
  <label for="max-epoch">Max Epochs:</label>
  <input type="number" id="max-epoch" min="1" value="2">
</div>

<!-- Preview Section -->
<div class="section">
  <h3>Live JSON Preview</h3>
  <div id="preview">{}</div>
</div>

<button id="send-data" class="send-btn">üöÄ Start Training</button>
<div id="feedback"></div>

<!-- Logs Section -->
<div class="section">
  <h3>Training Logs</h3>
  <div id="logs">Logs will appear here...</div>
</div>

<script>
  const columnsContainer = document.getElementById("columns-container");
  const addColumnBtn = document.getElementById("add-column");
  const sendBtn = document.getElementById("send-data");
  const feedback = document.getElementById("feedback");
  const rawJson = document.getElementById("raw-json");
  const fileUpload = document.getElementById("file-upload");
  const preview = document.getElementById("preview");
  const logs = document.getElementById("logs");
  const maxEpochInput = document.getElementById("max-epoch");

  function log(message) {
    logs.innerText += "\n" + message;
    logs.scrollTop = logs.scrollHeight;
  }

  function createColumn(promptVal = "", responseVal = "") {
    const col = document.createElement("div");
    col.className = "column";
    const promptInput = document.createElement("input");
    promptInput.placeholder = "Prompt";
    promptInput.value = promptVal;
    const responseInput = document.createElement("input");
    responseInput.placeholder = "Response";
    responseInput.value = responseVal;
    const removeBtn = document.createElement("button");
    removeBtn.className = "remove-btn";
    removeBtn.innerText = "‚úñ";
    removeBtn.onclick = () => { col.remove(); updatePreview(); };
    col.append(removeBtn, promptInput, responseInput);
    columnsContainer.appendChild(col);
    updatePreview();
  }

  createColumn();
  addColumnBtn.onclick = () => createColumn();

  async function collectData() {
    let data = [];

    // From manual columns
    document.querySelectorAll(".column").forEach(col => {
      const prompt = col.children[1].value.trim();
      const response = col.children[2].value.trim();
      if (prompt && response) data.push({ prompt, response });
    });

    // From textarea
    if (rawJson.value.trim() !== "") {
      try {
        const parsed = JSON.parse(rawJson.value);
        if (Array.isArray(parsed)) data.push(...parsed);
        else if (parsed.prompt && parsed.response) data.push(parsed);
      } catch(e) {
        log("‚ö†Ô∏è Raw JSON parsing failed, skipping...");
      }
    }

    // From uploaded file
    if (fileUpload.files.length > 0) {
      const text = await fileUpload.files[0].text();
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) data.push(...parsed);
      } catch(e) {
        log("‚ö†Ô∏è Uploaded file invalid JSON, skipping...");
      }
    }

    return data;
  }

  async function updatePreview() {
    const data = await collectData();
    preview.innerText = JSON.stringify(data, null, 2);
  }

  fileUpload.addEventListener("change", async () => {
    log(`üìÇ File selected: ${fileUpload.files[0].name}`);
    await updatePreview();
  });
  rawJson.addEventListener("input", updatePreview);

  sendBtn.onclick = async () => {
    const data = await collectData();
    const maxEpoch = parseFloat(maxEpochInput.value);

    if (data.length === 0) {
      feedback.innerText = "‚ùå No valid data to send!";
      log("‚ùå No valid data to send!");
      return;
    }

    feedback.innerText = "‚è≥ Training started...";
    log(`üöÄ Starting training for max ${maxEpoch} epochs...`);

    let currentEpoch = 0;

    while (currentEpoch < maxEpoch) {
      try {
        log(`‚è≥ Epoch ${currentEpoch + 1} in progress...`);
        const res = await fetch("https://fweb-backend.onrender.com/train", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data })
        });
        const result = await res.json();

        if (result.success) {
          log(`‚úÖ Epoch ${currentEpoch + 1} complete: Loss logs -> ${JSON.stringify(result.result?.training_logs || [], null, 2)}`);
          currentEpoch++;
        } else {
          log("‚ùå Training error: " + (result.error || "Unknown error"));
          break;
        }
      } catch (err) {
        log("‚ùå Network error: " + err.message);
        break;
      }
    }

    if (currentEpoch >= maxEpoch) {
      feedback.innerText = "‚úÖ Training completed!";
      log("üéØ All epochs completed successfully.");
    }
  };
</script>
<script>
  // === Download Button + Chat Section ===
  const extraSection = document.createElement("div");
  extraSection.className = "section";
  extraSection.innerHTML = `
    <h3>After Training</h3>
    <button id="download-model" style="display:none; background:#17a2b8; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer;">‚¨áÔ∏è Download Model</button>
    <div id="chat-section" style="display:none; margin-top:15px;">
      <h4>üí¨ Test Trained Model</h4>
      <input id="chat-input" placeholder="Ask your trained model..." style="width:80%; padding:8px; border:1px solid #ccc; border-radius:4px;">
      <button id="chat-send" style="background:#007bff; color:white; padding:8px 12px; border:none; border-radius:4px;">Send</button>
      <div id="chat-output" style="background:#f1f1f1; margin-top:10px; padding:10px; border-radius:6px; min-height:50px;"></div>
    </div>
  `;
  document.body.appendChild(extraSection);

  const downloadBtn = document.getElementById("download-model");
  const chatSection = document.getElementById("chat-section");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  const chatOutput = document.getElementById("chat-output");

  // ‚úÖ Modify training fetch to show button after success
  const originalSend = sendBtn.onclick;
  sendBtn.onclick = async () => {
    const data = await collectData();
    if (data.length === 0) {
      feedback.innerText = "‚ùå No valid data to send!";
      log("‚ùå No valid data to send!");
      return;
    }

    const maxEpoch = prompt("Enter max epochs:", "3"); // Ask user for epoch count
    if (!maxEpoch || isNaN(maxEpoch)) {
      feedback.innerText = "‚ö†Ô∏è Invalid epoch number!";
      return;
    }

    feedback.innerText = "‚è≥ Sending data to train...";
    log("‚è≥ Sending data to backend for " + maxEpoch + " epochs...");

    try {
      let currentEpoch = 0;
      while (currentEpoch < maxEpoch) {
        log("‚öôÔ∏è Training epoch " + (currentEpoch + 1) + "...");
        const res = await fetch("https://mindy-sinistrous-fortuitously.ngrok-free.dev/train", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data, epoch: currentEpoch + 1 })
        });

        const result = await res.json();

        if (result.success) {
          feedback.innerText = "‚úÖ Epoch " + (currentEpoch + 1) + " completed!";
          log("‚úÖ Epoch " + (currentEpoch + 1) + " logs: " + JSON.stringify(result.result?.training_logs || [], null, 2));

          currentEpoch++;
          if (currentEpoch >= maxEpoch) {
            log("üéØ Reached max epoch: " + maxEpoch);
            feedback.innerText = "‚úÖ Training fully completed!";
            downloadBtn.style.display = "inline-block";
            chatSection.style.display = "block";
            break;
          }
        } else {
          log("‚ùå Training failed at epoch " + (currentEpoch + 1));
          break;
        }
      }
    } catch (err) {
      log("‚ùå Error during training: " + err.message);
    }
  };

  // üü¶ Handle Download
  downloadBtn.onclick = () => {
    log("‚¨áÔ∏è Downloading trained model checkpoint...");
    window.open("https://mindy-sinistrous-fortuitously.ngrok-free.dev/download_checkpoint", "_blank");
  };

  // üí¨ Chat tester
  chatSend.onclick = async () => {
    const promptText = chatInput.value.trim();
    if (!promptText) return;
    chatOutput.innerHTML += `<div><b>You:</b> ${promptText}</div>`;
    chatInput.value = "";
    try {
      const res = await fetch("https://mindy-sinistrous-fortuitously.ngrok-free.dev/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: promptText })
      });
      const result = await res.json();
      chatOutput.innerHTML += `<div><b>Model:</b> ${result.generated || "No response"}</div>`;
      chatOutput.scrollTop = chatOutput.scrollHeight;
    } catch (err) {
      chatOutput.innerHTML += `<div style="color:red;">Error: ${err.message}</div>`;
    }
  };
</script>
</body>
</html>

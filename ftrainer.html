<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTrainer Frontend</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #logs { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; background: #f9f9f9; }
  #downloadBtn { display: none; margin-top: 10px; padding: 8px 12px; background: #4caf50; color: white; text-decoration: none; border-radius: 4px; }
</style>
</head>
<body>
<h2>FTrainer</h2>

<input type="file" id="jsonFile" accept=".json"/>
<button id="trainBtn">Start Training</button>

<div id="logs"></div>
<a id="downloadBtn" href="">Download Trained Model</a>

<script>
const fileInput = document.getElementById("jsonFile");
const trainBtn = document.getElementById("trainBtn");
const logsDiv = document.getElementById("logs");
const downloadBtn = document.getElementById("downloadBtn");

// Replace with your Colab ngrok URL
const COLAB_URL = "YOUR_NGROK_URL";

trainBtn.onclick = () => {
  const file = fileInput.files[0];
  if (!file) return alert("Please select a JSON file first.");

  const reader = new FileReader();
  reader.onload = () => {
    let data;
    try {
      data = JSON.parse(reader.result);
    } catch(e) {
      return alert("Invalid JSON file.");
    }

    logsDiv.innerHTML = "<p>ðŸš€ Training started...</p>";
    downloadBtn.style.display = "none";

    // SSE connection for live logs
    const evtSource = new EventSource(`${COLAB_URL}/train_stream`);

    // Send JSON data via fetch separately to trigger training
    fetch(`${COLAB_URL}/train_stream`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data })
    }).catch(err => console.error(err));

    evtSource.onmessage = (e) => {
      if (e.data === "TRAINING_COMPLETE") {
        logsDiv.innerHTML += "<p>âœ… Training complete!</p>";
        downloadBtn.href = `${COLAB_URL}/download_checkpoint`;
        downloadBtn.style.display = "inline-block";
        evtSource.close();
        return;
      }
      logsDiv.innerHTML += `<p>${e.data}</p>`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
    };

    evtSource.onerror = (err) => {
      console.error("SSE Error:", err);
      evtSource.close();
    };
  };
  reader.readAsText(file);
};
</script>
</body>
</html>

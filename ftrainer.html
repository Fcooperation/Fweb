<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTrainer</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
  h2 { color: #007bff; }
  .section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .columns { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; transition: all 0.3s ease; }
  .column { background: #f1f3f6; padding: 15px; border-radius: 6px; display: flex; flex-direction: column; min-width: 250px; position: relative; transition: transform 0.2s ease; }
  .column input { margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  .column:hover { transform: scale(1.02); }
  .remove-btn { position: absolute; top: 5px; right: 5px; background: #dc3545; color: #fff; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px; }
  button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
  .add-btn { background: #28a745; color: #fff; margin-bottom: 15px; }
  .add-btn:hover { background: #1e7e34; }
  .send-btn { background: #007bff; color: #fff; }
  .send-btn:hover { background: #0056b3; }
  .test-btn { background: #6f42c1; color: #fff; }
  .test-btn:hover { background: #563d7c; }
  .download-btn { background: #17a2b8; color: #fff; margin-left: 10px; }
  .download-btn:hover { background: #117a8b; }
  textarea { width: 100%; min-height: 120px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; resize: vertical; font-family: monospace; }
  input[type="file"], select { margin-top: 10px; }
  #preview { background: #272822; color: #f8f8f2; font-family: monospace; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; }
  #feedback { margin-top: 15px; font-weight: bold; color: #333; }
  #logs { margin-top: 15px; background: #f1f1f1; padding: 10px; border-radius: 6px; max-height: 250px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
</style>
</head>
<body>
<h2>FTrainer - Train Your Model</h2>

<!-- Section 1: Prompt/Response Columns -->
<div class="section">
  <h3>Prompt/Response Input</h3>
  <div id="columns-container" class="columns"></div>
  <button id="add-column" class="add-btn">‚ûï Add Prompt/Response</button>
</div>

<!-- Section 2: Raw JSON Input -->
<div class="section">
  <h3>Raw JSON Input</h3>
  <textarea id="raw-json" placeholder='{"prompt": "repeat what you just said", "response": "repeat what you just said"}'></textarea>
</div>

<!-- Section 3: File Upload -->
<div class="section">
  <h3>Upload JSON File</h3>
  <input type="file" id="file-upload" accept=".json,.txt">
</div>

<!-- Section 4: Retrain Count -->
<div class="section">
  <h3>Retrain Options</h3>
  <label for="retrain-count">How many times to retrain:</label>
  <select id="retrain-count">
    <option value="1">1 time</option>
    <option value="2">2 times</option>
    <option value="3">3 times</option>
    <option value="5">5 times</option>
    <option value="10">10 times</option>
  </select>
</div>

<!-- Preview Section -->
<div class="section">
  <h3>Live JSON Preview</h3>
  <div id="preview">{}</div>
</div>

<button id="send-data" class="send-btn">üöÄ Send to Train</button>
<button id="download-model" class="download-btn" disabled>‚¨áÔ∏è Download Model</button>
<div id="feedback"></div>

<!-- Test Section -->
<div class="section">
  <h3>Test Trained Model</h3>
  <input type="text" id="test-prompt" placeholder="Enter test prompt..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;">
  <button id="test-btn" class="test-btn">üí¨ Test Model</button>
  <div id="test-result" style="margin-top:10px;font-weight:bold;"></div>
</div>

<!-- Logs Section -->
<div class="section">
  <h3>Logs</h3>
  <div id="logs">Logs will appear here...</div>
</div>

<script>
const columnsContainer = document.getElementById("columns-container");
const addColumnBtn = document.getElementById("add-column");
const sendBtn = document.getElementById("send-data");
const feedback = document.getElementById("feedback");
const rawJson = document.getElementById("raw-json");
const fileUpload = document.getElementById("file-upload");
const preview = document.getElementById("preview");
const logs = document.getElementById("logs");
const retrainCount = document.getElementById("retrain-count");
const downloadBtn = document.getElementById("download-model");
const testBtn = document.getElementById("test-btn");
const testPrompt = document.getElementById("test-prompt");
const testResult = document.getElementById("test-result");

function log(message) {
  logs.innerText += "\n" + message;
  logs.scrollTop = logs.scrollHeight;
}

function createColumn(promptVal = "", responseVal = "") {
  const col = document.createElement("div");
  col.className = "column";

  const promptInput = document.createElement("input");
  promptInput.placeholder = "Prompt";
  promptInput.value = promptVal;
  promptInput.oninput = updatePreview;

  const responseInput = document.createElement("input");
  responseInput.placeholder = "Response";
  responseInput.value = responseVal;
  responseInput.oninput = updatePreview;

  const removeBtn = document.createElement("button");
  removeBtn.className = "remove-btn";
  removeBtn.innerText = "‚úñ";
  removeBtn.onclick = () => { col.remove(); updatePreview(); };

  col.appendChild(removeBtn);
  col.appendChild(promptInput);
  col.appendChild(responseInput);
  columnsContainer.appendChild(col);

  updatePreview();
}

createColumn();
addColumnBtn.onclick = () => createColumn();

async function collectData() {
  let data = [];
  document.querySelectorAll(".column").forEach(col => {
    const prompt = col.children[1].value.trim();
    const response = col.children[2].value.trim();
    if (prompt && response) data.push({ prompt, response });
  });

  const raw = rawJson.value.trim();
  if (raw) {
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) data = data.concat(parsed);
      else if (parsed.prompt && parsed.response) data.push(parsed);
    } catch (e) { log("‚ö†Ô∏è Invalid JSON in Raw Input."); }
  }

  if (fileUpload.files.length > 0) {
    const file = fileUpload.files[0];
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      if (Array.isArray(parsed)) data = data.concat(parsed);
      else if (parsed.prompt && parsed.response) data.push(parsed);
    } catch (err) { log(`‚ùå Error reading file: ${err.message}`); }
  }

  return data;
}

async function updatePreview() {
  const data = await collectData();
  preview.innerText = JSON.stringify(data, null, 2);
}

sendBtn.onclick = async () => {
  const data = await collectData();
  if (data.length === 0) {
    feedback.innerText = "‚ùå No valid data to send!";
    return;
  }

  const times = parseInt(retrainCount.value);
  feedback.innerText = `‚è≥ Starting ${times} training cycle(s)...`;
  log(`‚è≥ Starting ${times} training cycles...`);

  for (let i = 1; i <= times; i++) {
    feedback.innerText = `üîÅ Training round ${i}/${times}...`;
    log(`üîÅ Training round ${i}/${times}...`);

    try {
      const res = await fetch("https://fweb-backend.onrender.com/train", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data })
      });

      const result = await res.json();
      if (result.success) {
        log(`‚úÖ Training round ${i} complete.`);
        if (i === times) {
          feedback.innerText = "‚úÖ All training rounds completed!";
          downloadBtn.disabled = false;
        }
      } else {
        log(`‚ùå Error in round ${i}: ${result.error}`);
      }
    } catch (err) {
      log(`‚ùå Network error during round ${i}: ${err.message}`);
      break;
    }
  }
};

downloadBtn.onclick = () => {
  const modelData = { trainedAt: new Date(), source: "FTrainer" };
  const blob = new Blob([JSON.stringify(modelData, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "ftrainer-model.json";
  link.click();
  log("‚¨áÔ∏è Model downloaded to device.");
};

testBtn.onclick = async () => {
  const prompt = testPrompt.value.trim();
  if (!prompt) return testResult.innerText = "‚ö†Ô∏è Please enter a test prompt.";
  testResult.innerText = "‚è≥ Testing...";
  log(`üí¨ Sending test prompt: "${prompt}"`);

  try {
    const res = await fetch("https://fweb-backend.onrender.com/test", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const result = await res.json();
    testResult.innerText = `üß† Response: ${result.response || "No response"}`;
    log(`üß† Model replied: ${result.response}`);
  } catch (err) {
    testResult.innerText = "‚ùå Error testing model.";
    log(`‚ùå Error testing: ${err.message}`);
  }
};

rawJson.addEventListener("input", updatePreview);
fileUpload.addEventListener("change", updatePreview);
</script>
</body>
</html>

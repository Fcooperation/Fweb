<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FCOOPERATION Trainer</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 20px;
      text-align: center;
      background: rgba(0,0,0,0.4);
    }
    header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: #00ffcc;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      background: #00ffcc;
      color: #000;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #00ccaa;
    }
    #logs {
      margin-top: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.4);
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>FCOOPERATION Trainer</h1>
    <p>Train your AI models easily</p>
  </header>
  <div class="container">
    <form id="trainerForm">
      <label for="dataset">Upload Dataset</label>
      <input type="file" id="dataset" name="dataset" required>

      <label for="parameters">Parameters</label>
      <select id="parameters" name="parameters">
        <option value="200m">200M</option>
        <option value="500m">500M</option>
        <option value="1b">1B</option>
        <option value="2b">2B</option>
      </select>

      <label for="gpu">GPU Type</label>
      <select id="gpu" name="gpu">
        <option value="t4">NVIDIA T4</option>
        <option value="v100">NVIDIA V100</option>
        <option value="a100">NVIDIA A100</option>
      </select>

      <label for="storage">Save Model To</label>
      <select id="storage" name="storage">
        <option value="drive">Google Drive</option>
        <option value="local">Colab Storage</option>
      </select>

      <div class="row">
        <button type="submit">Start Training</button>
        <input type="number" id="iterations" name="iterations" min="1" max="100" value="1" title="Number of training runs">
      </div>
    </form>

    <div id="logs">Logs will appear here...</div>
  </div>

  <script>
    const form = document.getElementById("trainerForm");
    const logsBox = document.getElementById("logs");
    let sessionId = null;
    let pollInterval = null;

    const BASE_URL = "https://mindy-sinistrous-fortuitously.ngrok-free.dev";

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearInterval(pollInterval);
      logsBox.innerText = "‚è≥ Reading dataset...";

      const fileInput = document.getElementById("dataset");
      const iterations = parseInt(document.getElementById("iterations").value) || 1;

      if (!fileInput.files[0]) return alert("Please upload a dataset!");

      const reader = new FileReader();
      reader.onload = async function() {
        const datasetArray = reader.result.split(/\r?\n/).filter(l => l.trim() !== "");
        const payload = { dataset: datasetArray };

        logsBox.innerText = "‚è≥ Sending training request...";

        for (let i = 1; i <= iterations; i++) {
          logsBox.innerText += `\n‚û°Ô∏è Starting training run ${i} of ${iterations}...\n`;
          try {
            const res = await fetch(`${BASE_URL}/train`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.success || !data.session_id) {
              logsBox.innerText += `‚ùå Failed to start training run ${i}:\n` + JSON.stringify(data, null, 2) + "\n";
              continue;
            }

            sessionId = data.session_id;

            await new Promise((resolve) => {
              pollInterval = setInterval(async () => {
                try {
                  const logRes = await fetch(`${BASE_URL}/logs/${sessionId}`);
                  const logData = await logRes.json();

                  if (logData.logs) {
                    // Append new logs instead of replacing
                    logsBox.innerText += logData.logs.replace(/\n$/, '') + "\n";
                    logsBox.scrollTop = logsBox.scrollHeight;
                  }

                  if (logData.completed) {
                    clearInterval(pollInterval);
                    logsBox.innerText += `‚úÖ Training run ${i} completed!\n`;
                    resolve();
                  }
                } catch (err) {
                  logsBox.innerText += "\n‚ùå Error fetching logs: " + err.message + "\n";
                  resolve();
                }
              }, 1000);
            });

          } catch (err) {
            logsBox.innerText += "‚ùå Error: " + err.message + "\n";
          }
        }

        logsBox.innerText += "\nüèÅ All training runs finished!";
      };

      reader.readAsText(fileInput.files[0]);
    });
  </script>
</body>
</html>

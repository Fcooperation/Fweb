<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTrainer Frontend</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #logs { white-space: pre-line; background: #f0f0f0; padding: 10px; height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-top: 10px; }
  #downloadBtn { display: none; margin-top: 10px; padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; }
</style>
</head>
<body>

<h1>FTrainer</h1>

<input type="file" id="jsonFile" accept=".json" />
<button id="trainBtn">Start Training</button>

<div id="logs"></div>
<button id="downloadBtn">Download Trained Model</button>

<script>
const trainBtn = document.getElementById("trainBtn");
const jsonFile = document.getElementById("jsonFile");
const logsDiv = document.getElementById("logs");
const downloadBtn = document.getElementById("downloadBtn");

const BACKEND_URL = "https://fweb-backend.onrender.com"; // replace with your Render backend URL

trainBtn.addEventListener("click", () => {
  if (!jsonFile.files[0]) {
    alert("Please select a JSON file!");
    return;
  }

  const reader = new FileReader();
  reader.onload = async (e) => {
    let jsonData;
    try {
      jsonData = JSON.parse(e.target.result);
    } catch (err) {
      alert("Invalid JSON file.");
      return;
    }

    logsDiv.textContent = "ðŸš€ Starting training...\n";

    // Use EventSource polyfill for SSE via fetch + ReadableStream
    try {
      const res = await fetch(`${BACKEND_URL}/train`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(jsonData)
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        chunk.split("\n\n").forEach(line => {
          if (line.startsWith("data:")) {
            const msg = line.replace("data: ", "").trim();
            logsDiv.textContent += msg + "\n";
            logsDiv.scrollTop = logsDiv.scrollHeight;

            if (msg === "TRAINING_COMPLETE") {
              downloadBtn.style.display = "inline-block";
            }
          }
        });
      }
    } catch (err) {
      logsDiv.textContent += "\nâŒ Error: " + err.message;
    }
  };

  reader.readAsText(jsonFile.files[0]);
});

downloadBtn.addEventListener("click", () => {
  window.open(`${BACKEND_URL}/download_checkpoint`, "_blank");
});
</script>

</body>
</html>

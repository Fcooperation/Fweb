<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTrainer</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
  h2 { color: #007bff; }
  .section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .columns { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; transition: all 0.3s ease; }
  .column { background: #f1f3f6; padding: 15px; border-radius: 6px; display: flex; flex-direction: column; min-width: 250px; position: relative; transition: transform 0.2s ease; }
  .column input { margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  .column:hover { transform: scale(1.02); }
  .remove-btn { position: absolute; top: 5px; right: 5px; background: #dc3545; color: #fff; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px; }
  button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
  .add-btn { background: #28a745; color: #fff; margin-bottom: 15px; }
  .add-btn:hover { background: #1e7e34; }
  .send-btn { background: #007bff; color: #fff; }
  .send-btn:hover { background: #0056b3; }
  textarea { width: 100%; min-height: 120px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; resize: vertical; font-family: monospace; }
  input[type="file"] { margin-top: 10px; }
  #preview { background: #272822; color: #f8f8f2; font-family: monospace; padding: 15px; border-radius: 6px; max-height: 300px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; }
  #feedback { margin-top: 15px; font-weight: bold; color: #333; }
  #logs { margin-top: 15px; background: #f1f1f1; padding: 10px; border-radius: 6px; max-height: 250px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
  .epoch-control { margin-top: 10px; }
</style>
</head>
<body>

<h2>FTrainer - Train Your Model</h2>

<!-- Mode Selection -->
<div class="section">
  <h3>Training Mode</h3>
  <label><input type="radio" name="mode" value="manual" checked> Manual Q&A Only</label><br>
  <label><input type="radio" name="mode" value="upload"> Upload File Only</label><br>
  <label><input type="radio" name="mode" value="both"> Both (Combine Upload + Manual)</label>
</div>

<!-- Section 1: Prompt/Response Columns -->
<div class="section" id="manual-section">
  <h3>Prompt/Response Input</h3>
  <div id="columns-container" class="columns"></div>
  <button id="add-column" class="add-btn">➕ Add Prompt/Response</button>
</div>

<!-- Section 2: File Upload -->
<div class="section" id="upload-section">
  <h3>Upload JSON File</h3>
  <input type="file" id="file-upload" accept=".json,.txt">
</div>

<!-- Epoch Control -->
<div class="section">
  <h3>Training Settings</h3>
  <label for="epochs">Max Epochs:</label>
  <input type="number" id="epochs" min="1" max="100" value="5" class="epoch-control">
</div>

<!-- Preview Section -->
<div class="section">
  <h3>Live JSON Preview</h3>
  <div id="preview">{}</div>
</div>

<button id="send-data" class="send-btn">🚀 Start Training</button>
<div id="feedback"></div>

<!-- Logs Section -->
<div class="section">
  <h3>Live Logs</h3>
  <div id="logs">Logs will appear here...</div>
</div>
<script>
  const columnsContainer = document.getElementById("columns-container");
  const addColumnBtn = document.getElementById("add-column");
  const sendBtn = document.getElementById("send-data");
  const feedback = document.getElementById("feedback");
  const fileUpload = document.getElementById("file-upload");
  const preview = document.getElementById("preview");
  const logs = document.getElementById("logs");
  const epochInput = document.getElementById("epochs");

  function log(msg) {
    logs.innerText += "\n" + msg;
    logs.scrollTop = logs.scrollHeight;
  }

  function createColumn(promptVal = "", responseVal = "") {
    const col = document.createElement("div");
    col.className = "column";

    const promptInput = document.createElement("input");
    promptInput.placeholder = "Prompt";
    promptInput.value = promptVal;
    promptInput.oninput = updatePreview;

    const responseInput = document.createElement("input");
    responseInput.placeholder = "Response";
    responseInput.value = responseVal;
    responseInput.oninput = updatePreview;

    const removeBtn = document.createElement("button");
    removeBtn.className = "remove-btn";
    removeBtn.innerText = "✖";
    removeBtn.onclick = () => { col.remove(); updatePreview(); };

    col.appendChild(removeBtn);
    col.appendChild(promptInput);
    col.appendChild(responseInput);
    columnsContainer.appendChild(col);

    updatePreview();
  }

  createColumn();

  addColumnBtn.onclick = () => createColumn();

  async function parseUploadedFile(file) {
    try {
      const text = await file.text();
      let data = [];

      // Try JSON array
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) {
          data = parsed.filter(obj => obj.prompt && obj.response);
          if (data.length) {
            log(`✅ Parsed ${data.length} entries from JSON array file.`);
            return data;
          }
        }
      } catch {}

      // Try line-separated JSON
      text.split("\n").filter(l => l.trim() !== "").forEach(line => {
        try {
          const obj = JSON.parse(line);
          if (obj.prompt && obj.response) data.push(obj);
        } catch {}
      });

      if (data.length) {
        log(`✅ Parsed ${data.length} entries from line-separated file.`);
      } else {
        log("⚠️ No valid data found in uploaded file.");
      }

      return data;
    } catch (err) {
      log("❌ File parsing error: " + err.message);
      return [];
    }
  }

  async function collectData() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    let data = [];

    if (mode === "manual" || mode === "both") {
      document.querySelectorAll(".column").forEach(col => {
        const prompt = col.children[1].value.trim();
        const response = col.children[2].value.trim();
        if (prompt && response) data.push({ prompt, response });
      });
    }

    if ((mode === "upload" || mode === "both") && fileUpload.files.length > 0) {
      const uploadedData = await parseUploadedFile(fileUpload.files[0]);
      data = data.concat(uploadedData);
    }

    return data;
  }

  async function updatePreview() {
    const data = await collectData();
    preview.innerText = JSON.stringify(data, null, 2);
  }

  sendBtn.onclick = async () => {
    const data = await collectData();
    const epochs = Math.max(1, Math.round(parseFloat(epochInput.value))); // Ensure whole number >= 1

    if (data.length === 0) {
      feedback.innerText = "❌ No valid data to send!";
      log("❌ No valid data to send!");
      return;
    }

    feedback.innerText = "⏳ Sending data to backend...";
    log("⏳ Sending data to backend...");

    try {
      const res = await fetch("https://fweb-backend.onrender.com/train", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data, epochs })
      });

      const result = await res.json();
      if (result.success) {
        feedback.innerText = "✅ Training completed!";
        log("✅ Training complete ✅");
        log(JSON.stringify(result, null, 2));
      } else {
        feedback.innerText = "❌ Training failed: " + (result.error || "Unknown error");
        log("❌ Backend error: " + (result.error || "Unknown error"));
      }
    } catch (err) {
      feedback.innerText = "❌ Network error: " + err.message;
      log("❌ Network error: " + err.message);
    }
  };

  fileUpload.addEventListener("change", async () => {
    log("📂 File selected: " + fileUpload.files[0].name);
    await updatePreview();
  });
</script>
</body>
</html>

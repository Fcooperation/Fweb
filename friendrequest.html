<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Friend Requests</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background: #0e0e10;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    .card {
      background: #1c1c1f;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .card h3 {
      margin: 0 0 8px 0;
      color: #4da6ff;
    }
    .actions button {
      background: #333;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      margin-right: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .actions button:hover {
      background: #4da6ff;
    }
    .no-req {
      text-align: center;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Friend Requests</h2>
    <div id="requests"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://pwsxezhugsxosbwhkdvf.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const reqDiv = document.getElementById("requests");

    async function loadRequests() {
      reqDiv.innerHTML = "Loading...";
      const id = localStorage.getItem("id");
      if (!id) {
        reqDiv.innerHTML = "<p class='no-req'>No user ID found in local storage.</p>";
        return;
      }

      const { data: user, error } = await supabase
        .from("fwebaccount")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !user) {
        reqDiv.innerHTML = "<p class='no-req'>Error fetching user data.</p>";
        return;
      }

      const requests = user.friend_requests || [];
      if (requests.length === 0) {
        reqDiv.innerHTML = "<p class='no-req'>No friend requests.</p>";
        return;
      }

      reqDiv.innerHTML = "";
      for (const friendId of requests) {
        const { data: friend } = await supabase
          .from("fwebaccount")
          .select("*")
          .eq("id", friendId)
          .single();

        if (!friend) continue;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${friend.username}</h3>
          <p>Email: ${friend.email}</p>
          <div class="actions">
            <button class="accept">Accept</button>
            <button class="reject">Reject</button>
          </div>
        `;

        card.querySelector(".accept").onclick = async () => {
          const updatedAccepted = user.accepted ? [...user.accepted, friendId] : [friendId];
          const updatedRequests = requests.filter(r => r !== friendId);

          await supabase.from("fwebaccount").update({
            accepted: updatedAccepted,
            friend_requests: updatedRequests
          }).eq("id", id);

          location.reload();
        };

        card.querySelector(".reject").onclick = async () => {
          const updatedRequests = requests.filter(r => r !== friendId);
          await supabase.from("fwebaccount").update({
            friend_requests: updatedRequests
          }).eq("id", id);

          location.reload();
        };

        reqDiv.appendChild(card);
      }
    }

    loadRequests();
  </script>
</body>
</html>

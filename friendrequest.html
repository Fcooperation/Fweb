<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Friend Requests</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background: #0b0b0d;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 620px;
      margin: 0 auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #4da6ff;
    }
    .fchat-card {
      background: #16171a;
      border-radius: 18px;
      padding: 14px 16px;
      margin-bottom: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      transition: transform 0.15s ease-in-out;
    }
    .fchat-card:hover {
      transform: translateY(-2px);
    }
    .username {
      font-size: 1.2rem;
      font-weight: 600;
      color: #4da6ff;
      margin-bottom: 5px;
    }
    .email {
      color: #999;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .actions button {
      background: #222;
      color: #fff;
      border: none;
      padding: 7px 12px;
      border-radius: 8px;
      margin-right: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: 0.2s;
    }
    .actions button:hover {
      background: #4da6ff;
    }
    .no-req {
      text-align: center;
      color: #777;
    }
    /* Hidden background log bar (fades away) */
    #log {
      text-align: center;
      color: #4da6ff;
      font-size: 0.9rem;
      opacity: 0.7;
      transition: opacity 0.8s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Friend Requests</h2>
    <div id="log"></div>
    <div id="requests"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://pwsxezhugsxosbwhkdvf.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const reqDiv = document.getElementById("requests");
    const logDiv = document.getElementById("log");

    function log(msg) {
      console.log(msg); // console for dev
      logDiv.innerText = msg;
      logDiv.style.opacity = 0.7;
      setTimeout(() => logDiv.style.opacity = 0, 1200);
    }

    async function loadRequests() {
      log("Retrieving user info from local storage...");
      reqDiv.innerHTML = "Loading...";
      const id = localStorage.getItem("id");
      if (!id) {
        reqDiv.innerHTML = "<p class='no-req'>No user ID found.</p>";
        return;
      }

      log("Checking fchat account storage...");
      const { data: user, error } = await supabaseClient
        .from("fwebaccount")
        .select("*")
        .eq("id", id)
        .single();

      if (error || !user) {
        reqDiv.innerHTML = "<p class='no-req'>Error fetching user data.</p>";
        return;
      }

      const requests = user.friend_requests || [];
      if (requests.length === 0) {
        reqDiv.innerHTML = "<p class='no-req'>No friend requests found.</p>";
        return;
      }

      log("Found friend requests. Fetching details...");
      reqDiv.innerHTML = "";

      for (const friendId of requests) {
        const { data: friend } = await supabaseClient
          .from("fwebaccount")
          .select("*")
          .eq("id", friendId)
          .single();

        if (!friend) continue;

        const card = document.createElement("div");
        card.className = "fchat-card";
        card.innerHTML = `
          <div class="username">${friend.username}</div>
          <div class="email">${friend.email}</div>
          <div class="actions">
            <button class="accept">Accept</button>
            <button class="reject">Reject</button>
          </div>
        `;

        card.querySelector(".accept").onclick = async () => {
          log("Accepting friend...");
          const updatedAccepted = user.accepted ? [...user.accepted, friendId] : [friendId];
          const updatedRequests = requests.filter(r => r !== friendId);
          await supabaseClient.from("fwebaccount").update({
            accepted: updatedAccepted,
            friend_requests: updatedRequests
          }).eq("id", id);
          location.reload();
        };

        card.querySelector(".reject").onclick = async () => {
          log("Rejecting friend...");
          const updatedRequests = requests.filter(r => r !== friendId);
          await supabaseClient.from("fwebaccount").update({
            friend_requests: updatedRequests
          }).eq("id", id);
          location.reload();
        };

        reqDiv.appendChild(card);
      }

      log("Serving friend request cards...");
    }

    loadRequests();
  </script>
</body>
</html>

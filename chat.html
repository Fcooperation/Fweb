<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="UTF-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1.0" />  
<title>FCHAT - Chat</title>  
<style>  
/* --- YOUR ORIGINAL CSS (untouched except a few helper classes added at bottom) --- */  
*{box-sizing:border-box;}  
body{  
  font-family:'Poppins','Segoe UI',sans-serif;  
  background:#fdfdfd;color:#111;margin:0;height:100vh;  
  display:flex;flex-direction:column;  
}  
header{  
  background:#fff;display:flex;flex-direction:column;align-items:flex-start;  
  padding:12px 18px;border-bottom:1px solid #eee;box-shadow:0 2px 8px rgba(0,0,0,0.05);  
}  
.header-top{display:flex;justify-content:space-between;align-items:center;width:100%;}  
.header-left{display:flex;align-items:center;}  
.chat-header-pic{width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:10px;background:#ccc;}  
.chat-header-name{font-weight:600;font-size:18px;cursor:pointer;}  
#chat-status{font-size:12px;color:#555;margin-top:3px;}  
#chat-board{flex:1;background:#fafafa;overflow-y:auto;padding:15px;display:flex;flex-direction:column;}  
.message{  
  background:#ececec;color:#000;padding:10px 15px;border-radius:14px;  
  margin-bottom:10px;max-width:75%;word-wrap:break-word;position:relative;  
  align-self:flex-start;cursor:pointer;transition:background 0.2s, transform 0.2s;  
}  
.message.me{background:#c2ffc2;align-self:flex-end;}  
.message:hover{background:#e4e4e4;}  
.msg-time{display:block;text-align:right;font-size:11px;color:#555;margin-top:3px;}  
.linked-box{background:rgba(0,0,0,0.05);border-left:3px solid #007bff;  
  padding:5px 8px;border-radius:5px;font-size:13px;margin-bottom:5px;cursor:pointer;}  
#reply-box{  
  background:#f1f1f1;padding:6px 12px;font-size:13px;border-left:3px solid #007bff;  
  display:none;align-items:center;justify-content:space-between;  
}  
#reply-box span{flex:1;}  
#reply-box button{background:transparent;border:none;font-size:18px;cursor:pointer;}  
#chat-input-area{  
  display:flex;flex-direction:column;border-top:1px solid #ddd;  
  background:#fff;position:sticky;bottom:0;  
}  
#chat-input-row{display:flex;align-items:center;padding:10px 14px;}  
#chat-input{  
  flex:1;border:1px solid #ccc;border-radius:25px;padding:10px 15px;  
  font-size:15px;outline:none;background:#f7f7f7;transition:0.2s;  
}  
#chat-input:focus{background:#fff;border-color:#999;}  
#send-btn{  
  background:#007bff;border:none;color:#fff;font-size:20px;border-radius:50%;  
  width:42px;height:42px;margin-left:8px;cursor:pointer;  
  display:flex;align-items:center;justify-content:center;  
}  
#send-btn:hover{background:#0066d6;}  
#loading{text-align:center;padding:20px;color:#777;}  
.context-menu{  
  position:absolute;background:#fff;border:1px solid #ccc;  
  box-shadow:0 2px 8px rgba(0,0,0,0.15);border-radius:6px;  
  z-index:1000;display:none;flex-direction:column;min-width:100px;  
}  
.context-menu button{  
  background:none;border:none;text-align:left;padding:8px 12px;  
  width:100%;cursor:pointer;font-size:14px;  
}  
.context-menu button:hover{background:#eee;}  /* --- small helper styles added --- */
.message.swiping{ transform: translateX(18px) scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
.msg-status { display:block; font-size:11px; color:#444; margin-top:4px; text-align:right; }
.menu-visible{ display:flex !important; }
.message.glow {
  box-shadow: 0 0 15px 3px #007bff;
  transform: scale(1.02);
  transition: box-shadow 0.2s, transform 0.2s;
}
</style>

</head>  
<body>  
<header>  
  <div class="header-top" id="chat-header">  
    <div class="header-left">  
      <img id="chat-pic" class="chat-header-pic" src="" alt="Profile">  
      <div class="chat-header-name" id="chat-name">Loading...</div>  
    </div>  
  </div>  
  <div id="chat-status">Initializing...</div>  
</header>  <div id="chat-board"><div id="loading">Loading chat...</div></div>  <div id="chat-input-area">  
  <div id="reply-box"><span></span><button id="close-reply">Ã—</button></div>  
  <div id="chat-input-row">  
    <input type="text" id="chat-input" placeholder="Type a message...">  
    <button id="send-btn">âž¤</button>  
  </div>  
</div>  <div id="menu" class="context-menu">  
  <button id="delete-msg">Delete</button> <script>
const API_BASE = "https://fweb-backend.onrender.com";

// local user
let currentUser = JSON.parse(localStorage.getItem("fweb_user"));

// id of the user you are chatting with
let chatPartnerId = localStorage.getItem("fchat_current_partner");

const chatName = document.getElementById("chat-name");
const chatPic = document.getElementById("chat-pic");
const chatStatus = document.getElementById("chat-status");


/* ---------------------------------------------------------
   LOAD CHAT PARTNER ACCOUNT
   1. Look for fchat_current_partner
   2. Load fchat_user_<id> from localStorage
   3. If not found â†’ GET /chatuser/:id
----------------------------------------------------------*/
async function loadChatUser() {
    if (!chatPartnerId) {
        chatStatus.textContent = "No chat selected.";
        console.warn("âš  No chat partner ID found in localStorage");
        return;
    }

    const LS_KEY = "fchat_user_" + chatPartnerId;

    // 1ï¸âƒ£ Check if full user account exists in localStorage
    let cachedUser = localStorage.getItem(LS_KEY);
    if (cachedUser) {
        console.log("ðŸ“¦ Loaded user from localStorage");
        const user = JSON.parse(cachedUser);
        applyUserHeader(user);
        return user;
    }

    // 2ï¸âƒ£ Not found â†’ fetch from backend
    try {
        console.log("ðŸŒ Fetching chat user from Render backend:", chatPartnerId);
        chatStatus.textContent = "Fetching user...";

        const response = await fetch(`${API_BASE}/chatuser/${chatPartnerId}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const user = data.user;

        // save
        localStorage.setItem(LS_KEY, JSON.stringify(user));

        console.log("âœ… User saved to localStorage:", LS_KEY);

        applyUserHeader(user);
        return user;

    } catch (err) {
        console.error("âŒ Error loading chat user:", err.message);
        chatStatus.textContent = "Failed to load user.";
    }
}


/* ---------------------------------------------------------
   APPLY TO HEADER
----------------------------------------------------------*/
function applyUserHeader(user) {
    chatName.textContent = user.username || "Unknown";
    chatPic.src = user.avatar || "default.png";
    chatStatus.textContent = "Online";
}


/* ---------------------------------------------------------
   RUN ON PAGE LOAD
----------------------------------------------------------*/
window.addEventListener("DOMContentLoaded", () => {
    loadChatUser();
});
</script>
</body>  
</html>  
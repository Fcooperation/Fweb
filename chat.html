<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
/* ---------- RESET ---------- */
* { box-sizing: border-box; margin:0; padding:0; }
/* ---------- BODY ---------- */
body {
  font-family: Arial, sans-serif;height: 100vh;display: flex;flex-direction: column;background: white;
}
/* ---------- TOP BAR ---------- */
#chat-header {display: flex;align-items: center;gap: 12px;padding: 12px 16px;border-bottom: 1px solid #ddd;cursor:pointer;
}#chat-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background: black;
}#chat-header .info {
  display: flex;
  flex-direction: column;
}
#chat-header .username {font-size: 16px;font-weight: bold;
}#chat-header .status {font-size: 12px;
  color: #555;
}/* ---------- CHAT BODY ---------- */
#chat-body {flex: 1;padding: 16px;overflow-y: auto;display: flex;flex-direction: column;gap: 10px;
}/* ---------- MESSAGE BUBBLES ---------- */.message {
  max-width: 85%;          /* longer like WhatsApp */
  padding: 12px 18px;      /* bigger touch area */
  touch-action: pan-y;     /* allows horizontal swipe */
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  transition: transform 0.2s ease;
}.sent {
  align-self: flex-end;
  background: black;
  color: white;
  border-bottom-right-radius: 4px;
}.received {
  align-self: flex-start;
  background: #f1f1f1;
  color: black;
  border-bottom-left-radius: 4px;
}

.pending {
  opacity: 0.6;
}
/* ---------- INPUT BAR ---------- */
#chat-input {
  display: flex;
  gap: 10px;
  padding: 10px 16px;
  border-top: 1px solid #ddd;
}
#chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
}
#chat-input button {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
#reply-preview {
  border-top: 1px solid #ddd;
}#reply-preview {
  display: flex;
}
#cancel-reply {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: #e0e0e0;
  color: #333;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#cancel-reply:active {
  background: #ccc;
}
/* ---------- MESSAGE STATUS ---------- */
.status-text {
  font-size: 11px;
  margin-top: 4px;
  text-align: right;
  opacity: 0.85;
}
.status-sending {
  color: grey;
}
.status-pending {
  color: orange;
}
.status-sent {
  color: #1e88e5; /* WhatsApp-like blue */
}.pending {
  opacity: 0.6;
}
/* ---------- MESSAGE TIME ---------- */
.message-time {
  font-weight: bold;
  font-style: italic;
  margin-right: 6px;
}
.message:active {
  opacity: 0.7;
}
.message.highlight {
  animation: megaGlow 2s ease-out 1;
}
@keyframes megaGlow {
  0% {
    box-shadow:
      0 0 0 4px #1e88e5,
      0 0 25px 10px rgba(30,136,229,1),
      0 0 50px 18px rgba(30,136,229,0.9),
      0 0 80px 30px rgba(30,136,229,0.7);
  }
  100% {
    box-shadow: none;
  }
}
/* ---------- MULTI SELECT MODE (WhatsApp style) ---------- */
/* Dim entire chat when selecting */
#chat-body.select-mode {
  background: rgba(0,0,0,0.08);
}
/* Selected message */
.message.selected {
  background: #cce4ff !important; /* WhatsApp blue */
  box-shadow: 0 0 0 2px #1e88e5 inset;
}
/* Make non-selected messages dim */
#chat-body.select-mode .message:not(.selected) {
  opacity: 0.5;
}
/* Prevent text selection popup */
.message {
  user-select: none;
}
.delete-option {
  padding: 14px;
  text-align: center;
  font-size: 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}
.delete-option:last-child {
  border-bottom: none;
}
.delete-option:active {
  background: #f1f1f1;
}
.delete-option[data-action="everyone"] {
  color: red;
  font-weight: bold;
}
.delete-option.cancel {
  color: #555;
}
.message.deleted {
  background: #e0e0e0 !important;
  color: #666;
  font-style: italic;
}
.message.sent.deleted {
  background: #e0e0e0;
  color: #666;
}
/* Chat container */
#chat-container {
  max-width: 500px;
  margin: auto;
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* Message card */
.chat-card {
  margin: 8px 0;
  padding: 10px;
  border-radius: 6px;
  max-width: 80%;
  position: relative;
  word-wrap: break-word;
}

/* Received messages (grey cards) */
.received {
  background: #e0e0e0;
  align-self: flex-start;
}

/* Time label inside card */
.chat-time {
  font-size: 0.75em;
  color: #555;
  position: absolute;
  bottom: 4px;
  right: 8px;
}

/* Status display above chat */
#receive-status {
  text-align: center;
  margin-bottom: 10px;
  font-weight: bold;
}

/* Status colors */
.loading { color: blue; }
.success { color: green; }
.offline { color: red; }
/* üîó Linked / Reply preview */
.linked-preview {
  font-size: 12px;
  padding: 6px 8px;
  margin-bottom: 6px;
  border-left: 3px solid #4f8cff;
  background: rgba(79, 140, 255, 0.1);
  color: #333;
  cursor: pointer;
  border-radius: 6px;
}

/* Highlight original message when jumped to */
.chat-card.highlight {
  animation: flash 1.2s ease;
}

@keyframes flash {
  0% { background-color: #fff3cd; }
  100% { background-color: inherit; }
}
.message {
  max-width: 75%;
  padding: 8px 10px;
  margin: 6px 0;
  border-radius: 8px;
  position: relative;
}

.message.received {
  background: #e9e9e9;
  align-self: flex-start;
}

.message.sent {
  background: #007bff;
  color: white;
  align-self: flex-end;
}

.msg-username {
  font-size: 12px;
  font-weight: bold;
  margin-bottom: 3px;
  opacity: 0.8;
}

.msg-text {
  font-size: 14px;
}

.msg-time {
  font-size: 11px;
  opacity: 0.6;
  margin-top: 4px;
  text-align: right;
}
</style>
</head>
<body>
  <!-- ---------- SELECTION BOARD ---------- -->
<div id="selection-bar" style="
    display: none;position: fixed;top: 0;left: 0;right: 0;height: 64px;
    background: white;z-index: 1000;
    align-items: center;padding: 0 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">
    <button id="select-back" style="
        border: none;background: none;
        font-size: 18px;cursor: pointer;
    ">‚Üê Back</button>
    <button id="select-delete" style="
  margin-left: auto;border: none;
  background: none;font-size: 16px;
  cursor: pointer;">üóë Delete</button>
</div>
<div id="delete-menu" style="
  display: none;position: fixed;left: 50%;bottom: 30%;transform: translateX(-50%);background: white;border-radius: 12px;box-shadow: 0 10px 30px rgba(0,0,0,0.2);z-index: 2000;width: 260px;overflow: hidden;">
<div class="delete-option" data-action="me">
    Delete for me
  </div>
<div class="delete-option" data-action="everyone">
    Delete for everyone
  </div>
<div class="delete-option cancel">
    Cancel
  </div>
</div>
<!-- ---------- HEADER ---------- --><div id="chat-header">
  <img id="chat-pic" src="">
  <div class="info">
    <div class="username" id="chat-username">Loading...</div>
    <div class="status" id="chat-status">Status...</div>
  </div>
  <div id="receive-status">Updating‚Ä¶</div>
</div>

<!-- ---------- MESSAGES ---------- -->
<div id="chat-body"></div>
<!-- ---------- REPLY PREVIEW ---------- -->
<div id="reply-preview" style="display:none; padding:8px 16px; background:#f1f1f1; border-left:4px solid #007bff; justify-content:space-between; align-items:center; gap:10px;">
  <div>
    <div id="reply-sender" style="font-weight:bold; font-size:12px;"></div>
    <div id="reply-text" style="font-size:14px; color:#555;"></div>
  </div>
<button id="cancel-reply" aria-label="Cancel reply">‚úï</button>
</div>
<!-- ---------- INPUT ---------- -->
<div id="chat-input">
  <input type="text" id="message-input" placeholder="Type a message‚Ä¶">
  <button id="send-btn">Send</button>
</div>
<script>
const API_URL = "https://fweb-backend.onrender.com/fchat";
/* ---------- LOAD CHAT TARGET ---------- */
const chatWith = JSON.parse(localStorage.getItem("chatting_with")) || null;
const account = JSON.parse(localStorage.getItem("faccount")) || {email:"", password:""};
if (!chatWith || !chatWith.id) {
  alert("No chat selected");
  window.location.href = "fchat.html";
}
/* ---------- HEADER DATA ---------- */
const header = document.getElementById("chat-header");
document.getElementById("chat-username").textContent = chatWith.username || "Unknown";
document.getElementById("chat-status").textContent = chatWith.status || "";
document.getElementById("chat-pic").src = chatWith.profile_pic || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9zdmc+";
/* ---------- HEADER CLICK TO DASHBOARD ---------- */
header.onclick = () => {
  localStorage.setItem("chat_viewing", JSON.stringify({
    id: chatWith.id,
    username: chatWith.username || "",
    profile_pic: chatWith.profile_pic || "",
    status: chatWith.status || ""
  }));
  window.location.href = "chatdashboard.html";
};
/* ---------- MESSAGE STORAGE ---------- */
const STORAGE_KEY = `chat_${account.email}_${chatWith.id}`;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
function formatMessageTime(sentAt) {
  if (!sentAt) return "";
const date = new Date(sentAt);
  const now = new Date();
const isToday =
    date.toDateString() === now.toDateString();
const yesterday = new Date();
  yesterday.setDate(now.getDate() - 1);
const isYesterday =
    date.toDateString() === yesterday.toDateString();
const time = date.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
if (isToday) {
    return time;
  }
const dayMonth = date.toLocaleDateString([], {
    day: "2-digit",
    month: "short"
  });
return `${dayMonth} ${time}`;
}
/* ---------- MULTI SELECT LOGIC ---------- */
let selectMode = false;
let selectedMessages = new Set();
const selectionBar = document.getElementById("selection-bar");
const deleteBtn = document.getElementById("select-delete");
const deleteMenu = document.getElementById("delete-menu");
// Back button closes selection mode
document.getElementById("select-back").onclick = exitSelectMode;
deleteBtn.onclick = () => {
  if (selectedMessages.size === 0) return;
const deleteForEveryoneOption =
    deleteMenu.querySelector('[data-action="everyone"]');
let canDeleteForEveryone = true;
  selectedMessages.forEach(el => {
  if (el.classList.contains("deleted")) {
    canDeleteForEveryone = false;
  }
});
selectedMessages.forEach(el => {
    const msgId = el.dataset.id;
    const msg = messages.find(m => String(m.id) === msgId);
// ‚ùå Any condition that blocks "delete for everyone"
    if (
      !msg ||
      msg.type !== "sent" ||           // received messages
      msg.status === "seen" ||          // already seen
      msg.status === "pending"          // pending
    ) {
      canDeleteForEveryone = false;
    }
  });
// ‚úÖ Show / hide option
  if (canDeleteForEveryone) {
    deleteForEveryoneOption.style.display = "block";
  } else {
    deleteForEveryoneOption.style.display = "none";
  }
deleteMenu.style.display = "block";
};
deleteMenu.addEventListener("click", e => {
  const option = e.target.closest(".delete-option");
  if (!option) return;
if (option.classList.contains("cancel")) {
    closeDeleteMenu();
    return;
  }
const action = option.dataset.action;
if (action === "me") deleteForMe();
  if (action === "everyone") deleteForEveryone();

  closeDeleteMenu();
});
let holdTimer = null;
function enableMultiSelect() {
  const chatBody = document.getElementById("chat-body");
chatBody.querySelectorAll(".message").forEach(msg => {
// PRESS & HOLD
    msg.addEventListener("touchstart", e => {
  if (selectMode) return;
holdTimer = setTimeout(() => {
    enterSelectMode(msg);
  }, 500);
});
msg.addEventListener("touchend", () => {
      clearTimeout(holdTimer);
    });
msg.addEventListener("touchmove", () => {
      clearTimeout(holdTimer);
    });
// TAP WHILE IN SELECT MODE
    msg.addEventListener("click", e => {
      if (!selectMode) return;
      toggleSelection(msg);
      e.stopPropagation();
    });
  });
// Tap empty space to exit select mode
  chatBody.addEventListener("click", e => {
    if (selectMode && !e.target.closest(".message")) {
      exitSelectMode();
    }
  });
}
function enterSelectMode(msg) {
  selectMode = true;
  document.getElementById("chat-body").classList.add("select-mode");
  selectionBar.style.display = "flex"; // ‚Üê show selection bar
  toggleSelection(msg);
}
function toggleSelection(msg) {
  if (selectedMessages.has(msg)) {
    msg.classList.remove("selected");
    selectedMessages.delete(msg);
  } else {
    msg.classList.add("selected");
    selectedMessages.add(msg);
  }
// Exit if none selected
  if (selectedMessages.size === 0) {
    exitSelectMode();
  }
}
function exitSelectMode() {
  selectMode = false;
selectedMessages.forEach(m => m.classList.remove("selected"));
  selectedMessages.clear();
document.getElementById("chat-body").classList.remove("select-mode");
  selectionBar.style.display = "none";

  closeDeleteMenu(); // ‚úÖ FORCE CLOSE DELETE MENU
}
function closeDeleteMenu() {
  deleteMenu.style.display = "none";
}
document.addEventListener("click", e => {
  if (deleteMenu.style.display === "block") {
    if (!e.target.closest("#delete-menu") &&
        !e.target.closest("#select-delete")) {
      closeDeleteMenu();
    }
  }
});
function deleteForMe() {
  const idsToDelete = [...selectedMessages].map(el => el.dataset.id);
messages = messages.filter(msg => !idsToDelete.includes(String(msg.id)));

  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  exitSelectMode();
  renderMessages();
}
async function deleteForEveryone() {
  const ids = [...selectedMessages].map(el => Number(el.dataset.id));

  // üîÅ Optimistic UI update (WhatsApp style)
  selectedMessages.forEach(el => {
    const msgId = el.dataset.id;
    const msg = messages.find(m => String(m.id) === msgId);

    if (msg) {
      msg.deleted = true;
      msg.text = "This message was deleted by you";
      msg.status = "sent";
      msg.type = "sent";
    }
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  renderMessages();
  exitSelectMode();

  // üåê Send delete request to backend
  const success = await deleteForEveryoneBackend(ids);

  if (!success) {
    console.warn("Backend delete failed ‚Äî keeping local delete");
    // (Optional) You can show a toast later if you want
  }
}
/* ---------- RENDER MESSAGES ---------- */
function renderMessages() {
  const box = document.getElementById("chat-body");
  box.innerHTML = "";
  messages.forEach(msg => {
  const div = document.createElement("div");
  div.className = "message " + msg.type + (msg.status==="pending"?" pending":"");
  if (msg.replyTo) {
  const replyBox = document.createElement("div");
  replyBox.style.borderLeft = "3px solid #007bff";
  replyBox.style.padding = "4px 8px";
  replyBox.style.marginBottom = "6px";
  replyBox.style.fontSize = "12px";
  replyBox.style.opacity = "0.8";
replyBox.innerHTML = `
    <strong>${msg.replyTo.sender}</strong><br>
    ${msg.replyTo.text}
  `;
div.appendChild(replyBox);
}

// üîó Render linked / reply preview
if (msg.linked_message === "yes" && msg.linked_message_id) {
  const linked = messages.find(m => String(m.id) === String(msg.linked_message_id));

  if (linked) {
    const linkedBox = document.createElement("div");
    linkedBox.className = "linked-preview";

    const senderName = linked.type === "sent" ? "You" : chatWith.username;

    linkedBox.innerHTML = `<strong>${senderName}</strong><br>${linked.text.slice(0, 80) || "Message"}`;

    linkedBox.onclick = () => {
      const target = document.querySelector(`[data-id='${linked.id}']`);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
        target.classList.add("highlight");
        setTimeout(() => target.classList.remove("highlight"), 1200);
      }
    };

    // append BEFORE the message text
    div.appendChild(linkedBox);
  }
}
const textNode = document.createElement("div");
if (msg.deleted) {
  textNode.textContent = msg.text;
  div.classList.add("deleted"); // applies grey bubble
} else {
  textNode.textContent = msg.text;
}
div.appendChild(textNode);
/* ---------- STATUS TEXT (only for sent messages) ---------- */
if (msg.type === "sent") {
  const status = document.createElement("div");
  status.classList.add("status-text");
const timeSpan = document.createElement("span");
  timeSpan.classList.add("message-time");
  timeSpan.textContent = formatMessageTime(msg.sent_at);
status.appendChild(timeSpan);
if (msg.status === "sending") {
    status.append("Sending‚Ä¶");
    status.classList.add("status-sending");
  } 
  else if (msg.status === "pending") {
    status.append("Pending");
    status.classList.add("status-pending");
  } 
  else if (msg.status === "sent") {
    status.append("Sent");
    status.classList.add("status-sent");
  }
div.appendChild(status);
}
  // üîë link DOM to message data
  div.dataset.id = msg.id;

  box.appendChild(div);
});
  scrollToBottom();
enableMessageTap();
enableMultiSelect(); // ‚úÖ ADD THIS
}
function enableMessageTap() {
  const allMessages = document.querySelectorAll(".message");
allMessages.forEach(msgEl => {
    msgEl.onclick = () => {
      if (selectMode) return; // üö´ disable jump while selecting
      if (msgEl.classList.contains("deleted")) return;
      const msgId = msgEl.dataset.id;
      const msgData = messages.find(m => m.id == msgId);
if (!msgData) return;
// ‚ùå Not linked ‚Üí do nothing
      if (!msgData.linked || !msgData.linked_message_id) return;
// ‚úÖ Linked ‚Üí find original message
      const linkedEl = document.querySelector(
        `.message[data-id='${msgData.linked_message_id}']`
      );
if (!linkedEl) return;
// Scroll to original
      linkedEl.scrollIntoView({
  behavior: "smooth",
  block: "center"
});
// wait for scroll to settle before glowing
setTimeout(() => {
  linkedEl.classList.add("highlight");
setTimeout(() => {
    linkedEl.classList.remove("highlight");
  }, 2000);
}, 350); // ‚Üê delay controls when glow starts
    };
  });
}
let startX = 0;
let currentMsg = null;
let replyingMessage = null;
document.getElementById("cancel-reply").onclick = () => {
  replyingMessage = null;
  document.getElementById("reply-preview").style.display = "none";
};
function getReplySenderName(msg) {
  return msg.type === "sent" ? "You" : chatWith.username;
}
function scrollToInput() {
  const inputBar = document.getElementById("chat-input");
  inputBar.scrollIntoView({ behavior: "smooth", block: "end" });
}
document.getElementById("chat-body").addEventListener("touchstart", e => {
  const msg = e.target.closest(".message");
  if (!msg) return;
  if (msg.classList.contains("deleted")) return;
startX = e.touches[0].clientX;
  currentMsg = msg;
});
document.getElementById("chat-body").addEventListener("touchmove", e => {
  if (!currentMsg) return;
const moveX = e.touches[0].clientX;
  const diffX = moveX - startX;
// Move message slightly with finger
  if (diffX > 0 && diffX < 80) {
    currentMsg.style.transform = `translateX(${diffX}px)`;
  }
});
document.getElementById("chat-body").addEventListener("touchend", e => {
  if (!currentMsg) return;
const endX = e.changedTouches[0].clientX;
  const diffX = endX - startX;
// Reset position
  currentMsg.style.transform = "translateX(0)";
  if (diffX > 50) {
  const msgId = currentMsg.dataset.id;
  const msgData = messages.find(m => m.id == msgId);
if (msgData) {
  replyingMessage = msgData;
document.getElementById("reply-sender").textContent = getReplySenderName(msgData);
  document.getElementById("reply-text").textContent = msgData.text;
document.getElementById("reply-preview").style.display = "block";
scrollToInput();
const input = document.getElementById("message-input");
  setTimeout(() => input.focus(), 150);
   }
}
currentMsg = null;
});
/* ---------- SCROLL ---------- */
function scrollToBottom() {
  const box = document.getElementById("chat-body");
  box.scrollTop = box.scrollHeight;
}
/* ---------- SEND TO BACKEND ---------- */
async function sendToBackend(msgObj) {
  try {
    const payload = {    
      action: "send_messages",    
      email: account.email,    
      id: msgObj.id,    
      sender_id: account.id,    
      receiver_id: chatWith.id,    
      linked: msgObj.linked,  
      linked_message_id: msgObj.linked_message_id,  
      sent_at: msgObj.sent_at,  
      text: msgObj.text    
    };
    
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      msgObj.status = "sent";
      msgObj.sending_since = null;
    } else {
      msgObj.status = "pending"; // keep pending
    }

  } catch(e) {
    msgObj.status = "pending"; // keep pending
    msgObj.sending_since = null;
    console.warn("Failed to send, message pending", e);
  }

  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  renderMessages();
}

async function retryPending() {
  if (!navigator.onLine) return;

  // retry one by one to avoid overwriting
  for (const msg of messages) {
    if (msg.status === "pending") {
      msg.status = "sending";
      msg.sending_since = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();

      await sendToBackend(msg); // wait for backend confirmation
    }
  }
}
/* ---------- SEND MESSAGE ---------- */
function sendMessage() {
  const input = document.getElementById("message-input");
  const text = input.value.trim();
  if(!text) return;
const msgObj = {
  id: Date.now(),
  type: "sent",
  text,
  sent_at: new Date().toISOString(),
  status: navigator.onLine ? "sending" : "pending",
  sending_since: navigator.onLine ? Date.now() : null,
  replyTo: replyingMessage ? {
    id: replyingMessage.id,
    text: replyingMessage.text,
    sender: getReplySenderName(replyingMessage)
  } : null,
  linked: replyingMessage ? true : false,
  linked_message_id: replyingMessage ? replyingMessage.id : null,
  sender_id: account.id,         // <--- add this
  receiver_id: chatWith.id          // <--- and this
};
  messages.push(msgObj);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  input.value = "";
  renderMessages();
  replyingMessage = null;
document.getElementById("reply-preview").style.display = "none";
if(navigator.onLine){
    sendToBackend(msgObj);
  }
}
/* ---------- RETRY PENDING MESSAGES ---------- */
async function retryPending() {
  if (!navigator.onLine) return; // üö´ no internet ‚Üí do nothing
for (const msg of messages) {
    if (msg.status === "pending") {
      msg.status = "sending";
msg.sending_since = Date.now(); // üëà ADD THIS
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();

      await sendToBackend(msg);
    }
  }
}
function checkStuckSendingMessages() {
  const now = Date.now();
  let changed = false;
messages.forEach(msg => {
    if (
      msg.status === "sending" &&
      msg.sending_since &&
      now - msg.sending_since > 30000 // ‚è± 30 seconds
    ) {
      msg.status = "pending";
      msg.sending_since = null;
      changed = true;
    }
  });
if (changed) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    renderMessages();
  }
}
window.addEventListener("online", retryPending);
setInterval(() => {
  retryPending();
  checkStuckSendingMessages(); // üëà ADD THIS
}, 1000);
// Receive messages every 4 seconds
setInterval(() => {
  receiveMessages();
}, 4000);

// Also receive immediately when coming online
window.addEventListener("online", receiveMessages);
async function deleteForEveryoneBackend(ids) {
  try {
    const payload = {
      action: "delete_messages",
      email: account.email,
      ids // array of message IDs
    };

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    return data.success === true;
  } catch (e) {
    console.warn("Delete for everyone failed", e);
    return false;
  }
}
/* ---------- INIT ---------- */
renderMessages();
document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").addEventListener("keydown", e => {
  if(e.key === "Enter") sendMessage();
});

/* ---------- RECEIVE MESSAGES (UPDATED) ---------- */
async function receiveMessages() {
  if (!navigator.onLine) return;

  try {
    if (!account?.email || !chatWith?.id) return;

    const payload = {
      action: "receive_messages",
      email: account.email,
      chatWithId: chatWith.id
    };

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!Array.isArray(data.data)) return;

    const chatUsername = data.chatWith?.username || "Unknown";

    let changed = false;

    data.data.forEach(msg => {
      const exists = messages.some(m => String(m.id) === String(msg.id));
      if (exists) return;

      messages.push({
        id: msg.id,
        type: "received",
        text: msg.text || "",
        sent_at: msg.sent_at || new Date().toISOString(),
        status: "sent",

        sender_id: msg.sender_id,
        receiver_id: account.id,

        sender_username: chatUsername, // üëà IMPORTANT

        linked_message: msg.linked === true ? "yes" : "no",
        linked_message_id: msg.linked_message_id || null
      });

      changed = true;
    });

    if (changed) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();
    }

  } catch (err) {
    console.warn("Receive messages failed:", err);
  }
}

/* ---------- AUTO RECEIVE ---------- */
setInterval(receiveMessages, 4000);
window.addEventListener("online", receiveMessages);

</script></script>
</body></html>
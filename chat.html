<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
/* ---------- RESET ---------- */
* { box-sizing: border-box; margin:0; padding:0; }
/* ---------- BODY ---------- */
body {
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: white;
}
/* ---------- TOP BAR ---------- */
#chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  cursor:pointer;
  position: sticky;    /* stays in place */
  top: 0;              /* stick to top */
  z-index: 100;        /* stays above messages */
  background: white;   /* ensures it doesn‚Äôt blend with messages when scrolling */
}
#chat-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background: black;
}
#chat-header .info {
  display: flex;
  flex-direction: column;
}
#chat-header .username {
  font-size: 16px;
  font-weight: bold;
}
#chat-header .status {
  font-size: 12px;
  color: #555;
}
/* ---------- CHAT BODY ---------- */
#chat-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
/* ---------- MESSAGE BUBBLES ---------- */
.message {
  max-width: 90%;                  /* wider bubbles */
  padding: 12px 18px 22px 18px;    /* bottom padding for time */
  touch-action: pan-y;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  transition: transform 0.2s ease;
  word-wrap: break-word;
  display: inline-block;
  user-select: none;               /* prevent text selection */
}

.message.sent {
  background: black;
  position: relative; /* ensure child absolute positioning works */
  color: white;
  align-self: flex-end;
  min-width: 100px;    /* minimum bubble width for very short messages */
  max-width: 80%;     /* prevents very long messages from stretching too far */
}
.message.received {
  align-self: flex-start;
  background: #e9e9e9;
  color: black;
  border-bottom-left-radius: 4px;
  padding: 12px 18px 22px 18px;   /* top, sides, bottom */
  position: relative;

  min-width: 100px;    /* minimum bubble width for very short messages */
  max-width: 80%;     /* prevents very long messages from stretching too far */
  display: inline-block;
  word-wrap: break-word;  /* wrap long text */
}
.pending {
  opacity: 0.6;
}

/* ---------- SENT MESSAGE TIME & STATUS INLINE ---------- */
.message.sent .msg-time {
  display: inline-block;   /* inline with status text */
  float: right;            /* right side inside bubble */
  margin-left: 6px;        /* spacing from status */
}
.status-text.sent {
  display: inline-block;   /* keep inline with time */
}

/* ---------- RECEIVED MESSAGE TIME UNDER TEXT ---------- */

.message.received .msg-time {
  position: absolute;  /* position relative to bubble */
  bottom: 4px;         /* distance from bottom of bubble */
  right: 8px;          /* right aligned inside bubble */
  display: block;
  text-align: right;
  font-size: 11px;
  opacity: 0.6;
}

/* ---------- INPUT BAR ---------- */
#chat-input {
  display: flex;
  gap: 10px;
  padding: 10px 16px;
  border-top: 1px solid #ddd;

  position: sticky;   /* stays in place while messages scroll */
  bottom: 0;          /* stick to bottom of chat body */
  z-index: 100;       /* stays above messages */
  background: white;  /* ensures it doesn‚Äôt blend with messages */
}
#chat-input textarea {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
  resize: none;
  overflow-y: auto;
  min-height: 36px;
  max-height: 120px;
}
#chat-input button {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
  cursor: pointer;
}

#reply-preview {
  border-top: 1px solid #ddd;
  display: flex;
}
#cancel-reply {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: #e0e0e0;
  color: #333;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#cancel-reply:active { background: #ccc; }

/* ---------- MESSAGE STATUS ---------- */
.status-text {
  font-size: 11px;
  margin-top: 4px;
  text-align: right;
  opacity: 0.85;
}
.status-sending { color: grey; }
.status-pending { color: orange; }
.status-sent { color: #1e88e5; }
.pending { opacity: 0.6; }

/* ---------- MESSAGE TIME ---------- */
.message-time {
  font-weight: bold;
  font-style: italic;
  margin-top: 4px;
  display: block;
  text-align: right;
  font-size: 11px;
  opacity: 0.6;
}

.message:active { opacity: 0.7; }

.message.highlight {
  animation: megaGlow 2s ease-out 1;
}

@keyframes megaGlow {
  0% {
    box-shadow:
      0 0 0 4px #1e88e5,
      0 0 25px 10px rgba(30,136,229,1),
      0 0 50px 18px rgba(30,136,229,0.9),
      0 0 80px 30px rgba(30,136,229,0.7);
  }
  100% { box-shadow: none; }
}

/* ---------- MULTI SELECT MODE ---------- */
#chat-body.select-mode { background: rgba(0,0,0,0.08); }
.message.selected {
  background: #cce4ff !important;
  box-shadow: 0 0 0 2px #1e88e5 inset;
}
#chat-body.select-mode .message:not(.selected) { opacity: 0.5; }

/* ---------- DELETE OPTIONS ---------- */
.delete-option {
  padding: 14px;
  text-align: center;
  font-size: 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}
.delete-option:last-child { border-bottom: none; }
.delete-option:active { background: #f1f1f1; }
.delete-option[data-action="everyone"] { color: red; font-weight: bold; }
.delete-option.cancel { color: #555; }

.message.deleted { background: #e0e0e0 !important; color: #666; font-style: italic; }
.message.sent.deleted { background: #e0e0e0; color: #666; }

/* Chat container */
#chat-container {
  max-width: 500px;
  margin: auto;
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* Message card */
.chat-card {
  margin: 8px 0;
  padding: 10px;
  border-radius: 6px;
  max-width: 80%;
  position: relative;
  word-wrap: break-word;
}

/* Time label inside card */
.chat-time {
  font-size: 0.75em;
  color: #555;
  position: absolute;
  bottom: 4px;
  right: 8px;
}

/* Status display above chat */
#receive-status {
  text-align: center;
  margin-bottom: 10px;
  font-weight: bold;
}
.loading { color: blue; }
.success { color: green; }
.offline { color: red; }

/* üîó Linked / Reply preview */
.linked-preview {
  font-size: 12px;
  padding: 6px 8px;
  margin-bottom: 6px;
  border-left: 3px solid #4f8cff;
  background: rgba(79, 140, 255, 0.1);
  color: #333;
  cursor: pointer;
  border-radius: 6px;

  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;   /* ensures single line with ellipsis */
}

/* Highlight original message when jumped to */
.chat-card.highlight { animation: flash 1.2s ease; }
@keyframes flash {
  0% { background-color: #fff3cd; }
  100% { background-color: inherit; }
}

.msg-username {
  font-size: 12px;
  font-weight: bold;
  margin-bottom: 3px;
  opacity: 0.8;
}

.msg-text {
  font-size: 14px;
  display: block;
  word-wrap: break-word;
}

.msg-time {
  position: relative;
  bottom: auto;
  right: auto;
  margin-top: 4px;
  text-align: right;
  font-size: 11px;
  opacity: 0.6;
}
/* ---------- READ MORE ---------- */
.msg-text {
  font-size: 14px;
  line-height: 1.4em;
  white-space: pre-wrap;
}

.msg-text.collapsed {
  display: -webkit-box;
  -webkit-line-clamp: 5;      /* üëà MAX LINES */
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.read-more {
  color: #007bff;
  font-size: 13px;
  font-weight: 600;   /* üëà ADD THIS */
  cursor: pointer;
  margin-top: 4px;
  user-select: none;
}
</style>
</head>
<body>
  <!-- ---------- SELECTION BOARD ---------- -->
<div id="selection-bar" style="
    display: none;position: fixed;top: 0;left: 0;right: 0;height: 64px;
    background: white;z-index: 1000;
    align-items: center;padding: 0 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">
    <button id="select-back" style="
        border: none;background: none;
        font-size: 18px;cursor: pointer;
    ">‚Üê Back</button>
    <button id="select-delete" style="
  margin-left: auto;border: none;
  background: none;font-size: 16px;
  cursor: pointer;">üóë Delete</button>
</div>
<div id="delete-menu" style="
  display: none;position: fixed;left: 50%;bottom: 30%;transform: translateX(-50%);background: white;border-radius: 12px;box-shadow: 0 10px 30px rgba(0,0,0,0.2);z-index: 2000;width: 260px;overflow: hidden;">
<div class="delete-option" data-action="me">
    Delete for me
  </div>
<div class="delete-option" data-action="everyone">
    Delete for everyone
  </div>
<div class="delete-option cancel">
    Cancel
  </div>
</div>
<!-- ---------- HEADER ---------- --><div id="chat-header">
  <img id="chat-pic" src="">
  <div class="info">
    <div class="username" id="chat-username">Loading...</div>
    <div class="status" id="chat-status">Status...</div>
  </div>
</div>
<div id="receive-status">Updating‚Ä¶</div>

<!-- ---------- MESSAGES ---------- -->
<div id="chat-body"></div>
<!-- ---------- REPLY PREVIEW ---------- -->
<div id="reply-preview" style="display:none; padding:8px 16px; background:#f1f1f1; border-left:4px solid #007bff; justify-content:space-between; align-items:center; gap:10px;">
  <div>
    <div id="reply-sender" style="font-weight:bold; font-size:12px;"></div>
    <div id="reply-text" style="font-size:14px; color:#555;"></div>
  </div>
<button id="cancel-reply" aria-label="Cancel reply">‚úï</button>
</div>
<!-- ---------- INPUT ---------- -->
<div id="chat-input">
<textarea id="message-input" placeholder="Type a message‚Ä¶"></textarea>
  <button id="send-btn">Send</button>
</div>
<script>
const API_URL = "https://fweb-backend.onrender.com/fchat";
/* ---------- LOAD CHAT TARGET ---------- */
const chatWith = JSON.parse(localStorage.getItem("chatting_with")) || null;
const account = JSON.parse(localStorage.getItem("faccount")) || {email:"", password:""};
const input = document.getElementById("message-input");
const chatHeader = document.getElementById("chat-header");
const chatBody = document.getElementById("chat-body");

chatBody.addEventListener("scroll", () => {
  // Make sure header is always visible
  chatHeader.style.transform = "translateY(0)";
});

// Auto-grow / shrink as user types
input.addEventListener("input", () => {
  input.style.height = "auto";                   // reset height first
  input.style.height = input.scrollHeight + "px"; // grow/shrink to fit content
});

// Function to reset input after sending
function resetInput() {
  input.value = "";            // clear input text
  input.style.height = "auto"; // shrink back to one line
}

// Call this inside your sendMessage() at the end (before or after renderMessages)
if (!chatWith || !chatWith.id) {
  alert("No chat selected");
  window.location.href = "fchat.html";
}
/* ---------- HEADER DATA ---------- */
const header = document.getElementById("chat-header");
document.getElementById("chat-username").textContent = chatWith.username || "Unknown";
document.getElementById("chat-status").textContent = chatWith.status || "";
document.getElementById("chat-pic").src = chatWith.profile_pic || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9zdmc+";
/* ---------- HEADER CLICK TO DASHBOARD ---------- */
header.onclick = () => {
  localStorage.setItem("chat_viewing", JSON.stringify({
    id: chatWith.id,
    username: chatWith.username || "",
    profile_pic: chatWith.profile_pic || "",
    status: chatWith.status || ""
  }));
  window.location.href = "chatdashboard.html";
};
/* ---------- MESSAGE STORAGE ---------- */
const STORAGE_KEY = `chat_${account.email}_${chatWith.id}`;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
function formatMessageTime(sentAt) {
  if (!sentAt) return "";
const date = new Date(sentAt);
  const now = new Date();
const isToday =
    date.toDateString() === now.toDateString();
const yesterday = new Date();
  yesterday.setDate(now.getDate() - 1);
const isYesterday =
    date.toDateString() === yesterday.toDateString();
const time = date.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
if (isToday) {
    return time;
  }
const dayMonth = date.toLocaleDateString([], {
    day: "2-digit",
    month: "short"
  });
return `${dayMonth} ${time}`;
}
/* ---------- MULTI SELECT LOGIC ---------- */
let selectMode = false;
let selectedMessages = new Set();
const selectionBar = document.getElementById("selection-bar");
const deleteBtn = document.getElementById("select-delete");
const deleteMenu = document.getElementById("delete-menu");

// Back button closes selection mode
document.getElementById("select-back").onclick = exitSelectMode;

deleteBtn.onclick = () => {
  if (selectedMessages.size === 0) return;
  const deleteForEveryoneOption = deleteMenu.querySelector('[data-action="everyone"]');
  let canDeleteForEveryone = true;

  // Check if any message is already deleted
  selectedMessages.forEach(el => {
    if (el.classList.contains("deleted")) canDeleteForEveryone = false;
  });

  // Check if messages are eligible for "delete for everyone"
  selectedMessages.forEach(el => {
    const msgId = el.dataset.id;
    const msg = messages.find(m => String(m.id) === msgId);
    if (!msg || msg.type !== "sent" || msg.status === "seen" || msg.status === "pending") {
      canDeleteForEveryone = false;
    }
  });

  // Show / hide option
  deleteForEveryoneOption.style.display = canDeleteForEveryone ? "block" : "none";
  deleteMenu.style.display = "block";
};

// Delete menu click
deleteMenu.addEventListener("click", e => {
  const option = e.target.closest(".delete-option");
  if (!option) return;
  if (option.classList.contains("cancel")) {
    closeDeleteMenu();
    return;
  }

  const action = option.dataset.action;
  if (action === "me") deleteForMe();
  if (action === "everyone") deleteForEveryone();

  closeDeleteMenu();
});

// Press & hold / multi-select setup
let holdTimer = null;
function enableMultiSelect() {
  const chatBody = document.getElementById("chat-body");
  chatBody.querySelectorAll(".message").forEach(msg => {
    // PRESS & HOLD
    msg.addEventListener("touchstart", e => {
      if (selectMode) return;
      holdTimer = setTimeout(() => enterSelectMode(msg), 500);
    });
    msg.addEventListener("touchend", () => clearTimeout(holdTimer));
    msg.addEventListener("touchmove", () => clearTimeout(holdTimer));

    // TAP WHILE IN SELECT MODE
    msg.addEventListener("click", e => {
      if (!selectMode) return;
      toggleSelection(msg);
      e.stopPropagation();
    });
  });

  // Tap empty space to exit select mode
  chatBody.addEventListener("click", e => {
    if (selectMode && !e.target.closest(".message")) exitSelectMode();
  });
}

function enterSelectMode(msg) {
  selectMode = true;
  document.getElementById("chat-body").classList.add("select-mode");
  selectionBar.style.display = "flex";
  toggleSelection(msg);
}

function toggleSelection(msg) {
  if (selectedMessages.has(msg)) {
    msg.classList.remove("selected");
    selectedMessages.delete(msg);
  } else {
    msg.classList.add("selected");
    selectedMessages.add(msg);
  }

  if (selectedMessages.size === 0) exitSelectMode();
}

function exitSelectMode() {
  selectMode = false;
  selectedMessages.forEach(m => m.classList.remove("selected"));
  selectedMessages.clear();
  document.getElementById("chat-body").classList.remove("select-mode");
  selectionBar.style.display = "none";
  closeDeleteMenu();
}

function closeDeleteMenu() {
  deleteMenu.style.display = "none";
}

document.addEventListener("click", e => {
  if (deleteMenu.style.display === "block") {
    if (!e.target.closest("#delete-menu") && !e.target.closest("#select-delete")) {
      closeDeleteMenu();
    }
  }
});

// Delete for me
function deleteForMe() {
  const idsToDelete = [...selectedMessages].map(el => el.dataset.id);
  messages = messages.filter(msg => !idsToDelete.includes(String(msg.id)));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  exitSelectMode();
  renderMessages();
}

// Delete for everyone
async function deleteForEveryone() {
  const ids = [...selectedMessages].map(el => Number(el.dataset.id));

  // Optimistic UI update
  selectedMessages.forEach(el => {
    const msgId = el.dataset.id;
    const msg = messages.find(m => String(m.id) === msgId);
    if (msg) {
      msg.deleted = true;
      msg.text = "This message was deleted by you";
      msg.status = "deleting";
      msg.type = "sent";
    }
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  renderMessages();
  exitSelectMode();

  // Send delete request to backend with email & user_id
  try {
    const success = await deleteForEveryoneBackend(ids);
    if (!success) console.warn("Backend delete failed ‚Äî keeping local delete");
  } catch (err) {
    console.error("Error deleting messages for everyone:", err);
  }
}

// Backend call
async function deleteForEveryoneBackend(ids) {
  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "delete_messages",
      email: account.email,   // üîê auth (logged-in user)
      user_id: chatWith.id,   // üéØ target chat user
      ids: ids                // üßπ message IDs
    })
  });

  const data = await res.json();
  return data.success === true;
}
/* ---------- RENDER MESSAGES ---------- */
function renderMessages() {
  const box = document.getElementById("chat-body");
  box.innerHTML = "";

  messages.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message " + msg.type + (msg.status === "pending" ? " pending" : "");

    // Header (username) ‚Äì only for received messages
    if (msg.type === "received") {
      const header = document.createElement("div");
      header.className = "msg-username";
      header.textContent = msg.sender_username || "Unknown";
      div.appendChild(header);
    }

    // Time ‚Äì ONLY for received messages
    if (msg.type === "received") {
      const timeDiv = document.createElement("div");
      timeDiv.className = "msg-time";
      timeDiv.textContent = formatMessageTime(msg.sent_at);
      div.appendChild(timeDiv);
    }

    // Reply preview
    if (msg.replyTo) {
      const replyBox = document.createElement("div");
      replyBox.style.borderLeft = "3px solid #007bff";
      replyBox.style.padding = "4px 8px";
      replyBox.style.marginBottom = "6px";
      replyBox.style.fontSize = "12px";
      replyBox.style.opacity = "0.8";
      replyBox.innerHTML = `
        <strong>${msg.replyTo.sender}</strong><br>
        ${msg.replyTo.text}
      `;
      div.appendChild(replyBox);
    }

    // Linked message preview
    if (msg.linked_message === "yes" && msg.linked_message_id) {
      const linked = messages.find(m => String(m.id) === String(msg.linked_message_id));

      if (linked) {
        const linkedBox = document.createElement("div");
        linkedBox.className = "linked-preview";

        const senderName = linked.type === "sent" ? "You" : chatWith.username;
        linkedBox.innerHTML = `<strong>${senderName}</strong><br>${linked.text.slice(0, 80) || "Message"}`;

        linkedBox.onclick = (e) => {
          if (selectMode) return;
          e.stopPropagation();

          const target = document.querySelector(`[data-id='${linked.id}']`);
          if (target) {
            target.scrollIntoView({ behavior: "smooth", block: "center" });
            target.classList.add("highlight");
            setTimeout(() => target.classList.remove("highlight"), 1200);
          }
        };

        div.appendChild(linkedBox);
      }
    }

    // Message text
    const textNode = document.createElement("div");
    textNode.className = "msg-text";

    if (msg.deleted) {
      textNode.textContent = msg.text;
      div.classList.add("deleted");
      div.appendChild(textNode);
    } else {
      textNode.textContent = msg.text;
      div.appendChild(textNode);

      // READ MORE logic
      requestAnimationFrame(() => {
        const lineHeight = parseFloat(getComputedStyle(textNode).lineHeight);

        const INITIAL_LINES = 10;
        const STEP_LINES = 25;
        let currentLines = INITIAL_LINES;

        const applyClamp = () => {
          textNode.style.display = "-webkit-box";
          textNode.style.webkitBoxOrient = "vertical";
          textNode.style.webkitLineClamp = currentLines;
          textNode.style.overflow = "hidden";
        };

        const removeClamp = () => {
          textNode.style.webkitLineClamp = "unset";
          textNode.style.display = "block";
          textNode.style.overflow = "visible";
        };

        if (textNode.scrollHeight > lineHeight * INITIAL_LINES) {
          applyClamp();

          const readMore = document.createElement("div");
          readMore.className = "read-more";
          readMore.textContent = "Read more";

          readMore.onclick = () => {
  const totalLines = Math.ceil(textNode.scrollHeight / lineHeight);

  if (currentLines >= totalLines) {
    // READ LESS
    currentLines = INITIAL_LINES;
    applyClamp();
    readMore.textContent = "Read more";
  } else {
    // READ MORE
    currentLines += STEP_LINES;

    if (currentLines >= totalLines) {
      removeClamp();
      readMore.textContent = "Read less";
    } else {
      applyClamp();
      readMore.textContent = "Read more";
    }
  }
};

          div.appendChild(readMore);
        }
      });
    }

    // Status (sent messages only)
    if (msg.type === "sent") {
      const status = document.createElement("div");
      status.classList.add("status-text");

      const timeSpan = document.createElement("span");
      timeSpan.classList.add("message-time");
      timeSpan.textContent = formatMessageTime(msg.sent_at);
      status.appendChild(timeSpan);

      if (msg.status === "sending") {
        status.append("Sending‚Ä¶");
        status.classList.add("status-sending");
      } else if (msg.status === "pending") {
        status.append("Pending");
        status.classList.add("status-pending");
      } else if (msg.status === "sent") {
        status.append("Sent");
        status.classList.add("status-sent");
      } else if (msg.status === "deleting") {
  status.append("Deleting‚Ä¶");
  status.classList.add("status-deleting");
} else if (msg.status === "deleted") {
  status.append("Deleted");
  status.classList.add("status-deleted");
}

      div.appendChild(status);
    }

    div.dataset.id = msg.id;
    box.appendChild(div);
  });

  scrollToBottom();
  enableMessageTap();
  enableMultiSelect();
}
function enableMessageTap() {
  const allMessages = document.querySelectorAll(".message");
allMessages.forEach(msgEl => {
    msgEl.onclick = () => {
      if (selectMode) return; // üö´ disable jump while selecting
      if (msgEl.classList.contains("deleted")) return;
      const msgId = msgEl.dataset.id;
      const msgData = messages.find(m => m.id == msgId);
if (!msgData) return;
// ‚ùå Not linked ‚Üí do nothing
      if (!msgData.linked || !msgData.linked_message_id) return;
// ‚úÖ Linked ‚Üí find original message
      const linkedEl = document.querySelector(
        `.message[data-id='${msgData.linked_message_id}']`
      );
if (!linkedEl) return;
// Scroll to original
      linkedEl.scrollIntoView({
  behavior: "smooth",
  block: "center"
});
// wait for scroll to settle before glowing
setTimeout(() => {
  linkedEl.classList.add("highlight");
setTimeout(() => {
    linkedEl.classList.remove("highlight");
  }, 2000);
}, 350); // ‚Üê delay controls when glow starts
    };
  });
}
let startX = 0;
let currentMsg = null;
let replyingMessage = null;
document.getElementById("cancel-reply").onclick = () => {
  replyingMessage = null;
  document.getElementById("reply-preview").style.display = "none";
};
function getReplySenderName(msg) {
  return msg.type === "sent" ? "You" : chatWith.username;
}
function scrollToInput() {
  const inputBar = document.getElementById("chat-input");
  inputBar.scrollIntoView({ behavior: "smooth", block: "end" });
}
document.getElementById("chat-body").addEventListener("touchstart", e => {
  const msg = e.target.closest(".message");
  if (!msg) return;
  if (msg.classList.contains("deleted")) return;
startX = e.touches[0].clientX;
  currentMsg = msg;
});
document.getElementById("chat-body").addEventListener("touchmove", e => {
  if (!currentMsg) return;
const moveX = e.touches[0].clientX;
  const diffX = moveX - startX;
// Move message slightly with finger
  if (diffX > 0 && diffX < 80) {
    currentMsg.style.transform = `translateX(${diffX}px)`;
  }
});
document.getElementById("chat-body").addEventListener("touchend", e => {
  if (!currentMsg) return;
const endX = e.changedTouches[0].clientX;
  const diffX = endX - startX;
// Reset position
  currentMsg.style.transform = "translateX(0)";
  if (diffX > 50) {
  const msgId = currentMsg.dataset.id;
  const msgData = messages.find(m => m.id == msgId);
if (msgData) {
  replyingMessage = msgData;
document.getElementById("reply-sender").textContent = getReplySenderName(msgData);
  let preview = msgData.text;
if (preview.length > 40) preview = preview.slice(0, 40) + "‚Ä¶";
document.getElementById("reply-text").textContent = preview;
document.getElementById("reply-preview").style.display = "block";
scrollToInput();
const input = document.getElementById("message-input");
  setTimeout(() => input.focus(), 150);
   }
}
currentMsg = null;
});
/* ---------- SCROLL ---------- */
function scrollToBottom() {
  const box = document.getElementById("chat-body");
  box.scrollTop = box.scrollHeight;
}
/* ---------- SEND TO BACKEND ---------- */
async function sendToBackend(msgObj) {
  try {
    const payload = {    
      action: "send_messages",    
      email: account.email,    
      id: msgObj.id,    
      sender_id: account.id,    
      receiver_id: chatWith.id,    
      linked: msgObj.linked,  
      linked_message_id: msgObj.linked_message_id,  
      sent_at: msgObj.sent_at,  
      text: msgObj.text    
    };
    
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      msgObj.status = "sent";
      msgObj.sending_since = null;
    } else {
      msgObj.status = "pending"; // keep pending
    }

  } catch(e) {
    msgObj.status = "pending"; // keep pending
    msgObj.sending_since = null;
    console.warn("Failed to send, message pending", e);
  }

  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  renderMessages();
}

async function retryPending() {
  if (!navigator.onLine) return;

  // retry one by one to avoid overwriting
  for (const msg of messages) {
    if (msg.status === "pending") {
      msg.status = "sending";
      msg.sending_since = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();

      await sendToBackend(msg); // wait for backend confirmation
    }
  }
}
/* ---------- SEND MESSAGE ---------- */
function sendMessage() {
  const input = document.getElementById("message-input");
  const text = input.value.trim();
  if (!text) return;

// üîπ truncate & sanitize reply preview before sending
let truncatedReply = null;
if (replyingMessage) {
  truncatedReply = replyingMessage.text.replace(/\s+/g, ' ').trim();
  if (truncatedReply.length > 80) truncatedReply = truncatedReply.slice(0, 80) + "‚Ä¶";
}

  const msgObj = {
    id: Date.now(),
    type: "sent",
    text,
    sent_at: new Date().toISOString(),
    status: navigator.onLine ? "sending" : "pending",
    sending_since: navigator.onLine ? Date.now() : null,
    replyTo: replyingMessage
      ? {
          id: replyingMessage.id,
          text: truncatedReply,   // <-- store truncated text here
          sender: getReplySenderName(replyingMessage),
        }
      : null,
    linked: replyingMessage ? true : false,
    linked_message_id: replyingMessage ? replyingMessage.id : null,
    sender_id: account.id,
    receiver_id: chatWith.id,
  };

  messages.push(msgObj);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  input.value = "";
  resetInput();

  // Show the reply preview with truncated text
  if (truncatedReply) {
    const previewEl = document.getElementById("reply-text");
    if (previewEl) previewEl.textContent = truncatedReply;
  }

  renderMessages(); // now render messages AFTER preview is set

  replyingMessage = null;
  document.getElementById("reply-preview").style.display = "none";

  if (navigator.onLine) sendToBackend(msgObj);
}
/* ---------- RETRY PENDING MESSAGES ---------- */
async function retryPending() {
  if (!navigator.onLine) return; // üö´ no internet ‚Üí do nothing
for (const msg of messages) {
    if (msg.status === "pending") {
      msg.status = "sending";
msg.sending_since = Date.now(); // üëà ADD THIS
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();

      await sendToBackend(msg);
    }
  }
}
function checkStuckSendingMessages() {
  const now = Date.now();
  let changed = false;
messages.forEach(msg => {
    if (
      msg.status === "sending" &&
      msg.sending_since &&
      now - msg.sending_since > 30000 // ‚è± 30 seconds
    ) {
      msg.status = "pending";
      msg.sending_since = null;
      changed = true;
    }
  });
if (changed) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    renderMessages();
  }
}
window.addEventListener("online", retryPending);
setInterval(() => {
  retryPending();
  checkStuckSendingMessages(); // üëà ADD THIS
}, 1000);
// Receive messages every 4 seconds
setInterval(() => {
  receiveMessages();
}, 4000);

// Also receive immediately when coming online
window.addEventListener("online", receiveMessages);
async function deleteForEveryoneBackend(ids) {
  try {
    const payload = {
      action: "delete_messages",
      email: account.email,
      user_id: chatWith.id,  // ‚úÖ include the chat target
      ids                  // array of message IDs
    };

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    return data.success === true;
  } catch (e) {
    console.warn("Delete for everyone failed", e);
    return false;
  }
}
/* ---------- INIT ---------- */
renderMessages();
document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").addEventListener("keydown", e => {
  if(e.key === "Enter") sendMessage();
});

/* ---------- RECEIVE MESSAGES (UPDATED) ---------- */
async function receiveMessages() {
  if (!navigator.onLine) return;

  const statusEl = document.getElementById("receive-status"); // üîπ grab status element

  try {
    if (!account?.email || !chatWith?.id) return;

    const payload = {
      action: "receive_messages",
      email: account.email,
      chatWithId: chatWith.id
    };

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!Array.isArray(data.data)) return;

    const chatUsername = data.chatWith?.username || "Unknown";

    let changed = false;

    data.data.forEach(msg => {
      const exists = messages.some(m => String(m.id) === String(msg.id));
      if (exists) return;

      messages.push({
        id: msg.id,
        type: "received",
        text: msg.text || "",
        sent_at: msg.sent_at || new Date().toISOString(),
        status: "sent",

        sender_id: msg.sender_id,
        receiver_id: account.id,

        sender_username: chatUsername, // üëà IMPORTANT

        linked_message: msg.linked === true ? "yes" : "no",
        linked_message_id: msg.linked_message_id || null
      });

      changed = true;
    });

    if (changed) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();

      // üîπ update status to "Updated" after successful receive
      if (statusEl) statusEl.textContent = "Updated";
    }

  } catch (err) {
    console.warn("Receive messages failed:", err);
    if (statusEl) statusEl.textContent = "Error";
  }
}
/* ---------- AUTO RECEIVE ---------- */
setInterval(receiveMessages, 1000);
window.addEventListener("online", receiveMessages);

</script></script>
</body></html>
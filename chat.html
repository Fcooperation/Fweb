<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="UTF-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1.0" />  
<title>FCHAT - Chat</title>  
<style>  
/* --- YOUR ORIGINAL CSS (untouched except a few helper classes added at bottom) --- */  
*{box-sizing:border-box;}  
body{  
  font-family:'Poppins','Segoe UI',sans-serif;  
  background:#fdfdfd;color:#111;margin:0;height:100vh;  
  display:flex;flex-direction:column;  
}  
header{  
  background:#fff;display:flex;flex-direction:column;align-items:flex-start;  
  padding:12px 18px;border-bottom:1px solid #eee;box-shadow:0 2px 8px rgba(0,0,0,0.05);  
}  
.header-top{display:flex;justify-content:space-between;align-items:center;width:100%;}  
.header-left{display:flex;align-items:center;}  
.chat-header-pic{width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:10px;background:#ccc;}  
.chat-header-name{font-weight:600;font-size:18px;cursor:pointer;}  
#chat-status{font-size:12px;color:#555;margin-top:3px;}  
#chat-board{flex:1;background:#fafafa;overflow-y:auto;padding:15px;display:flex;flex-direction:column;}  
.message{  
  background:#ececec;color:#000;padding:10px 15px;border-radius:14px;  
  margin-bottom:10px;max-width:75%;word-wrap:break-word;position:relative;  
  align-self:flex-start;cursor:pointer;transition:background 0.2s, transform 0.2s;  
}  
.message.me{background:#c2ffc2;align-self:flex-end;}  
.message:hover{background:#e4e4e4;}  
.msg-time{display:block;text-align:right;font-size:11px;color:#555;margin-top:3px;}  
.linked-box{background:rgba(0,0,0,0.05);border-left:3px solid #007bff;  
  padding:5px 8px;border-radius:5px;font-size:13px;margin-bottom:5px;cursor:pointer;}  
#reply-box{  
  background:#f1f1f1;padding:6px 12px;font-size:13px;border-left:3px solid #007bff;  
  display:none;align-items:center;justify-content:space-between;  
}  
#reply-box span{flex:1;}  
#reply-box button{background:transparent;border:none;font-size:18px;cursor:pointer;}  
#chat-input-area{  
  display:flex;flex-direction:column;border-top:1px solid #ddd;  
  background:#fff;position:sticky;bottom:0;  
}  
#chat-input-row{display:flex;align-items:center;padding:10px 14px;}  
#chat-input{  
  flex:1;border:1px solid #ccc;border-radius:25px;padding:10px 15px;  
  font-size:15px;outline:none;background:#f7f7f7;transition:0.2s;  
}  
#chat-input:focus{background:#fff;border-color:#999;}  
#send-btn{  
  background:#007bff;border:none;color:#fff;font-size:20px;border-radius:50%;  
  width:42px;height:42px;margin-left:8px;cursor:pointer;  
  display:flex;align-items:center;justify-content:center;  
}  
#send-btn:hover{background:#0066d6;}  
#loading{text-align:center;padding:20px;color:#777;}  
.context-menu{  
  position:absolute;background:#fff;border:1px solid #ccc;  
  box-shadow:0 2px 8px rgba(0,0,0,0.15);border-radius:6px;  
  z-index:1000;display:none;flex-direction:column;min-width:100px;  
}  
.context-menu button{  
  background:none;border:none;text-align:left;padding:8px 12px;  
  width:100%;cursor:pointer;font-size:14px;  
}  
.context-menu button:hover{background:#eee;}  /* --- small helper styles added --- */
.message.swiping{ transform: translateX(18px) scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
.msg-status { display:block; font-size:11px; color:#444; margin-top:4px; text-align:right; }
.menu-visible{ display:flex !important; }
</style>

</head>  
<body>  
<header>  
  <div class="header-top" id="chat-header">  
    <div class="header-left">  
      <img id="chat-pic" class="chat-header-pic" src="" alt="Profile">  
      <div class="chat-header-name" id="chat-name">Loading...</div>  
    </div>  
  </div>  
  <div id="chat-status">Initializing...</div>  
</header>  <div id="chat-board"><div id="loading">Loading chat...</div></div>  <div id="chat-input-area">  
  <div id="reply-box"><span></span><button id="close-reply">×</button></div>  
  <div id="chat-input-row">  
    <input type="text" id="chat-input" placeholder="Type a message...">  
    <button id="send-btn">➤</button>  
  </div>  
</div>  <div id="menu" class="context-menu">  
  <button id="delete-msg">Delete</button>  
</div>  <script type="module">  
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";  
  
const supabase = createClient(  
  "https://pwsxezhugsxosbwhkdvf.supabase.co",  
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ"  
);  
  
const chatBoard = document.getElementById('chat-board');  
const chatInput = document.getElementById('chat-input');  
const sendBtn = document.getElementById('send-btn');  
const chatName = document.getElementById('chat-name');  
const chatPic = document.getElementById('chat-pic');  
const replyBox = document.getElementById('reply-box');  
const replyText = replyBox.querySelector('span');  
const closeReply = document.getElementById('close-reply');  
const menu = document.getElementById('menu');  
const deleteBtn = document.getElementById('delete-msg');  
const chatStatus = document.getElementById('chat-status');  
  
const chatUserId = localStorage.getItem('chatting'); // the partner you're viewing  
const currentUser = JSON.parse(localStorage.getItem('faccount'));  
const storageKey = `chat_messages_${chatUserId}`;  
let linkedMsg = null;  
let selectedMsg = null;  
let longPressTimer = null;  
let touchStartX = 0;  
let touchMoved = false;  
  
if(!currentUser || !chatUserId){  
  chatStatus.textContent = "Error: Missing chat info!";  
  throw new Error("Missing localStorage data");  
}  
  
document.getElementById('chat-header').addEventListener('click',()=>{  
  localStorage.setItem('chat_viewing', chatUserId);  
  window.location.href = "chat_dashboard.html";  
});  
  
async function loadChatUser(){  
  chatStatus.textContent = "Accessing Supabase account...";  
  try{  
    const {data,error} = await supabase.from('fwebaccount').select('*').eq('id',chatUserId).maybeSingle();  
    if(error) throw error;  
    if(!data) throw new Error("User not found");  
    chatName.textContent = data.username || "Unknown User";  
    chatPic.src = data.profile_pic || "https://via.placeholder.com/50?text=U";  
    chatStatus.textContent = "Supabase account accessed.";  
  }catch(err){  
    chatName.textContent="User not found";  
    chatStatus.textContent = "Failed to access user.";  
    console.error(err);  
  }  
}  
  
function formatTime(t){  
  const d = new Date(t), n = new Date();  
  const same = d.toDateString() === n.toDateString();  
  return same ? d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+" UTC" :  
                d.toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})+" UTC";  
}  
  
  
/* Render messages FROM localStorage (unchanged CSS)  
   Includes .msg-status to show 'sent' text for messages sent by me.  
*/  
function renderMessages(){  
  const msgs = JSON.parse(localStorage.getItem(storageKey)) || [];  
  chatBoard.innerHTML = "";  
  if(msgs.length===0){ chatBoard.innerHTML="<div id='loading'>No messages yet.</div>"; return; }  
  msgs.forEach((m,i)=>{  
    const div = document.createElement("div");  
    div.classList.add("message");  
    if(m.sender==="me") div.classList.add("me");  
    div.dataset.index = i;  
    div.dataset.id = m.id;
    div.innerHTML= `${m.linked?`<div class="linked-box" data-linked-time="${m.linked_message_time}">${escapeHtml(m.linked_message)}</div>`:""}  
                    <div class="msg-text">${escapeHtml(m.message)}</div>  
                    <span class="msg-time">${formatTime(m.time_utc)}</span>  
                    <span class="msg-status">${m.status || ""}</span>`;  
    attachMessageHandlers(div, m, i);  
    chatBoard.appendChild(div);  
  });  
  chatBoard.scrollTop = chatBoard.scrollHeight;  
}  

function generateUUID() {
  // Simple UUIDv4 generator
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c==='x'? r : (r&0x3|0x8);
    return v.toString(16);
  });
}
  
/* Helper to escape HTML in inserted text */  
function escapeHtml(s){  
  if(!s) return "";  
  return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));  
}  
  
/* When user sends — save locally AND write to recipient's fchat_messages column  
   Also set status 'sent' under the message immediately in localStorage  
*/  
async function sendMessage(){  
  const text = chatInput.value.trim();  
  if(!text) return;  

  // Get linked message id from localStorage (if any)
  const linkedId = localStorage.getItem('linked_message_id');
  
  let linkedMsgData = null;
  if(linkedId){
    // find the linked message in current chat messages
    const msgs = JSON.parse(localStorage.getItem(storageKey)) || [];
    linkedMsgData = msgs.find(m => m.id === linkedId) || null;
  }

  const msgData = {
    id: generateUUID(),
    sender_id: currentUser.id,
    message: text,
    time_utc: new Date().toISOString(),
    linked: !!linkedMsgData,
    linked_message: linkedMsgData ? linkedMsgData.message : null,
    linked_message_time: linkedMsgData ? linkedMsgData.time_utc : null,
    linked_message_id: linkedMsgData ? linkedMsgData.id : null, // ✅ new field
    seen: false
  };

  // push locally (sender view)
  const msgs = JSON.parse(localStorage.getItem(storageKey)) || [];
  msgs.push({...msgData, sender:"me", status:"sent"});
  localStorage.setItem(storageKey,JSON.stringify(msgs));
  renderMessages();

  // clear linked message
  linkedMsg = null;
  localStorage.removeItem('linked_message_id');
  replyBox.style.display="none";

  // push to recipient's fchat_messages column
  try{
    const {data:recv, error:recvErr} = await supabase.from('fwebaccount')
      .select('fchat_messages').eq('id',chatUserId).maybeSingle();
    if(recvErr) throw recvErr;
    let arr = [];
    if(recv?.fchat_messages){
      if(Array.isArray(recv.fchat_messages)) arr = recv.fchat_messages;
      else { try{ arr = JSON.parse(recv.fchat_messages); } catch{ arr=[]; } }
    }
    arr.push(msgData);
    await supabase.from('fwebaccount').update({fchat_messages: JSON.stringify(arr)}).eq('id',chatUserId);
  }catch(e){console.error("Send failed:",e);}
}
  
/* ------------ RECEIVE / DETECTION FUNCTION (per your spec) -------------  
   - DOES NOT merge incoming msgs into localStorage automatically  
   - Only *detects* messages in the CURRENT USER'S fchat_messages column  
     which are FROM the chat partner (sender_id === chatUserId).  
   - Normalizes missing 'seen' property to false and updates server copy.  
*/  
async function detectIncomingForCurrentChat(){  
  try {  
    chatStatus.textContent = "Checking for new messages...";  
    const { data, error } = await supabase  
      .from('fwebaccount')  
      .select('fchat_messages')  
      .eq('id', currentUser.id)  
      .maybeSingle();  
  
    if (error) throw error;  
  
    if (data?.fchat_messages) {  
      // ensure array form  
      let arr = Array.isArray(data.fchat_messages) ? data.fchat_messages : JSON.parse(data.fchat_messages || "[]");  
  
      // normalize missing 'seen' property  
      let normalized = false;  
      arr = arr.map(m => {  
        if (typeof m.seen === 'undefined') { normalized = true; return {...m, seen:false}; }  
        return m;  
      });  
      if(normalized){  
        // write back normalized array to supabase  
        await supabase.from('fwebaccount').update({ fchat_messages: JSON.stringify(arr) }).eq('id', currentUser.id);  
      }  
  
      // filter messages that are FROM the partner you're viewing (chatUserId)  
      const fromPartner = arr.filter(msg => String(msg.sender_id) === String(chatUserId));  
      if(fromPartner.length > 0){  
        chatStatus.textContent = `New messages found (${fromPartner.length}) from ${chatName.textContent}`;  
        console.log(`✅ Detected ${fromPartner.length} incoming messages from ${chatUserId}`, fromPartner);  
        // do NOT merge automatically — only detection as requested  
      } else {  
        chatStatus.textContent = "No new messages found";  
      }  
    } else {  
      chatStatus.textContent = "No messages found";  
    }  
  
  } catch (err) {  
    console.error("Error detecting messages:", err);  
    chatStatus.textContent = "Error fetching messages";  
  }  
}  
/* --------------------------------------------------------------------- */  
  
/* Run detection every 2 seconds (as you had) */  
setInterval(detectIncomingForCurrentChat, 2000);  
  
/* ---------- Helpers: attach handlers for swipe, long-press, and context menu ---------- */  
function attachMessageHandlers(div, messageObj, index){  
  // clear old handlers if any  
  div.ontouchstart = div.ontouchmove = div.ontouchend = null;  
  div.onmousedown = div.onmouseup = null;  
  
  // LONG PRESS: show context menu (press & hold)  
  const startLongPress = (ev) => {  
    ev.preventDefault?.();  
    longPressTimer = setTimeout(() => {  
      selectedMsg = { index, obj: messageObj };  
      showContextMenu(div);  
    }, 480); // ~480ms long press  
  };  
  const cancelLongPress = () => {  
    if(longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }  
  };  
  
  // MOUSE (desktop)  
  div.addEventListener('mousedown', (e)=>{  
    startLongPress(e);  
  });  
  window.addEventListener('mouseup', (e)=>{ cancelLongPress(); });  
  
  // TOUCH (mobile)  
  div.addEventListener('touchstart', (e)=>{  
    touchStartX = e.touches[0].clientX;  
    touchMoved = false;  
    startLongPress(e);  
  }, {passive:true});  
  div.addEventListener('touchmove', (e)=>{  
    touchMoved = true;  
    const diff = e.touches[0].clientX - touchStartX;  
    if(diff > 8){ div.classList.add('swiping'); }  
  }, {passive:true});  
  div.addEventListener('touchend', (e)=>{  
    cancelLongPress();  
    div.classList.remove('swiping');  
    // if it was a quick swipe-right (and moved sufficiently), treat as "link/reply"  
    if(touchMoved){  
      const touchEndX = e.changedTouches[0].clientX;  
      const delta = touchEndX - touchStartX;  
      if(delta > 50){  
  linkedMsg = messageObj;  
  // Save linked message id in localStorage (replace if exists)
  localStorage.setItem('linked_message_id', messageObj.id);

  replyText.textContent = messageObj.message.length > 120 ? messageObj.message.slice(0,120)+"..." : messageObj.message;  
  replyBox.style.display = "flex";  
}
    }  
  }, {passive:true});  
  
  // also allow click to close context menu if open elsewhere  
  div.addEventListener('click', ()=>{ if(menu.style.display==='flex') hideContextMenu(); });  
}  
  
/* Context menu positioning & actions */  
function showContextMenu(targetDiv){  
  const rect = targetDiv.getBoundingClientRect();  
  menu.style.top = (rect.top + window.scrollY + 8) + 'px';  
  menu.style.left = (rect.right + 8) + 'px';  
  menu.style.display = 'flex';  
}  
function hideContextMenu(){  
  menu.style.display = 'none';  
  selectedMsg = null;  
}  
deleteBtn.addEventListener('click', async ()=>{  
  if(!selectedMsg) return hideContextMenu();  
  const { index, obj } = selectedMsg;  
  // read local storage  
  const msgs = JSON.parse(localStorage.getItem(storageKey)) || [];  
  const localMatch = msgs[index];  
  // Decide deletion behavior:  
  // - If message.seen === false -> remove from localStorage AND from supabase (from currentUser's fchat_messages)  
  // - If message.seen === true  -> remove only from localStorage  
  try{  
    if(obj.seen === false){  
      // remove from Supabase (current user's fchat_messages array)  
      const { data, error } = await supabase.from('fwebaccount').select('fchat_messages').eq('id', currentUser.id).maybeSingle();  
      if(error) throw error;  
      let arr = [];  
      if(data?.fchat_messages){  
        arr = Array.isArray(data.fchat_messages) ? data.fchat_messages : JSON.parse(data.fchat_messages || "[]");  
      }  
      // filter out message by unique combination (time_utc + message text + sender_id)  
      const filtered = arr.filter(m => !(m.time_utc === obj.time_utc && m.message === obj.message && String(m.sender_id) === String(obj.sender_id)));  
      await supabase.from('fwebaccount').update({ fchat_messages: JSON.stringify(filtered) }).eq('id', currentUser.id);  
      // also remove local instance if present  
      if(localMatch && localMatch.time_utc === obj.time_utc && localMatch.message === obj.message){  
        msgs.splice(index,1);  
        localStorage.setItem(storageKey, JSON.stringify(msgs));  
      }  
    } else {  
      // seen === true -> only remove from localStorage  
      if(localMatch && localMatch.time_utc === obj.time_utc && localMatch.message === obj.message){  
        msgs.splice(index,1);  
        localStorage.setItem(storageKey, JSON.stringify(msgs));  
      }  
    }  
    renderMessages();  
  }catch(err){  
    console.error("Delete failed:", err);  
  } finally {  
    hideContextMenu();  
  }  
});  
  
/* Close reply */  
closeReply.addEventListener('click', ()=>{ replyBox.style.display='none'; linkedMsg=null; });  
  
/* key handlers */  
sendBtn.addEventListener("click",sendMessage);  
chatInput.addEventListener("keypress",e=>{if(e.key==="Enter") sendMessage();});  
  
/* INITIAL load */  
window.addEventListener("load", async ()=>{  
  await loadChatUser();  
  renderMessages();  
  detectIncomingForCurrentChat(); // initial detection run  
});  
</script>  </body>  
</html>  
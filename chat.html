<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FCHAT</title>
</head>
<body>
<header>
  <div id="user-header">
    <img id="chat-pic" src="" alt="Profile" width="50" height="50">
    <span id="chat-name">Loading...</span>
  </div>
</header>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://pwsxezhugsxosbwhkdvf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ"
);

const chatNameEl = document.getElementById("chat-name");
const chatPicEl = document.getElementById("chat-pic");

const chatUserId = localStorage.getItem("chatting");
let chatUser = null;

async function loadChatUser() {
  if (!chatUserId) {
    chatNameEl.textContent = "No user selected";
    return;
  }

  // 1️⃣ Check localStorage first
  const allUsers = JSON.parse(localStorage.getItem("all_fwebaccounts")) || [];
  chatUser = allUsers.find(u => u.id == chatUserId);

  // 2️⃣ If not found, fetch from Supabase
  if (!chatUser) {
    const { data, error } = await supabase
      .from("fwebaccount")
      .select("id, username, profile_pic")
      .eq("id", chatUserId)
      .maybeSingle();

    if (error) {
      chatNameEl.textContent = "Error loading user";
      console.error(error);
      return;
    }

    if (!data) {
      chatNameEl.textContent = "User not found";
      return;
    }

    chatUser = data;

    // Save fetched user to localStorage for next load
    allUsers.push(chatUser);
    localStorage.setItem("all_fwebaccounts", JSON.stringify(allUsers));
  }

  // Display username and profile picture
  chatNameEl.textContent = chatUser.username || "Unknown User";
  chatPicEl.src = chatUser.profile_pic || "https://via.placeholder.com/50?text=U";
}

// Load on page start
window.addEventListener("load", loadChatUser);
</script>
</body>
</html>

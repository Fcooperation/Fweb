<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }

body {
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: white;
}

#chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
}

#chat-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background: black;
}

#chat-header .info {
  display: flex;
  flex-direction: column;
}

#chat-header .username {
  font-size: 16px;
  font-weight: bold;
}

#chat-header .status {
  font-size: 12px;
  color: #555;
}

#chat-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  max-width: 75%;
  padding: 14px 18px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.5;
  position: relative;
  word-break: break-word;
  min-height: 50px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: transform 0.2s ease;
}

.sent {
  align-self: flex-end;
  background: black;
  color: white;
  border-bottom-right-radius: 4px;
}

.received {
  align-self: flex-start;
  background: #f1f1f1;
  color: black;
  border-bottom-left-radius: 4px;
}

.pending { opacity: 0.6; }

.message-status {
  font-size: 11px;
  color: #888;
  margin-top: 4px;
  align-self: flex-end;
}

.linked {
  border-left: 3px solid #555;
  padding-left: 8px;
  margin-bottom: 4px;
  cursor: pointer;
  background: #e0e0e0;
  border-radius: 6px;
  font-size: 13px;
}

.linked span.username {
  font-weight: bold;
  display: block;
  margin-bottom: 2px;
}

.highlight {
  background: yellow;
  transition: background 1s ease;
}

#replying-banner {
  background: #e0f0ff;
  padding: 6px 12px;
  font-size: 13px;
  display: none;
  align-items: center;
  gap: 10px;
}

#replying-banner span { font-weight: bold; }

#replying-banner button {
  margin-left: auto;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

#chat-input {
  display: flex;
  gap: 10px;
  padding: 10px 16px;
  border-top: 1px solid #ddd;
}

#chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
}

#chat-input button {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
}
</style>
</head>

<body>

<div id="chat-header">
  <img id="chat-pic">
  <div class="info">
    <div class="username" id="chat-username"></div>
    <div class="status" id="chat-status"></div>
  </div>
</div>

<div id="replying-banner">
  Replying to <span id="replying-text"></span>
  <button id="cancel-reply">✖</button>
</div>

<div id="chat-body"></div>

<div id="chat-input">
  <input id="message-input" placeholder="Type a message…">
  <button id="send-btn">Send</button>
</div>

<script>
const API_URL = "https://fweb-backend.onrender.com/fchat";

const chatWith = JSON.parse(localStorage.getItem("chatting_with"));
const account = JSON.parse(localStorage.getItem("faccount")) || {};

document.getElementById("chat-username").textContent = chatWith.username;
document.getElementById("chat-status").textContent = chatWith.status;
document.getElementById("chat-pic").src = chatWith.profile_pic;

const STORAGE_KEY = "chat_messages_" + chatWith.id;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let replyingTo = null;

const replyBanner = document.getElementById("replying-banner");
const replyText = document.getElementById("replying-text");
document.getElementById("cancel-reply").onclick = () => {
  replyingTo = null;
  replyBanner.style.display = "none";
};

/* ✅ FIXED WHATSAPP-LIKE SWIPE */
function addSwipeListeners(el, msgId){
  let startX = 0, startY = 0;
  let isHorizontal = false;

  el.addEventListener("touchstart", e => {
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
    isHorizontal = false;
  }, { passive: true });

  el.addEventListener("touchmove", e => {
    const t = e.touches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;

    if (!isHorizontal && Math.abs(dx) > 15 && Math.abs(dx) > Math.abs(dy)) {
      isHorizontal = true;
    }

    if (isHorizontal) {
      e.preventDefault();
      el.style.transform = `translateX(${dx}px)`;
    }
  }, { passive: false });

  el.addEventListener("touchend", e => {
    const dx = e.changedTouches[0].clientX - startX;
    el.style.transform = "";

    if (dx < -60) {
      linkReply(msgId);
    }
  });
}

function renderMessages(){
  const box = document.getElementById("chat-body");
  box.innerHTML = "";
  messages.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message " + msg.type;
    div.textContent = msg.text;
    div.dataset.id = msg.id;

    if(msg.type !== "sent") addSwipeListeners(div, msg.id);
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

function linkReply(id){
  replyingTo = id;
  replyText.textContent = messages.find(m=>m.id===id)?.text || "";
  replyBanner.style.display = "flex";
}

renderMessages();
</script>
</body>
</html>

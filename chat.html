<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FCHAT - Real-time</title>
<style>
* { box-sizing: border-box; }
body { font-family: 'Poppins','Segoe UI',sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; background:#fdfdfd; }
header {background:#fff; display:flex; justify-content:space-between; align-items:center; padding:12px 18px; border-bottom:1px solid #eee; box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.header-left {display:flex; align-items:center;}
.chat-header-pic {width:45px; height:45px; border-radius:50%; margin-right:10px; background:#ccc;}
.chat-header-name {font-weight:600; font-size:18px;}
#chat-board {flex:1; padding:15px; overflow-y:auto; background:#fafafa; position:relative;}
.message {padding:10px 15px; border-radius:14px; margin-bottom:10px; max-width:80%; word-wrap:break-word; position:relative;}
.me {background:#c2ffc2; margin-left:auto;}
.other {background:#d8c5a0; margin-right:auto;}
.status {font-size:11px; color:#555; margin-top:2px; text-align:right;}
.log {font-size:12px; color:#999; text-align:center; margin:5px 0;}
#chat-input-area {display:flex; align-items:center; padding:10px 14px; border-top:1px solid #ddd; background:#fff;}
#chat-input {flex:1; border:1px solid #ccc; border-radius:25px; padding:10px 15px; font-size:15px; outline:none; background:#f7f7f7; transition:0.2s;}
#chat-input:focus {background:#fff; border-color:#999;}
#send-btn {background:#007bff; border:none; color:#fff; font-size:20px; border-radius:50%; width:40px; height:40px; margin-left:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;}
#send-btn:hover {background:#0066d6;}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <img id="chat-pic" class="chat-header-pic" src="" alt="Profile">
    <div class="chat-header-name" id="chat-name">Loading...</div>
  </div>
</header>

<div id="chat-board"></div>

<div id="chat-input-area">
  <input type="text" id="chat-input" placeholder="Type a message...">
  <button id="send-btn">âž¤</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// --- Supabase config ---
const supabaseUrl = "https://pwsxezhugsxosbwhkdvf.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c3hlemh1Z3N4b3Nid2hrZHZmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTkyODM4NywiZXhwIjoyMDY3NTA0Mzg3fQ.u7lU9gAE-hbFprFIDXQlep4q2bhjj0QdlxXF-kylVBQ";
const supabase = createClient(supabaseUrl, supabaseKey);

const chatBoard = document.getElementById('chat-board');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const chatName = document.getElementById('chat-name');
const chatPic = document.getElementById('chat-pic');

const chatUserId = localStorage.getItem('chatting') || 'user2';
const currentUser = JSON.parse(localStorage.getItem('faccount')) || {id:'me', username:'Me'};

// --- Load chat user ---
async function loadChatUser() {
    const allUsers = JSON.parse(localStorage.getItem("all_fwebaccounts")) || [];
    let chatUser = allUsers.find(u=>u.id === chatUserId);
    if(!chatUser) chatUser = {id:chatUserId, username:"Friend", profile_pic:""};
    chatName.textContent = chatUser.username;
    chatPic.src = chatUser.profile_pic || "https://via.placeholder.com/50?text=U";
}

// --- Render messages ---
function renderMessages(messages) {
    chatBoard.innerHTML = "";
    messages.forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("message");
        div.classList.add(msg.sender === currentUser.id ? "me" : "other");
        div.textContent = msg.text;

        if(msg.sender === currentUser.id){
            const statusDiv = document.createElement("div");
            statusDiv.classList.add("status");
            statusDiv.textContent = msg.seen ? "Seen" : "Sent";
            div.appendChild(statusDiv);
        }
        chatBoard.appendChild(div);
    });
    chatBoard.scrollTop = chatBoard.scrollHeight;
}

// --- Add log message ---
function addLog(text){
    const logDiv = document.createElement("div");
    logDiv.classList.add("log");
    logDiv.textContent = text;
    chatBoard.appendChild(logDiv);
    chatBoard.scrollTop = chatBoard.scrollHeight;
}

// --- Fetch existing messages ---
async function fetchMessages() {
    addLog("Accessing Supabase...");
    const { data, error } = await supabase
        .from('fchat')
        .select('*')
        .or(`sender.eq.${currentUser.id},receiver.eq.${currentUser.id}`)
        .order('time', { ascending:true });

    if(error){ addLog("Error fetching messages"); return; }
    addLog("Retrieved messages");

    // Map data to messages with seen info
    const messages = data.map(m => ({
        text: m.text,
        sender: m.sender,
        receiver: m.receiver,
        time: m.time,
        seen: m.seen
    }));
    renderMessages(messages);
}

// --- Send message ---
async function sendMessage() {
    const text = chatInput.value.trim();
    if(!text) return;

    const message = {
        text, 
        sender: currentUser.id, 
        receiver: chatUserId, 
        time: Date.now(), 
        seen:false
    };

    addLog("Sending message...");
    const { error } = await supabase.from('fchat').insert(message);
    if(error){ addLog("Error sending message"); return; }
    chatInput.value = "";
    addLog("Message sent");
}

// --- Listen to realtime messages ---
supabase.channel('public:fchat')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'fchat' }, payload => {
        const msg = payload.new;
        // Only messages between these two users
        if((msg.sender === currentUser.id && msg.receiver === chatUserId) || (msg.sender === chatUserId && msg.receiver === currentUser.id)){
            addLog(`New message from ${msg.sender===currentUser.id?"You":"Friend"}`);
            fetchMessages();
        }

        // Mark messages received as seen
        if(msg.sender === chatUserId && msg.receiver === currentUser.id){
            supabase.from('fchat').update({ seen:true }).eq('id', msg.id).then(()=>{ addLog("Marked as seen"); });
        }
    })
    .subscribe();

// --- Events ---
sendBtn.addEventListener("click", sendMessage);
chatInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

window.addEventListener("load", async () => {
    await loadChatUser();
    await fetchMessages();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: white;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#chat-header {
  position: sticky;
  top: 0;
  background: white;
  border-bottom: 1px solid #ddd;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 10;
}

#left-box {
  display: flex;
  align-items: center;
  gap: 12px;
}

#back-btn {
  font-size: 22px;
  cursor: pointer;
  user-select: none;
}

#profile-pic {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  background: black;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

#center-info {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
}

#chat-username {
  font-size: 16px;
  font-weight: bold;
}

#chat-id {
  font-size: 12px;
  color: #555;
}

#chat-body {
  flex: 1;
  padding: 14px;
  overflow-y: auto;
}

.message {
  max-width: 75%;
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 8px;
  font-size: 14px;
}

.sent {
  background: black;
  color: white;
  margin-left: auto;
}

.received {
  background: #eee;
  color: black;
}

#chat-input {
  position: sticky;
  bottom: 0;
  background: white;
  border-top: 1px solid #ddd;
  padding: 12px;
  display: flex;
  gap: 8px;
}

#messageInput {
  flex: 1;
  padding: 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#sendBtn {
  padding: 10px 16px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
  border-radius: 6px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div id="chat-header">
  <div id="left-box">
    <div id="back-btn" onclick="goBack()">←</div>
    <div id="profile-pic"></div>
  </div>

  <div id="center-info">
    <div id="chat-username">Username</div>
    <div id="chat-id">ID</div>
  </div>
</div>

<!-- CHAT BODY -->
<div id="chat-body"></div>

<!-- INPUT -->
<div id="chat-input">
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button id="sendBtn">Send</button>
</div>

<script>
/* -------------------- CONFIG & STORAGE -------------------- */
const API_URL = "https://fweb-backend.onrender.com/fchat";
const account = JSON.parse(localStorage.getItem("faccount")) || {};
const chatWith = JSON.parse(localStorage.getItem("chatting_with")) || {};

if (!chatWith || !chatWith.id) {
  alert("No chat selected");
  window.location.href = "fchat.html";
}

const STORAGE_KEY = `chat_${account.email}_${chatWith.id}`;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

const FCHAT_STORAGE_KEY = `fchat_messages_${account.email}`;
let fchatMessages = JSON.parse(localStorage.getItem(FCHAT_STORAGE_KEY)) || [];

/* -------------------- HEADER -------------------- */
document.getElementById("chat-username").textContent = chatWith.username || "User";
document.getElementById("chat-id").textContent = "ID: " + (chatWith.id || "");

const profilePic = document.getElementById("profile-pic");
if (chatWith.profile_pic) {
  profilePic.style.backgroundImage = `url('${chatWith.profile_pic}')`;
  profilePic.style.backgroundSize = "cover";
  profilePic.style.backgroundPosition = "center";
} else {
  const initials = (chatWith.username || "U").split(" ").map(w=>w[0]).join("").toUpperCase();
  profilePic.textContent = initials;
}

/* -------------------- TIMELINE -------------------- */
const chatBody = document.getElementById("chat-body");

function updateTimeline() {
  chatBody.innerHTML = "";
  messages.forEach(m => addMessage(m.text, m.type || (m.sender_id === account.id ? "sent" : "received")));
}

function addMessage(text, type) {
  const msg = document.createElement("div");
  msg.className = "message " + type;
  msg.textContent = text;
  chatBody.appendChild(msg);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* -------------------- SYNC TO FCHAT -------------------- */
function syncToFChat() {
  messages.forEach(m => {
    if (!fchatMessages.some(fm => fm.id === m.id)) {
      fchatMessages.push(m);
    }
  });

  fchatMessages.sort((a, b) => new Date(a.sent_at) - new Date(b.sent_at));
  localStorage.setItem(FCHAT_STORAGE_KEY, JSON.stringify(fchatMessages));
}

/* -------------------- SEND TO BACKEND -------------------- */
async function sendToBackend(msgObj) {
  try {
    const payload = {
      action: "send_messages",
      email: account.email,
      id: msgObj.id,
      sender_id: account.id,
      receiver_id: chatWith.id,
      linked: msgObj.linked,
      linked_message_id: msgObj.linked_message_id,
      sent_at: msgObj.sent_at,
      text: msgObj.text
    };

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      msgObj.status = "sent";
      msgObj.sending_since = null;
    } else {
      msgObj.status = "pending";
    }
  } catch (e) {
    msgObj.status = "pending";
    msgObj.sending_since = null;
    console.warn("Failed to send, message pending", e);
  }

  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  syncToFChat(); // update fchat_messages after backend
  updateTimeline();
}

/* -------------------- SEND MESSAGE -------------------- */
let replyingMessage = null;

function sendMessage() {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text) return;

  const msgObj = {
    id: Date.now(),
    type: "sent",
    text,
    sent_at: new Date().toISOString(),
    status: navigator.onLine ? "sending" : "pending",
    sending_since: navigator.onLine ? Date.now() : null,
    replyTo: replyingMessage ? {
      id: replyingMessage.id,
      text: replyingMessage.text.slice(0,80) + (replyingMessage.text.length > 80 ? "…" : ""),
      sender: replyingMessage.sender_id
    } : null,
    linked: replyingMessage ? true : false,
    linked_message_id: replyingMessage ? replyingMessage.id : null,
    sender_id: account.id,
    receiver_id: chatWith.id
  };

  messages.push(msgObj);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));

  // SYNC TO FCHAT
  syncToFChat();

  input.value = "";
  replyingMessage = null;

  updateTimeline();

  if (navigator.onLine) sendToBackend(msgObj);
}

document.getElementById("sendBtn").onclick = sendMessage;

/* -------------------- BACK -------------------- */
function goBack() {
  window.location.href = "fchat.html";
}

// Initial render
updateTimeline();
// Sync existing messages on page load
syncToFChat();
</script>

</body>
</html>
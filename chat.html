<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Swipe Reply</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }

body {
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: white;
}

#chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
}

#chat-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background: black;
}

#chat-header .info { display: flex; flex-direction: column; }
#chat-header .username { font-size: 16px; font-weight: bold; }
#chat-header .status { font-size: 12px; color: #555; }

#chat-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  touch-action: pan-y;
  user-select: none;
  transition: transform 0.2s ease;
}

.sent {
  align-self: flex-end;
  background: black;
  color: white;
  border-bottom-right-radius: 4px;
}

.received {
  align-self: flex-start;
  background: #f1f1f1;
  color: black;
  border-bottom-left-radius: 4px;
}

.pending { opacity: 0.6; }

#reply-preview {
  display: none;
  padding: 6px 12px;
  border-left: 4px solid #555;
  background: #f5f5f5;
  font-size: 13px;
  margin-bottom: 6px;
}

#reply-preview .sender { font-weight: bold; font-size: 12px; margin-bottom: 2px; }

#chat-input {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 10px 16px;
  border-top: 1px solid #ddd;
}

#chat-input-bar { display: flex; gap: 10px; }

#chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
}

#chat-input button {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>
<body>

<div id="chat-header">
  <img id="chat-pic" src="">
  <div class="info">
    <div class="username" id="chat-username">Loading...</div>
    <div class="status" id="chat-status">Status...</div>
  </div>
</div>

<div id="chat-body"></div>

<div id="chat-input">
  <div id="reply-preview">
    <div class="sender"></div>
    <div class="text"></div>
  </div>
  <div id="chat-input-bar">
    <input type="text" id="message-input" placeholder="Type a messageâ€¦">
    <button id="send-btn">Send</button>
  </div>
</div>

<script>
const API_URL = "https://fweb-backend.onrender.com/fchat";
const chatWith = JSON.parse(localStorage.getItem("chatting_with")) || null;
const account = JSON.parse(localStorage.getItem("faccount")) || {email:"", password:""};

if (!chatWith || !chatWith.id) {
  alert("No chat selected");
  window.location.href = "fchat.html";
}

document.getElementById("chat-username").textContent = chatWith.username || "Unknown";
document.getElementById("chat-status").textContent = chatWith.status || "";
document.getElementById("chat-pic").src = chatWith.profile_pic || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9zdmc+";

header.onclick = () => {
  localStorage.setItem("chat_viewing", JSON.stringify({
    id: chatWith.id,
    username: chatWith.username || "",
    profile_pic: chatWith.profile_pic || "",
    status: chatWith.status || ""
  }));
  window.location.href = "chatdashboard.html";
};

const STORAGE_KEY = "chat_messages_" + chatWith.id;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let replyingTo = null;

const replyPreview = document.getElementById("reply-preview");
const replySender = replyPreview.querySelector(".sender");
const replyText = replyPreview.querySelector(".text");

function renderMessages() {
  const box = document.getElementById("chat-body");
  box.innerHTML = "";
  
  messages.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message " + msg.type + (msg.status==="pending"?" pending":"");
    div.textContent = msg.text;

    // --- swipe to reply ---
    let startX = 0, currentX = 0, moved = false;
    const threshold = 50; // px
    
    div.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
      moved = false;
    });
    div.addEventListener("touchmove", e => {
      currentX = e.touches[0].clientX;
      let delta = currentX - startX;
      if(delta > 0){ // only swipe right
        div.style.transform = `translateX(${delta}px)`;
        moved = true;
      }
    });
    div.addEventListener("touchend", e => {
      let delta = currentX - startX;
      if(delta > threshold){
        // trigger reply
        replyingTo = msg;
        replySender.textContent = msg.type==="sent"?"You":chatWith.username;
        replyText.textContent = msg.text;
        replyPreview.style.display = "block";
      }
      // reset
      div.style.transform = "translateX(0)";
    });

    box.appendChild(div);
  });
  scrollToBottom();
}

function scrollToBottom() {
  const box = document.getElementById("chat-body");
  box.scrollTop = box.scrollHeight;
}

async function sendToBackend(msgObj) {
  try {
    const payload = {
      action: "send_messages",
      email: account.email,
      id: msgObj.id,
      sender_id: account.email,
      receiver_id: chatWith.id,
      linked: !!msgObj.linked_message_id,
      linked_message_id: msgObj.linked_message_id || null,
      sent_at: new Date().toISOString(),
      text: msgObj.text
    };
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      msgObj.status = "sent";
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();
      replyingTo = null;
      replyPreview.style.display = "none";
    }
  } catch(e) {
    console.warn("Failed to send, message pending");
    msgObj.status = "pending";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    renderMessages();
  }
}

function sendMessage() {
  const input = document.getElementById("message-input");
  const text = input.value.trim();
  if(!text) return;

  const msgObj = {
    id: Date.now(),
    type: "sent",
    text,
    status: navigator.onLine ? "sending" : "pending",
    linked_message_id: replyingTo ? replyingTo.id : null
  };
  messages.push(msgObj);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  input.value = "";
  renderMessages();

  if(navigator.onLine){
    sendToBackend(msgObj);
  } else {
    replyingTo = null;
    replyPreview.style.display = "none";
  }
}

async function retryPending() {
  if(!navigator.onLine) return;
  for(const msg of messages){
    if(msg.status === "pending" || msg.status==="sending"){
      msg.status = "sending";
      await sendToBackend(msg);
    }
  }
}

window.addEventListener("online", retryPending);

renderMessages();
document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").addEventListener("keydown", e => {
  if(e.key === "Enter") sendMessage();
});
</script>

</body>
  </html>

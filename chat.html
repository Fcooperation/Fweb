<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
/* ---------- RESET ---------- */
* { box-sizing: border-box; margin:0; padding:0; }

/* ---------- BODY ---------- */
body {
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: white;
}

/* ---------- TOP BAR ---------- */
#chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
}

#chat-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background: black;
}

#chat-header .info {
  display: flex;
  flex-direction: column;
}

#chat-header .username {
  font-size: 16px;
  font-weight: bold;
}

#chat-header .status {
  font-size: 12px;
  color: #555;
}

/* ---------- CHAT BODY ---------- */
#chat-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ---------- MESSAGE BUBBLES ---------- */.message {
  max-width: 85%;          /* longer like WhatsApp */
  padding: 12px 18px;      /* bigger touch area */
  touch-action: pan-y;     /* allows horizontal swipe */
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  transition: transform 0.2s ease;
}


.sent {
  align-self: flex-end;
  background: black;
  color: white;
  border-bottom-right-radius: 4px;
}

.received {
  align-self: flex-start;
  background: #f1f1f1;
  color: black;
  border-bottom-left-radius: 4px;
}

.pending {
  opacity: 0.6;
}

/* ---------- INPUT BAR ---------- */
#chat-input {
  display: flex;
  gap: 10px;
  padding: 10px 16px;
  border-top: 1px solid #ddd;
}

#chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
}

#chat-input button {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
#reply-preview {
  border-top: 1px solid #ddd;
}
#reply-preview {
  display: flex;
}
#cancel-reply {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: #e0e0e0;
  color: #333;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

#cancel-reply:active {
  background: #ccc;
}
/* ---------- MESSAGE STATUS ---------- */
.status-text {
  font-size: 11px;
  margin-top: 4px;
  text-align: right;
  opacity: 0.85;
}

.status-sending {
  color: grey;
}

.status-pending {
  color: orange;
}

.status-sent {
  color: #1e88e5; /* WhatsApp-like blue */
}
.pending {
  opacity: 0.6;
}
/* ---------- MESSAGE TIME ---------- */
.message-time {
  font-weight: bold;
  font-style: italic;
  margin-right: 6px;
}
.message:active {
  opacity: 0.7;
}
.message.highlight {
  animation: megaGlow 2s ease-out 1;
}

@keyframes megaGlow {
  0% {
    box-shadow:
      0 0 0 4px #1e88e5,
      0 0 25px 10px rgba(30,136,229,1),
      0 0 50px 18px rgba(30,136,229,0.9),
      0 0 80px 30px rgba(30,136,229,0.7);
  }
  100% {
    box-shadow: none;
  }
}
/* ---------- MULTI-SELECT MODE ---------- */
.message.multi-selected {
  background-color: rgba(30, 136, 229, 0.2);
  border: 2px solid #1e88e5;
}

#multi-select-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: white;
  border-bottom: 1px solid #ddd;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0 16px;
  z-index: 1000;
  display: none; /* hidden by default */
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

#multi-select-bar img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

#multi-select-bar .username {
  font-weight: bold;
  font-size: 16px;
}

#multi-select-bar .close-selection {
  margin-left: auto;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
}
</style>
</head>
<body>

<!-- ---------- HEADER ---------- -->
<div id="chat-header">
  <img id="chat-pic" src="">
  <div class="info">
    <div class="username" id="chat-username">Loading...</div>
    <div class="status" id="chat-status">Status...</div>
  </div>
</div>
<div id="multi-select-bar">
  <img id="multi-select-pic" src="">
  <div class="username" id="multi-select-username"></div>
  <div class="close-selection" id="close-selection">âœ•</div>
</div>

<!-- ---------- MESSAGES ---------- -->
<div id="chat-body"></div>

<!-- ---------- REPLY PREVIEW ---------- -->
<div id="reply-preview" style="display:none; padding:8px 16px; background:#f1f1f1; border-left:4px solid #007bff; justify-content:space-between; align-items:center; gap:10px;">
  
  <div>
    <div id="reply-sender" style="font-weight:bold; font-size:12px;"></div>
    <div id="reply-text" style="font-size:14px; color:#555;"></div>
  </div>
<button id="cancel-reply" aria-label="Cancel reply">âœ•</button>
</div>

<!-- ---------- INPUT ---------- -->
<div id="chat-input">
  <input type="text" id="message-input" placeholder="Type a messageâ€¦">
  <button id="send-btn">Send</button>
</div>

<script>
const API_URL = "https://fweb-backend.onrender.com/fchat";

/* ---------- LOAD CHAT TARGET ---------- */
const chatWith = JSON.parse(localStorage.getItem("chatting_with")) || null;
const account = JSON.parse(localStorage.getItem("faccount")) || {email:"", password:""};

if (!chatWith || !chatWith.id) {
  alert("No chat selected");
  window.location.href = "fchat.html";
}

/* ---------- HEADER DATA ---------- */
const header = document.getElementById("chat-header");
document.getElementById("chat-username").textContent = chatWith.username || "Unknown";
document.getElementById("chat-status").textContent = chatWith.status || "";
document.getElementById("chat-pic").src = chatWith.profile_pic || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9zdmc+";

/* ---------- HEADER CLICK TO DASHBOARD ---------- */
header.onclick = () => {
  localStorage.setItem("chat_viewing", JSON.stringify({
    id: chatWith.id,
    username: chatWith.username || "",
    profile_pic: chatWith.profile_pic || "",
    status: chatWith.status || ""
  }));
  window.location.href = "chatdashboard.html";
};

/* ---------- MESSAGE STORAGE ---------- */
const STORAGE_KEY = "chat_messages_" + chatWith.id;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

function formatMessageTime(sentAt) {
  if (!sentAt) return "";

  const date = new Date(sentAt);
  const now = new Date();

  const isToday =
    date.toDateString() === now.toDateString();

  const yesterday = new Date();
  yesterday.setDate(now.getDate() - 1);

  const isYesterday =
    date.toDateString() === yesterday.toDateString();

  const time = date.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });

  if (isToday) {
    return time;
  }

  const dayMonth = date.toLocaleDateString([], {
    day: "2-digit",
    month: "short"
  });

  return `${dayMonth} ${time}`;
}

/* ---------- RENDER MESSAGES ---------- */
function renderMessages() {
  const box = document.getElementById("chat-body");
  box.innerHTML = "";
  messages.forEach(msg => {
  const div = document.createElement("div");
  div.className = "message " + msg.type + (msg.status==="pending"?" pending":"");
  
  if (msg.replyTo) {
  const replyBox = document.createElement("div");
  replyBox.style.borderLeft = "3px solid #007bff";
  replyBox.style.padding = "4px 8px";
  replyBox.style.marginBottom = "6px";
  replyBox.style.fontSize = "12px";
  replyBox.style.opacity = "0.8";

  replyBox.innerHTML = `
    <strong>${msg.replyTo.sender}</strong><br>
    ${msg.replyTo.text}
  `;

  div.appendChild(replyBox);
}

const textNode = document.createElement("div");
textNode.textContent = msg.text;
div.appendChild(textNode);

/* ---------- STATUS TEXT (only for sent messages) ---------- */
if (msg.type === "sent") {
  const status = document.createElement("div");
  status.classList.add("status-text");

  const timeSpan = document.createElement("span");
  timeSpan.classList.add("message-time");
  timeSpan.textContent = formatMessageTime(msg.sent_at);

  status.appendChild(timeSpan);

  if (msg.status === "sending") {
    status.append("Sendingâ€¦");
    status.classList.add("status-sending");
  } 
  else if (msg.status === "pending") {
    status.append("Pending");
    status.classList.add("status-pending");
  } 
  else if (msg.status === "sent") {
    status.append("Sent");
    status.classList.add("status-sent");
  }

  div.appendChild(status);
}
  // ðŸ”‘ link DOM to message data
  div.dataset.id = msg.id;

  box.appendChild(div);
});
  scrollToBottom();
  enableMessageTap();
}
function enableMessageTap() {
  const allMessages = document.querySelectorAll(".message");

  allMessages.forEach(msgEl => {
    msgEl.onclick = () => {
      const msgId = msgEl.dataset.id;
      const msgData = messages.find(m => m.id == msgId);

      if (!msgData) return;

      // âŒ Not linked â†’ do nothing
      if (!msgData.linked || !msgData.linked_message_id) return;

      // âœ… Linked â†’ find original message
      const linkedEl = document.querySelector(
        `.message[data-id='${msgData.linked_message_id}']`
      );

      if (!linkedEl) return;

      // Scroll to original
      linkedEl.scrollIntoView({
  behavior: "smooth",
  block: "center"
});

// wait for scroll to settle before glowing
setTimeout(() => {
  linkedEl.classList.add("highlight");

  setTimeout(() => {
    linkedEl.classList.remove("highlight");
  }, 2000);

}, 350); // â† delay controls when glow starts
    };
  });
}

let multiSelectMode = false;
let selectedMessages = [];

const multiBar = document.getElementById("multi-select-bar");
const multiPic = document.getElementById("multi-select-pic");
const multiUsername = document.getElementById("multi-select-username");
const closeSelection = document.getElementById("close-selection");

// Initialize dashboard with chat user info
multiPic.src = chatWith.profile_pic || '';
multiUsername.textContent = chatWith.username || '';

// Function to enter multi-select mode
function enterMultiSelect(msgEl) {
  multiSelectMode = true;
  multiBar.style.display = "flex";
  toggleMessageSelection(msgEl);
}

// Function to exit multi-select mode
function exitMultiSelect() {
  multiSelectMode = false;
  selectedMessages.forEach(el => el.classList.remove("multi-selected"));
  selectedMessages = [];
  multiBar.style.display = "none";
}

// Toggle selection on a message
function toggleMessageSelection(msgEl) {
  if (selectedMessages.includes(msgEl)) {
    msgEl.classList.remove("multi-selected");
    selectedMessages = selectedMessages.filter(m => m !== msgEl);
  } else {
    msgEl.classList.add("multi-selected");
    selectedMessages.push(msgEl);
  }
}

// Add long-press / double-tap listeners
function enableMultiSelect() {
  const allMessages = document.querySelectorAll(".message");
  allMessages.forEach(msgEl => {
    let tapTimer = null;
    let longPress = false;

    // LONG PRESS
    msgEl.addEventListener("touchstart", e => {
      longPress = false;
      tapTimer = setTimeout(() => {
        longPress = true;
        enterMultiSelect(msgEl);
      }, 500); // 500ms long press
    });
    msgEl.addEventListener("touchend", e => {
      clearTimeout(tapTimer);
      if (!longPress && multiSelectMode) {
        toggleMessageSelection(msgEl);
      }
    });

    // DOUBLE TAP (desktop alternative)
    msgEl.addEventListener("dblclick", e => {
      if (!multiSelectMode) enterMultiSelect(msgEl);
      else toggleMessageSelection(msgEl);
    });

    // TAP to select when already in multi-select
    msgEl.addEventListener("click", e => {
      if (multiSelectMode) toggleMessageSelection(msgEl);
    });
  });
}

// Close multi-select bar
closeSelection.addEventListener("click", exitMultiSelect);

// Re-enable multi-select after messages re-render
function renderMessagesWithMultiSelect() {
  renderMessages();
  enableMultiSelect();
}

// Replace all calls to renderMessages() with renderMessagesWithMultiSelect() in your code
renderMessagesWithMultiSelect();

let startX = 0;
let currentMsg = null;
let replyingMessage = null;
document.getElementById("cancel-reply").onclick = () => {
  replyingMessage = null;
  document.getElementById("reply-preview").style.display = "none";
};

function getReplySenderName(msg) {
  return msg.type === "sent" ? "You" : chatWith.username;
}
function scrollToInput() {
  const inputBar = document.getElementById("chat-input");
  inputBar.scrollIntoView({ behavior: "smooth", block: "end" });
}

document.getElementById("chat-body").addEventListener("touchstart", e => {
  const msg = e.target.closest(".message");
  if (!msg) return;

  startX = e.touches[0].clientX;
  currentMsg = msg;
});

document.getElementById("chat-body").addEventListener("touchmove", e => {
  if (!currentMsg) return;

  const moveX = e.touches[0].clientX;
  const diffX = moveX - startX;

  // Move message slightly with finger
  if (diffX > 0 && diffX < 80) {
    currentMsg.style.transform = `translateX(${diffX}px)`;
  }
});

document.getElementById("chat-body").addEventListener("touchend", e => {
  if (!currentMsg) return;

  const endX = e.changedTouches[0].clientX;
  const diffX = endX - startX;

  // Reset position
  currentMsg.style.transform = "translateX(0)";
  
  

  if (diffX > 50) {
  const msgId = currentMsg.dataset.id;
  const msgData = messages.find(m => m.id == msgId);

  if (msgData) {
  replyingMessage = msgData;

  document.getElementById("reply-sender").textContent = getReplySenderName(msgData);
  document.getElementById("reply-text").textContent = msgData.text;

  document.getElementById("reply-preview").style.display = "block";

  scrollToInput();

  const input = document.getElementById("message-input");
  setTimeout(() => input.focus(), 150);

    
  }
}

  currentMsg = null;
});

/* ---------- SCROLL ---------- */
function scrollToBottom() {
  const box = document.getElementById("chat-body");
  box.scrollTop = box.scrollHeight;
}

/* ---------- SEND TO BACKEND ---------- */
async function sendToBackend(msgObj) {
  try {
    const payload = {  
  action: "send_messages",  
  email: account.email,  
  id: msgObj.id,  
  sender_id: account.email,  
  receiver_id: chatWith.id,  
  linked: msgObj.linked,
  linked_message_id: msgObj.linked_message_id,
  sent_at: msgObj.sent_at,
  text: msgObj.text  
};
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      msgObj.status = "sent";
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();
    }
  } catch(e) {
    console.warn("Failed to send, message pending");
    msgObj.status = "pending";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    renderMessages();
  }
}

/* ---------- SEND MESSAGE ---------- */
function sendMessage() {
  const input = document.getElementById("message-input");
  const text = input.value.trim();
  if(!text) return;

  const msgObj = {
  id: Date.now(),
  type: "sent",
  text,
  sent_at: new Date().toISOString(),
  status: navigator.onLine ? "sending" : "pending",
  replyTo: replyingMessage
    ? {
        id: replyingMessage.id,
        text: replyingMessage.text,
        sender: getReplySenderName(replyingMessage)
      }
    : null,
  linked: replyingMessage ? true : false,
  linked_message_id: replyingMessage ? replyingMessage.id : null
};
  messages.push(msgObj);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  input.value = "";
  renderMessages();
  
  replyingMessage = null;
document.getElementById("reply-preview").style.display = "none";

  if(navigator.onLine){
    sendToBackend(msgObj);
  }
}

/* ---------- RETRY PENDING MESSAGES ---------- */
async function retryPending() {
  if(!navigator.onLine) return;
  for(const msg of messages){
    if(msg.status === "pending" || msg.status==="sending"){
      msg.status = "sending";
      await sendToBackend(msg);
    }
  }
}

window.addEventListener("online", retryPending);

/* ---------- INIT ---------- */
renderMessages();

document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").addEventListener("keydown", e => {
  if(e.key === "Enter") sendMessage();
});
</script>

</body>
</html>
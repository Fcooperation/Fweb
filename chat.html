<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>FCHAT - Chat</title>
<style>
*{box-sizing:border-box;}
body{
  font-family:'Poppins','Segoe UI',sans-serif;
  background:#fdfdfd;color:#111;margin:0;height:100vh;
  display:flex;flex-direction:column;
}
header{
  background:#fff;display:flex;flex-direction:column;align-items:flex-start;
  padding:12px 18px;border-bottom:1px solid #eee;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
  position:relative;
}
.header-top{display:flex;justify-content:space-between;align-items:center;width:100%;}
.header-left{display:flex;align-items:center;}
.chat-header-pic{width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:10px;background:#ccc;}
.chat-header-name{font-weight:600;font-size:18px;cursor:pointer;}
#banner{
  position:absolute;bottom:-25px;left:0;width:100%;
  text-align:center;font-size:13px;padding:4px 0;
  background:#e0f2ff;color:#007bff;display:none;
}
#chat-board{flex:1;background:#fafafa;overflow-y:auto;padding:15px;display:flex;flex-direction:column;}
.message{
  background:#ececec;color:#000;padding:10px 15px;border-radius:14px;
  margin-bottom:10px;max-width:75%;word-wrap:break-word;position:relative;
  align-self:flex-start;cursor:pointer;transition:background 0.2s, transform 0.2s;
}
.message.me{background:#c2ffc2;align-self:flex-end;}
.message:hover{background:#e4e4e4;}
.msg-time{display:block;text-align:right;font-size:11px;color:#555;margin-top:3px;}
.linked-box{background:rgba(0,0,0,0.05);border-left:3px solid #007bff;
  padding:5px 8px;border-radius:5px;font-size:13px;margin-bottom:5px;cursor:pointer;}
#reply-box{
  background:#f1f1f1;padding:6px 12px;font-size:13px;border-left:3px solid #007bff;
  display:none;align-items:center;justify-content:space-between;
}
#reply-box span{flex:1;}
#reply-box button{background:transparent;border:none;font-size:18px;cursor:pointer;}
#chat-input-area{
  display:flex;flex-direction:column;border-top:1px solid #ddd;
  background:#fff;position:sticky;bottom:0;
}
#chat-input-row{display:flex;align-items:center;padding:10px 14px;}
#chat-input{
  flex:1;border:1px solid #ccc;border-radius:25px;padding:10px 15px;
  font-size:15px;outline:none;background:#f7f7f7;transition:0.2s;
}
#chat-input:focus{background:#fff;border-color:#999;}
#send-btn{
  background:#007bff;border:none;color:#fff;font-size:20px;border-radius:50%;
  width:42px;height:42px;margin-left:8px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
#send-btn:hover{background:#0066d6;}
#loading{text-align:center;padding:20px;color:#777;}
.context-menu{
  position:absolute;background:#fff;border:1px solid #ccc;
  box-shadow:0 2px 8px rgba(0,0,0,0.15);border-radius:6px;
  z-index:1000;display:none;flex-direction:column;min-width:100px;
}
.context-menu button{
  background:none;border:none;text-align:left;padding:8px 12px;
  width:100%;cursor:pointer;font-size:14px;
}
.context-menu button:hover{background:#eee;}
.message.swiping{ transform: translateX(18px) scale(1.01); box-shadow:0 4px 12px rgba(0,0,0,0.06);}
.msg-status { display:block; font-size:11px; color:#444; margin-top:4px; text-align:right;}
</style>
</head>
<body>
<header>
  <div class="header-top" id="chat-header">
    <div class="header-left">
      <img id="chat-pic" class="chat-header-pic" src="" alt="Profile">
      <div class="chat-header-name" id="chat-name">Loading...</div>
    </div>
  </div>
  <div id="banner"></div>
</header>

<div id="chat-board"><div id="loading">Loading chat...</div></div>

<div id="chat-input-area">
  <div id="reply-box"><span></span><button id="close-reply">×</button></div>
  <div id="chat-input-row">
    <input type="text" id="chat-input" placeholder="Type a message...">
    <button id="send-btn">➤</button>
  </div>
</div>

<div id="menu" class="context-menu">
  <button id="delete-msg">Delete</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://pwsxezhugsxosbwhkdvf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

const chatBoard=document.getElementById('chat-board');
const chatInput=document.getElementById('chat-input');
const sendBtn=document.getElementById('send-btn');
const chatName=document.getElementById('chat-name');
const chatPic=document.getElementById('chat-pic');
const replyBox=document.getElementById('reply-box');
const replyText=replyBox.querySelector('span');
const closeReply=document.getElementById('close-reply');
const menu=document.getElementById('menu');
const deleteBtn=document.getElementById('delete-msg');
const banner=document.getElementById('banner');

const chatUserId=localStorage.getItem('chatting');
const currentUser=JSON.parse(localStorage.getItem('faccount'));
const storageKey=`chat_messages_${chatUserId}`;
let linkedMsg=null;
let selectedMsg=null;
let longPressTimer=null;
let touchStartX=0;
let touchMoved=false;

if(!currentUser||!chatUserId) throw new Error("Missing info");

// -------- LOAD CHAT USER ----------
async function loadChatUser(){
  const {data}=await supabase.from('fwebaccount').select('*').eq('id',chatUserId).maybeSingle();
  chatName.textContent=data?.username||"Unknown";
  chatPic.src=data?.profile_pic||"https://via.placeholder.com/50?text=U";
}

// -------- RENDER ----------
function renderMessages(){
  const msgs=JSON.parse(localStorage.getItem(storageKey))||[];
  chatBoard.innerHTML="";
  if(msgs.length===0){chatBoard.innerHTML="<div id='loading'>No messages yet.</div>";return;}
  msgs.forEach((m,i)=>{
    const div=document.createElement("div");
    div.classList.add("message");
    if(m.sender==="me")div.classList.add("me");
    div.dataset.index=i;
    div.innerHTML=`${m.linked?`<div class='linked-box' data-linked-time='${m.linked_message_time}'>${escapeHtml(m.linked_message)}</div>`:""}
                   <div class='msg-text'>${escapeHtml(m.message)}</div>
                   <span class='msg-time'>${formatTime(m.time_utc)}</span>
                   <span class='msg-status'>${m.status||""}</span>`;
    attachHandlers(div,m,i);
    chatBoard.appendChild(div);
  });
  chatBoard.scrollTop=chatBoard.scrollHeight;
}

function escapeHtml(s){return s?s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])):"";}
function formatTime(t){const d=new Date(t);return d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});}

// -------- SEND ----------
async function sendMessage(){
  const text=chatInput.value.trim();if(!text)return;
  const msg={sender_id:currentUser.id,message:text,time_utc:new Date().toISOString(),linked:!!linkedMsg,linked_message:linkedMsg?linkedMsg.message:null,linked_message_time:linkedMsg?linkedMsg.time_utc:null,seen:false};
  const arr=JSON.parse(localStorage.getItem(storageKey))||[];
  arr.push({...msg,sender:"me",status:"sent"});
  localStorage.setItem(storageKey,JSON.stringify(arr));
  renderMessages();
  chatInput.value="";linkedMsg=null;replyBox.style.display="none";
  const {data}=await supabase.from('fwebaccount').select('fchat_messages').eq('id',chatUserId).maybeSingle();
  let recv=data?.fchat_messages?JSON.parse(data.fchat_messages):[];
  recv.push(msg);
  await supabase.from('fwebaccount').update({fchat_messages:JSON.stringify(recv)}).eq('id',chatUserId);
}

// -------- ONLINE/TYPING ----------
async function updateMyStatus(state){
  await supabase.from('fwebaccount').update({fchat_logs:state}).eq('id',currentUser.id);
}
async function checkPartnerStatus(){
  const {data}=await supabase.from('fwebaccount').select('fchat_logs').eq('id',chatUserId).maybeSingle();
  const val=data?.fchat_logs||"offline";
  if(val==="online"){banner.style.display="block";banner.textContent="This user is online";}
  else if(val==="typing"){banner.style.display="block";banner.textContent="Typing...";}
  else{banner.style.display="none";}
}
setInterval(checkPartnerStatus,2000);

chatInput.addEventListener('input',()=>{
  updateMyStatus(chatInput.value.trim()? "typing":"online");
});
window.addEventListener('blur',()=>updateMyStatus("offline"));
window.addEventListener('focus',()=>updateMyStatus("online"));

// -------- DETECTION ----------
async function detectIncoming(){
  const {data}=await supabase.from('fwebaccount').select('fchat_messages').eq('id',currentUser.id).maybeSingle();
  if(!data)return;
  const arr=Array.isArray(data.fchat_messages)?data.fchat_messages:JSON.parse(data.fchat_messages||"[]");
  const fromPartner=arr.filter(m=>String(m.sender_id)===String(chatUserId));
  if(fromPartner.length>0)console.log("New messages from",chatUserId,fromPartner);
}
setInterval(detectIncoming,2000);

// -------- HANDLERS ----------
function attachHandlers(div,obj,index){
  div.addEventListener('mousedown',e=>{
    longPressTimer=setTimeout(()=>{selectedMsg={index,obj};showMenu(div);},500);
  });
  window.addEventListener('mouseup',()=>{clearTimeout(longPressTimer);});
  div.addEventListener('touchstart',e=>{
    touchStartX=e.touches[0].clientX;touchMoved=false;
    longPressTimer=setTimeout(()=>{selectedMsg={index,obj};showMenu(div);},500);
  });
  div.addEventListener('touchmove',e=>{
    touchMoved=true;
    const diff=e.touches[0].clientX-touchStartX;
    if(diff>8)div.classList.add('swiping');
  });
  div.addEventListener('touchend',e=>{
    clearTimeout(longPressTimer);
    div.classList.remove('swiping');
    if(touchMoved){
      const delta=e.changedTouches[0].clientX-touchStartX;
      if(delta>50){
        linkedMsg=obj;
        replyText.textContent=obj.message.slice(0,80);
        replyBox.style.display='flex';
        chatInput.focus();
      }
    }
  });
  div.querySelectorAll('.linked-box').forEach(lb=>{
    lb.addEventListener('click',()=>{
      const target=document.querySelector(`.msg-time:contains("${lb.dataset.linkedTime}")`);
      if(target){target.scrollIntoView({behavior:"smooth",block:"center"});}
    });
  });
}

function showMenu(div){
  const r=div.getBoundingClientRect();
  menu.style.top=(r.top+window.scrollY+8)+'px';
  menu.style.left=(r.right+8)+'px';
  menu.style.display='flex';
}
function hideMenu(){menu.style.display='none';}
deleteBtn.onclick=async()=>{
  if(!selectedMsg)return hideMenu();
  const {index,obj}=selectedMsg;
  const msgs=JSON.parse(localStorage.getItem(storageKey))||[];
  if(obj.seen===false){
    const {data}=await supabase.from('fwebaccount').select('fchat_messages').eq('id',currentUser.id).maybeSingle();
    let arr=data?.fchat_messages?JSON.parse(data.fchat_messages):[];
    arr=arr.filter(m=>!(m.time_utc===obj.time_utc&&m.message===obj.message));
    await supabase.from('fwebaccount').update({fchat_messages:JSON.stringify(arr)}).eq('id',currentUser.id);
  }
  msgs.splice(index,1);
  localStorage.setItem(storageKey,JSON.stringify(msgs));
  renderMessages();hideMenu();
};

// -------- INIT ----------
window.onload=async()=>{await loadChatUser();renderMessages();updateMyStatus("online");detectIncoming();};
sendBtn.onclick=sendMessage;
chatInput.addEventListener('keypress',e=>{if(e.key==="Enter")sendMessage();});
closeReply.onclick=()=>{replyBox.style.display='none';linkedMsg=null;};
</script>
</body>
</html>
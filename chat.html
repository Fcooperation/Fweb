<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FCHAT - Chat</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: 'Poppins','Segoe UI',sans-serif;
    background: #fdfdfd;
    color: #111;
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  header {
    background: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 18px;
    border-bottom: 1px solid #eee;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .header-left {
    display: flex;
    align-items: center;
    cursor: pointer;
  }

  .chat-header-pic {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
    background: #ccc;
  }

  .chat-header-name {
    font-weight: 600;
    font-size: 18px;
  }

  #chat-board {
    flex: 1;
    background: #fafafa;
    overflow-y: auto;
    padding: 15px;
  }

  .message {
    background: #ececec;
    color: #000;
    padding: 10px 15px;
    border-radius: 14px;
    margin-bottom: 10px;
    max-width: 80%;
    position: relative;
    word-wrap: break-word;
  }

  .me { background: #c2ffc2; margin-left: auto; }

  #chat-input-area {
    display: flex;
    align-items: center;
    padding: 10px 8px;
    border-top: 1px solid #ddd;
    background: #fff;
    position: sticky;
    bottom: 0;
    z-index: 20;
  }

  #chat-input {
    flex: 1;
    border: 1px solid #ccc;
    border-radius: 25px;
    padding: 10px 15px;
    font-size: 15px;
    outline: none;
    background: #f7f7f7;
    transition: 0.2s;
  }

  #chat-input:focus { background: #fff; border-color: #999; }

  .icon-btn {
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    margin-left: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: 0.2s;
  }

  #emoji-btn { background: #ffcc00; color: #000; }
  #plus-btn { background: #00c851; color: #fff; }
  #send-btn { background: #007bff; color: #fff; }

  #emoji-picker {
    position: absolute;
    bottom: 70px;
    right: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    padding: 10px;
    display: none;
    flex-wrap: wrap;
    max-width: 260px;
    z-index: 10;
  }

  #emoji-picker span {
    font-size: 22px;
    cursor: pointer;
    margin: 5px;
    transition: 0.1s;
  }
  #emoji-picker span:hover { transform: scale(1.2); }

  .file-preview img, .file-preview video {
    max-width: 200px;
    border-radius: 10px;
    margin-top: 5px;
  }
  .file-preview a { color: #0066d6; text-decoration: none; }

  /* Popup Menu */
  #popup-menu {
    position: fixed;
    bottom: -200px;
    right: 15px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.25);
    width: 180px;
    padding: 10px 0;
    transition: bottom 0.3s ease;
    z-index: 29;
  }

  #popup-menu.show { bottom: 90px; }

  .popup-item {
    padding: 12px 16px;
    cursor: pointer;
    font-size: 15px;
    color: #222;
    display: flex;
    align-items: center;
    transition: 0.2s;
  }

  .popup-item:hover { background: #f5f5f5; }

  .popup-item span {
    margin-right: 10px;
    font-size: 20px;
  }

  /* Poll Modal */
  #poll-modal {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0;
    background: #fff;
    box-shadow: 0 -3px 10px rgba(0,0,0,0.2);
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    padding: 20px;
    transition: bottom 0.3s ease;
    z-index: 50;
  }
  #poll-modal.show { bottom: 0; }
  #poll-modal input, #poll-modal textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 10px;
    font-size: 15px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }
  #poll-modal button {
    width: 100%;
    padding: 10px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
  }
  #poll-modal label { display: flex; align-items: center; gap: 8px; }
</style>
</head>
<body>

<header>
  <div class="header-left" id="user-header">
    <img id="chat-pic" class="chat-header-pic" src="" alt="Profile">
    <div class="chat-header-name" id="chat-name">Loading...</div>
  </div>
</header>

<div id="chat-board"></div>
<div id="emoji-picker"></div>

<!-- Popup menu -->
<div id="popup-menu">
  <div class="popup-item" id="media-option"><span>ðŸŽ¥</span>Media</div>
  <div class="popup-item" id="doc-option"><span>ðŸ“„</span>Documents</div>
  <div class="popup-item" id="poll-option"><span>ðŸ“Š</span>Polls</div>
</div>

<!-- Poll Modal -->
<div id="poll-modal">
  <h3>Create Poll</h3>
  <input type="text" id="poll-question" placeholder="Enter question">
  <textarea id="poll-options" rows="3" placeholder="Enter options, separated by commas"></textarea>
  <label><input type="checkbox" id="poll-multi"> Allow multiple choices</label>
  <button id="create-poll-btn">Send Poll</button>
</div>

<div id="chat-input-area">
  <button id="emoji-btn" class="icon-btn">ðŸ˜Š</button>
  <button id="plus-btn" class="icon-btn">ï¼‹</button>
  <input type="text" id="chat-input" placeholder="Type a message...">
  <button id="send-btn" class="icon-btn">âž¤</button>
</div>
<!-- Only showing <script> part; rest of your HTML & CSS remain unchanged -->
<script type="module">
const chatBoard = document.getElementById('chat-board');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const emojiBtn = document.getElementById('emoji-btn');
const emojiPicker = document.getElementById('emoji-picker');
const plusBtn = document.getElementById('plus-btn');
const popupMenu = document.getElementById('popup-menu');
const pollModal = document.getElementById('poll-modal');
const pollQuestion = document.getElementById('poll-question');
const pollOptions = document.getElementById('poll-options');
const pollMulti = document.getElementById('poll-multi');
const createPollBtn = document.getElementById('create-poll-btn');

const chatUserId = localStorage.getItem('chatting');
const currentUser = JSON.parse(localStorage.getItem('faccount')) || { id: 'me' };
const storageKey = `chat_messages_${chatUserId}`;

// Emoji picker
const emojis = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ¥¹","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜","ðŸ˜‹","ðŸ˜˜","ðŸ˜œ","ðŸ¤©","ðŸ˜Ž","ðŸ¤”","ðŸ˜¢","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ‘Ž","â¤ï¸","ðŸ”¥","ðŸ’€"];
emojis.forEach(e => {
  const span = document.createElement("span");
  span.textContent = e;
  span.onclick = () => chatInput.value += e;
  emojiPicker.appendChild(span);
});
emojiBtn.addEventListener("click", () => {
  emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
});

// Render messages
function renderMessages() {
  chatBoard.innerHTML = "";
  const messages = JSON.parse(localStorage.getItem(storageKey)) || [];
  messages.forEach(msg => {
    const div = document.createElement("div");
    div.classList.add("message");

    if(msg.sender === currentUser.id) div.classList.add("me"); // green bubble
    else div.style.background = "#d2b48c"; // brown received

    // message type rendering
    if(msg.type === "text") div.textContent = msg.text;
    else if(msg.type === "image") div.innerHTML = `<div class="file-preview"><img src="${msg.url}"></div>`;
    else if(msg.type === "video") div.innerHTML = `<div class="file-preview"><video src="${msg.url}" controls></video></div>`;
    else if(msg.type === "doc") div.innerHTML = `<div class="file-preview"><a href="${msg.url}" download>ðŸ“„ Document</a></div>`;
    else if(msg.type === "poll") {
      const pollDiv = document.createElement("div");
      pollDiv.innerHTML = `<b>ðŸ“Š ${msg.question}</b>`;
      msg.options.forEach((o) => {
        const votes = msg.votes?.[o]?.length || 0;
        pollDiv.innerHTML += `<div>â€¢ ${o} (${votes})</div>`;
      });
      div.appendChild(pollDiv);
    }

    // append logs
    const logSpan = document.createElement("div");
    logSpan.style.fontSize = "10px";
    logSpan.style.marginTop = "2px";
    logSpan.style.opacity = "0.7";
    logSpan.textContent = `Sent: ${msg.logs.sent}, Seen: ${msg.logs.seen}, Read: ${msg.logs.read}`;
    div.appendChild(logSpan);

    chatBoard.appendChild(div);
  });
  chatBoard.scrollTop = chatBoard.scrollHeight;
}

// Save message locally
function saveMessage(msg) {
  const messages = JSON.parse(localStorage.getItem(storageKey)) || [];
  messages.push(msg);
  localStorage.setItem(storageKey, JSON.stringify(messages));
  renderMessages();
}

// Send message
function sendMessage() {
  const text = chatInput.value.trim();
  if(!text) return;
  const msg = {
    sender: currentUser.id,
    text,
    type: "text",
    time: new Date().toISOString(),
    logs: { sent: true, seen: false, read: false }
  };
  saveMessage(msg);
  chatInput.value = "";
}

// Poll
createPollBtn.onclick = () => {
  const question = pollQuestion.value.trim();
  const options = pollOptions.value.split(",").map(o => o.trim()).filter(Boolean);
  const allowMultiple = pollMulti.checked;
  if(!question || options.length<2) return alert("Enter valid poll details.");
  const msg = {
    sender: currentUser.id,
    type: "poll",
    question,
    options,
    allowMultiple,
    votes: {},
    time: new Date().toISOString(),
    logs: { sent:true, seen:false, read:false }
  };
  saveMessage(msg);
  pollQuestion.value = "";
  pollOptions.value = "";
  pollMulti.checked = false;
  pollModal.classList.remove("show");
};

// File handling
function handleFileSelect(type, file) {
  const reader = new FileReader();
  reader.onload = e => {
    const msg = { sender: currentUser.id, type, url: e.target.result, time: new Date().toISOString(), logs: {sent:true,seen:false,read:false} };
    saveMessage(msg);
  };
  reader.readAsDataURL(file);
}

// Popup buttons
plusBtn.addEventListener("click", () => popupMenu.classList.toggle("show"));
document.getElementById("media-option").onclick = () => {
  popupMenu.classList.remove("show");
  const input = document.createElement("input");
  input.type = "file"; input.accept="image/*,video/*";
  input.onchange = e => {
    const f = e.target.files[0];
    if(f.type.startsWith("image")) handleFileSelect("image", f);
    else handleFileSelect("video", f);
  };
  input.click();
};
document.getElementById("doc-option").onclick = () => {
  popupMenu.classList.remove("show");
  const input = document.createElement("input");
  input.type="file"; input.accept=".pdf,.doc,.docx,.zip,.txt";
  input.onchange = e => handleFileSelect("doc", e.target.files[0]);
  input.click();
};
document.getElementById("poll-option").onclick = () => {
  popupMenu.classList.remove("show");
  pollModal.classList.add("show");
};

// Send message
sendBtn.addEventListener("click", sendMessage);
chatInput.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

// Auto-refresh every 5 sec
setInterval(renderMessages, 5000);

// Load chat on visit
window.addEventListener("load", renderMessages);
</script>
</body>
</html>
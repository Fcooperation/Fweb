<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
/* ---------- RESET ---------- */
* { box-sizing: border-box; margin:0; padding:0; }

/* ---------- BODY ---------- */
body {
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: white;
}

/* ---------- TOP BAR ---------- */
#chat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
}

#chat-header img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background: black;
}

#chat-header .info {
  display: flex;
  flex-direction: column;
}

#chat-header .username {
  font-size: 16px;
  font-weight: bold;
}

#chat-header .status {
  font-size: 12px;
  color: #555;
}

/* ---------- CHAT BODY ---------- */
#chat-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ---------- MESSAGE BUBBLES ---------- */.message {
  max-width: 85%;          /* longer like WhatsApp */
  padding: 12px 18px;      /* bigger touch area */
  touch-action: pan-y;     /* allows horizontal swipe */
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  transition: transform 0.2s ease;
}


.sent {
  align-self: flex-end;
  background: black;
  color: white;
  border-bottom-right-radius: 4px;
}

.received {
  align-self: flex-start;
  background: #f1f1f1;
  color: black;
  border-bottom-left-radius: 4px;
}

.pending {
  opacity: 0.6;
}

/* ---------- INPUT BAR ---------- */
#chat-input {
  display: flex;
  gap: 10px;
  padding: 10px 16px;
  border-top: 1px solid #ddd;
}

#chat-input input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
}

#chat-input button {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  background: black;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- ---------- HEADER ---------- -->
<div id="chat-header">
  <img id="chat-pic" src="">
  <div class="info">
    <div class="username" id="chat-username">Loading...</div>
    <div class="status" id="chat-status">Status...</div>
  </div>
</div>

<!-- ---------- MESSAGES ---------- -->
<div id="chat-body"></div>

<!-- ---------- REPLY PREVIEW ---------- -->
<div id="reply-preview" style="display:none; padding:8px 16px; border-left:4px solid #007bff; background:#f1f1f1;">
  <div id="reply-sender" style="font-weight:bold; font-size:12px;"></div>
  <div id="reply-text" style="font-size:14px; color:#555;"></div>
</div>

<!-- ---------- INPUT ---------- -->
<div id="chat-input">
  <input type="text" id="message-input" placeholder="Type a messageâ€¦">
  <button id="send-btn">Send</button>
</div>

<script>
const API_URL = "https://fweb-backend.onrender.com/fchat";

/* ---------- LOAD CHAT TARGET ---------- */
const chatWith = JSON.parse(localStorage.getItem("chatting_with")) || null;
const account = JSON.parse(localStorage.getItem("faccount")) || {email:"", password:""};

if (!chatWith || !chatWith.id) {
  alert("No chat selected");
  window.location.href = "fchat.html";
}

/* ---------- HEADER DATA ---------- */
const header = document.getElementById("chat-header");
document.getElementById("chat-username").textContent = chatWith.username || "Unknown";
document.getElementById("chat-status").textContent = chatWith.status || "";
document.getElementById("chat-pic").src = chatWith.profile_pic || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9zdmc+";

/* ---------- HEADER CLICK TO DASHBOARD ---------- */
header.onclick = () => {
  localStorage.setItem("chat_viewing", JSON.stringify({
    id: chatWith.id,
    username: chatWith.username || "",
    profile_pic: chatWith.profile_pic || "",
    status: chatWith.status || ""
  }));
  window.location.href = "chatdashboard.html";
};

/* ---------- MESSAGE STORAGE ---------- */
const STORAGE_KEY = "chat_messages_" + chatWith.id;
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

/* ---------- RENDER MESSAGES ---------- */
function renderMessages() {
  const box = document.getElementById("chat-body");
  box.innerHTML = "";
  messages.forEach(msg => {
  const div = document.createElement("div");
  div.className = "message " + msg.type + (msg.status==="pending"?" pending":"");
  div.textContent = msg.text;

  // ðŸ”‘ link DOM to message data
  div.dataset.id = msg.id;

  box.appendChild(div);
});
  scrollToBottom();
}
let startX = 0;
let currentMsg = null;
let replyingMessage = null;

document.getElementById("chat-body").addEventListener("touchstart", e => {
  const msg = e.target.closest(".message");
  if (!msg) return;

  startX = e.touches[0].clientX;
  currentMsg = msg;
});

document.getElementById("chat-body").addEventListener("touchmove", e => {
  if (!currentMsg) return;

  const moveX = e.touches[0].clientX;
  const diffX = moveX - startX;

  // Move message slightly with finger
  if (diffX > 0 && diffX < 80) {
    currentMsg.style.transform = `translateX(${diffX}px)`;
  }
});

document.getElementById("chat-body").addEventListener("touchend", e => {
  if (!currentMsg) return;

  const endX = e.changedTouches[0].clientX;
  const diffX = endX - startX;

  // Reset position
  currentMsg.style.transform = "translateX(0)";

  if (diffX > 50) {
  const msgId = currentMsg.dataset.id;
  const msgData = messages.find(m => m.id == msgId);

  if (msgData) {
    replyingMessage = msgData;

    const senderName = msgData.type === "sent" ? "You" : chatWith.username;
    document.getElementById("reply-sender").textContent = senderName;
    document.getElementById("reply-text").textContent = msgData.text;

    document.getElementById("reply-preview").style.display = "block";
  }
}

  currentMsg = null;
});

/* ---------- SCROLL ---------- */
function scrollToBottom() {
  const box = document.getElementById("chat-body");
  box.scrollTop = box.scrollHeight;
}

/* ---------- SEND TO BACKEND ---------- */
async function sendToBackend(msgObj) {
  try {
    const payload = {
      action: "send_messages",
      email: account.email,
      id: msgObj.id,
      sender_id: account.email,
      receiver_id: chatWith.id,
      linked: false,
      linked_message_id: null,
      sent_at: new Date().toISOString(),
      text: msgObj.text
    };
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      msgObj.status = "sent";
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      renderMessages();
    }
  } catch(e) {
    console.warn("Failed to send, message pending");
    msgObj.status = "pending";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    renderMessages();
  }
}

/* ---------- SEND MESSAGE ---------- */
function sendMessage() {
  const input = document.getElementById("message-input");
  const text = input.value.trim();
  if(!text) return;

  const msgObj = {
    id: Date.now(), // unique message id
    type: "sent",
    text,
    status: navigator.onLine ? "sending" : "pending"
  };
  messages.push(msgObj);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  input.value = "";
  renderMessages();

  if(navigator.onLine){
    sendToBackend(msgObj);
  }
}

/* ---------- RETRY PENDING MESSAGES ---------- */
async function retryPending() {
  if(!navigator.onLine) return;
  for(const msg of messages){
    if(msg.status === "pending" || msg.status==="sending"){
      msg.status = "sending";
      await sendToBackend(msg);
    }
  }
}

window.addEventListener("online", retryPending);

/* ---------- INIT ---------- */
renderMessages();

document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").addEventListener("keydown", e => {
  if(e.key === "Enter") sendMessage();
});
</script>

</body>
</html>
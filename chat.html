<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>FCHAT - Chat</title>
<style>
*{box-sizing:border-box;}
body{
  font-family:'Poppins','Segoe UI',sans-serif;
  background:#fdfdfd;color:#111;margin:0;height:100vh;
  display:flex;flex-direction:column;
}
header{
  background:#fff;display:flex;flex-direction:column;align-items:flex-start;
  padding:12px 18px;border-bottom:1px solid #eee;box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.header-top{display:flex;justify-content:space-between;align-items:center;width:100%;}
.header-left{display:flex;align-items:center;}
.chat-header-pic{width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:10px;background:#ccc;}
.chat-header-name{font-weight:600;font-size:18px;cursor:pointer;}
#chat-status{font-size:12px;color:#555;margin-top:3px;}
#chat-board{flex:1;background:#fafafa;overflow-y:auto;padding:15px;display:flex;flex-direction:column;}
.message{
  background:#ececec;color:#000;padding:10px 15px;border-radius:14px;
  margin-bottom:10px;max-width:75%;word-wrap:break-word;position:relative;
  align-self:flex-start;cursor:pointer;transition:background 0.2s, transform 0.2s;
}
.message.me{background:#c2ffc2;align-self:flex-end;}
.message:hover{background:#e4e4e4;}
.msg-time{display:block;text-align:right;font-size:11px;color:#555;margin-top:3px;}
.linked-box{background:rgba(0,0,0,0.05);border-left:3px solid #007bff;
  padding:5px 8px;border-radius:5px;font-size:13px;margin-bottom:5px;cursor:pointer;}
#reply-box{
  background:#f1f1f1;padding:6px 12px;font-size:13px;border-left:3px solid #007bff;
  display:none;align-items:center;justify-content:space-between;
}
#reply-box span{flex:1;}
#reply-box button{background:transparent;border:none;font-size:18px;cursor:pointer;}
#chat-input-area{
  display:flex;flex-direction:column;border-top:1px solid #ddd;
  background:#fff;position:sticky;bottom:0;
}
#chat-input-row{display:flex;align-items:center;padding:10px 14px;}
#chat-input{
  flex:1;border:1px solid #ccc;border-radius:25px;padding:10px 15px;
  font-size:15px;outline:none;background:#f7f7f7;transition:0.2s;
}
#chat-input:focus{background:#fff;border-color:#999;}
#send-btn{
  background:#007bff;border:none;color:#fff;font-size:20px;border-radius:50%;
  width:42px;height:42px;margin-left:8px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
#send-btn:hover{background:#0066d6;}
#loading{text-align:center;padding:20px;color:#777;}
.context-menu{
  position:absolute;background:#fff;border:1px solid #ccc;
  box-shadow:0 2px 8px rgba(0,0,0,0.15);border-radius:6px;
  z-index:1000;display:none;flex-direction:column;min-width:100px;
}
.context-menu button{
  background:none;border:none;text-align:left;padding:8px 12px;
  width:100%;cursor:pointer;font-size:14px;
}
.context-menu button:hover{background:#eee;}
</style>
</head>
<body>
<header>
  <div class="header-top" id="chat-header">
    <div class="header-left">
      <img id="chat-pic" class="chat-header-pic" src="" alt="Profile">
      <div class="chat-header-name" id="chat-name">Loading...</div>
    </div>
  </div>
  <div id="chat-status">Initializing...</div>
</header>

<div id="chat-board"><div id="loading">Loading chat...</div></div>

<div id="chat-input-area">
  <div id="reply-box"><span></span><button id="close-reply">×</button></div>
  <div id="chat-input-row">
    <input type="text" id="chat-input" placeholder="Type a message...">
    <button id="send-btn">➤</button>
  </div>
</div>

<div id="menu" class="context-menu">
  <button id="delete-msg">Delete</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://pwsxezhugsxosbwhkdvf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

const chatBoard = document.getElementById('chat-board');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const chatName = document.getElementById('chat-name');
const chatPic = document.getElementById('chat-pic');
const replyBox = document.getElementById('reply-box');
const replyText = replyBox.querySelector('span');
const closeReply = document.getElementById('close-reply');
const chatStatus = document.getElementById('chat-status');

const chatUserId = localStorage.getItem('chatting');
const currentUser = JSON.parse(localStorage.getItem('faccount'));
let lastMessages = [];

if(!currentUser || !chatUserId){
  chatStatus.textContent = "Error: Missing chat info!";
  throw new Error("Missing localStorage data");
}

document.getElementById('chat-header').addEventListener('click',()=>{
  localStorage.setItem('chat_viewing', chatUserId);
  window.location.href = "chat_dashboard.html";
});

async function loadChatUser(){
  chatStatus.textContent = "Accessing Supabase account...";
  try{
    const {data,error} = await supabase.from('fwebaccount').select('*').eq('id',chatUserId).maybeSingle();
    if(error) throw error;
    if(!data) throw new Error("User not found");
    chatName.textContent = data.username || "Unknown User";
    chatPic.src = data.profile_pic || "https://via.placeholder.com/50?text=U";
    chatStatus.textContent = "Supabase account accessed.";
  }catch(err){
    chatName.textContent="User not found";
    chatStatus.textContent = "Failed to access user.";
    console.error(err);
  }
}

function formatTime(t){
  const d = new Date(t), n = new Date();
  const same = d.toDateString() === n.toDateString();
  return same ? d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+" UTC" :
                d.toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})+" UTC";
}

function renderMessages(msgs){
  chatBoard.innerHTML = "";
  if(!msgs || msgs.length===0){ 
    chatBoard.innerHTML="<div id='loading'>No messages yet.</div>"; 
    return; 
  }
  msgs.forEach((m)=>{
    const div = document.createElement("div");
    div.classList.add("message");
    if(m.sender_id===currentUser.id) div.classList.add("me");
    if(m.linked) div.innerHTML = `<div class="linked-box" data-linked-time="${m.linked_message_time}">${m.linked_message}</div>`;
    div.innerHTML += `<div>${m.message}</div><span class="msg-time">${formatTime(m.time_utc)}</span>`;
    chatBoard.appendChild(div);
  });
  chatBoard.scrollTop = chatBoard.scrollHeight;
}

async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  const msgData = {
    sender_id: currentUser.id,
    message: text,
    time_utc: new Date().toISOString(),
    linked: replyText.textContent ? true : false,
    linked_message: replyText.textContent || null,
    linked_message_time: replyBox.dataset.linkedTime || null,
    seen:false
  };

  chatInput.value="";
  replyText.textContent=""; replyBox.style.display="none";

  try{
    const {data,error} = await supabase.from('fwebaccount').select('fchat_messages').eq('id',chatUserId).maybeSingle();
    if(error) throw error;
    let msgs = [];
    if(data?.fchat_messages){
      msgs = Array.isArray(data.fchat_messages) ? data.fchat_messages : JSON.parse(data.fchat_messages);
    }
    msgs.push(msgData);
    await supabase.from('fwebaccount').update({fchat_messages: JSON.stringify(msgs)}).eq('id',chatUserId);
    lastMessages = msgs;
    renderMessages(msgs);
  }catch(e){console.error("Send failed:",e);}
}

async function receiveMessages(){
  try{
    const {data,error} = await supabase.from('fwebaccount').select('fchat_messages').eq('id',chatUserId).maybeSingle();
    if(error) throw error;
    let msgs = [];
    if(data?.fchat_messages){
      msgs = Array.isArray(data.fchat_messages) ? data.fchat_messages : JSON.parse(data.fchat_messages);
    }
    if(JSON.stringify(msgs) !== JSON.stringify(lastMessages)){
      lastMessages = msgs;
      renderMessages(msgs);
      chatStatus.textContent = "New messages found";
    } else {
      chatStatus.textContent = "No new messages";
    }
  }catch(err){
    console.error(err);
    chatStatus.textContent = "Error fetching messages";
  }
}

sendBtn.addEventListener("click",sendMessage);
chatInput.addEventListener("keypress",e=>{if(e.key==="Enter") sendMessage();});

window.addEventListener("load",async()=>{
  await loadChatUser();
  await receiveMessages();
  setInterval(receiveMessages,1000);
});
</script>
</body>
</html>

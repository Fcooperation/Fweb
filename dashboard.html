<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f7fa; text-align: center; }
    .profile-section { width: 100%; height: 300px; background: #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .profile-section img { width: 100%; height: 100%; object-fit: cover; }
    .upload-box { margin: 15px auto; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .upload-box input { padding: 6px; }
    .upload-box button { padding: 8px 14px; background: #007bff; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    h2 { margin: 20px 0; font-size: 28px; font-weight: bold; color: #007bff; text-transform: uppercase; }
    .details-section { margin: 30px auto; padding: 20px; max-width: 400px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: left; }
    .details-section h3 { margin-bottom: 15px; }
    .details-section input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .details-section button { width: 100%; padding: 10px; background: #007bff; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .details-section button:hover { background: #0056b3; }
    body.dark-mode, html.dark-mode { background: #111; color: #f5f5f5; }
    body.dark-mode * { background: inherit !important; color: inherit !important; }
    #fchat-btn { display: block; width: 100%; padding: 15px 0; background-color: black; color: white; font-size: 18px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 20px; }
    #fchat-btn:hover { background-color: #222; }
  </style>
</head>
<body>
  <div class="profile-section">
    <img id="profile-pic" src="default.png" alt="Profile Picture">
  </div>

  <div class="upload-box">
    <input type="file" id="file-input" accept="image/*">
    <button onclick="uploadImage()">Upload</button>
  </div>

  <h2 id="username">Loading...</h2>

  <div class="details-section">
    <h3>Update Account Details</h3>
    <input type="text" id="new-name" placeholder="New Username">
    <input type="password" id="new-pass" placeholder="New Password">
    <button onclick="updateDetails()">Save Changes</button>
  </div>

  <div class="details-section" style="margin-top: 15px;">
    <button id="logout-btn" style="background:#dc3545;">Logout</button>
    <button id="delete-btn" style="background:#6c757d; margin-top:10px;">Delete Account</button>
  </div>

  <script>
    const faccount = JSON.parse(localStorage.getItem("faccount"));
    if (!faccount) {
      alert("No account found. Please log in again.");
      window.location.href = "login.html";
    } else {
      document.getElementById("username").innerText = faccount.username || "No Username";
      if (faccount.profile_pic) document.getElementById("profile-pic").src = faccount.profile_pic;
    }

    async function callFWebBackend(action, data = {}) {
      const payload = { action, email: faccount.email, password: faccount.password_hash, ...data };
      try {
        const res = await fetch("https://fweb-backend.onrender.com/fchat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        return await res.json();
      } catch (err) {
        console.error("Backend request failed:", err);
        return { error: "Backend request failed" };
      }
    }

    // --- Compress image ---
    async function compressImage(file, maxWidth = 800, quality = 0.6) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.onerror = reject;
        reader.readAsDataURL(file);
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const scale = Math.min(1, maxWidth / img.width);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => {
            const fr = new FileReader();
            fr.onload = e => resolve(e.target.result);
            fr.onerror = reject;
            fr.readAsDataURL(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = reject;
      });
    }

    async function uploadImage() {
      const fileInput = document.getElementById("file-input");
      if (!fileInput.files.length) return alert("Select an image first.");
      const file = fileInput.files[0];
      try {
        const base64 = await compressImage(file, 800, 0.6);
        const result = await callFWebBackend("update_pic", { profile_pic: base64 });
        if (result.error) return alert("Error: " + result.error);
        if (result.success) {
          faccount.profile_pic = base64;
          localStorage.setItem("faccount", JSON.stringify(faccount));
          document.getElementById("profile-pic").src = base64;
          alert(result.message || "Profile picture updated!");
        } else {
          alert(result.message || "Failed to update profile picture.");
        }
      } catch(err) {
        console.error("Image compression/upload failed:", err);
        alert("Failed to compress or upload image.");
      }
    }

    async function updateDetails() {
      const newName = document.getElementById("new-name").value;
      const newPass = document.getElementById("new-pass").value;
      if (!newName && !newPass) return alert("Enter details to update.");
      const result = await callFWebBackend("update_details", { username: newName, password_hash: newPass });
      if (result.error) return alert("Error: " + result.error);
      if (result.success) {
        if (newName) { faccount.username = newName; document.getElementById("username").innerText = newName; }
        if (newPass) faccount.password_hash = newPass;
        localStorage.setItem("faccount", JSON.stringify(faccount));
        alert(result.message || "Account details updated!");
      } else {
        alert(result.message || "Failed to update account.");
      }
    }

    document.getElementById("logout-btn").addEventListener("click", () => {
      localStorage.removeItem("faccount");
      alert("Logged out successfully!");
      window.location.href = "login.html";
    });

    document.getElementById("delete-btn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete your account?")) return;
      const result = await callFWebBackend("delete_account");
      if (result.error) return alert("Error: " + result.error);
      if (result.success) {
        localStorage.removeItem("faccount");
        alert(result.message || "Account deleted successfully.");
        window.location.href = "signup.html";
      } else {
        alert(result.message || "Failed to delete account.");
      }
    });

    // --- Verify account every 5 seconds ---
    async function verifyAccount() {

  // If offline → skip silently
  if (!navigator.onLine) {
    console.log("Offline: skipping account verification.");
    return;
  }

  const result = await callFWebBackend("verify_account");

  // If server unreachable → skip
  if (!result || result.error) {
    console.log("Server not reachable: skipping verification.");
    return;
  }

  // If account truly doesn't exist → logout
  if (!result.exists) {
    alert("Account not found. Please re-login.");
    localStorage.removeItem("faccount");
    window.location.href = "login.html";
  }
}
    verifyAccount();
    setInterval(verifyAccount, 5000);

    // --- Fchat button using localStorage ---
    const fchatBtn = document.getElementById("fchat-btn");
    fchatBtn.addEventListener("click", () => {
      if (faccount.fchat && faccount.fchat.toLowerCase() === "yes") {
        window.location.href = "fchat.html";
      } else {
        window.location.href = "welcometofchat.html";
      }
    });

    window.uploadImage = uploadImage;
    window.updateDetails = updateDetails;
  </script>

  <script>
    // Add navigation buttons dynamically
    const lastSection = document.querySelectorAll('.details-section');
    if (lastSection.length) {
      const container = document.createElement('div');
      container.className = 'details-section';
      container.style.marginTop = '15px';
      const buttons = [
        { text: 'Fminers', href: 'fminers.html', color: '#28a745' },
        { text: 'Fpublisher', href: 'fpublisher.html', color: '#17a2b8' },
        { text: 'Fadvertisers', href: 'fadvertisers.html', color: '#ffc107' }
      ];
      buttons.forEach(btn => {
        const b = document.createElement('button');
        b.innerText = btn.text;
        b.style.background = btn.color;
        b.style.border = 'none';
        b.style.color = '#fff';
        b.style.padding = '10px';
        b.style.width = '100%';
        b.style.borderRadius = '6px';
        b.style.cursor = 'pointer';
        b.style.marginBottom = '10px';
        b.onclick = () => window.location.href = btn.href;
        container.appendChild(b);
      });
      lastSection[lastSection.length - 1].after(container);
    }
  </script>

  <button id="fchat-btn">Go to Fchat</button>
</body>
</html>